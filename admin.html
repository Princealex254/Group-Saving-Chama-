<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Prince Alex Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-maroon: #800000;
            --secondary-white: #ffffff;
            --maroon-light: #a00000;
            --maroon-dark: #600000;
            --gradient-maroon: linear-gradient(135deg, #800000 0%, #a00000 100%);
            --gradient-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --shadow-soft: 0 10px 25px rgba(128, 0, 0, 0.1);
            --shadow-hover: 0 20px 40px rgba(128, 0, 0, 0.15);
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gradient-bg);
            line-height: 1.6;
            color: #2d3748;
        }
        
        .btn-primary {
            background: var(--gradient-maroon);
            color: var(--secondary-white);
            padding: 0.875rem 2rem;
            border-radius: var(--border-radius-sm);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-maroon);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .message-box.show {
            transform: translateX(0);
        }
        
        .message-box.success {
            background-color: #10b981;
        }
        
        .message-box.error {
            background-color: #ef4444;
        }
        
        .message-box.info {
            background-color: #3b82f6;
        }
        
        .table-container {
            background: white;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--gradient-maroon);
            color: white;
            padding: 1rem;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
        
        .admin-nav-item {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            margin: 0.25rem;
            border-radius: var(--border-radius-sm);
            color: #374151;
            background: #f8f9fa;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .admin-nav-item:hover {
            background: #e9ecef;
            color: var(--primary-maroon);
            border-color: var(--primary-maroon);
        }
        
        .admin-nav-item.active {
            background: var(--gradient-maroon);
            color: white;
            border-color: var(--primary-maroon);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg text-center">
            <div class="loading-spinner"></div>
            <p class="mt-4 text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box">
        <span id="message-box-content"></span>
        <button onclick="hideMessage()" class="ml-4 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
            <div class="bg-white rounded-lg shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-red-600 to-red-800 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shield-alt text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Admin Login</h1>
                    <p class="text-gray-600 mt-2">Prince Alex Digital Admin Panel</p>
                </div>
                
                <form id="admin-login-form">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="admin-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-red-500" required>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-red-500" required>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <div class="container mx-auto p-6">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <div class="flex-1">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Admin Dashboard</h1>
                        <p class="text-gray-600 mt-1">Manage Prince Alex Digital Group Saving Chama</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600 hidden md:block">Welcome, <span id="admin-name" class="font-semibold text-red-600"></span></span>
                        <span class="text-gray-600 md:hidden"><span id="admin-name-mobile" class="font-semibold text-red-600"></span></span>
                        <button onclick="logout()" class="btn-primary">
                            <i class="fas fa-sign-out-alt mr-2"></i><span class="hidden md:inline">Logout</span><span class="md:hidden">Exit</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Management Sections</h3>
                    <button id="admin-hamburger-menu" class="md:hidden text-gray-600 hover:text-gray-800 focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
                <div id="admin-nav-tabs" class="flex flex-wrap gap-2">
                    <button class="admin-nav-item active" onclick="showSection('overview')">
                        <i class="fas fa-chart-pie mr-2"></i>Overview
                    </button>
                    <button class="admin-nav-item" onclick="showSection('customers')">
                        <i class="fas fa-users mr-2"></i>Customers
                    </button>
                    <button class="admin-nav-item" onclick="showSection('contributions')">
                        <i class="fas fa-money-bill-wave mr-2"></i>Contributions
                    </button>
                    <button class="admin-nav-item" onclick="showSection('loans')">
                        <i class="fas fa-hand-holding-usd mr-2"></i>Loans
                    </button>
                    <button class="admin-nav-item" onclick="showSection('meetings')">
                        <i class="fas fa-calendar-alt mr-2"></i>Meetings
                    </button>
                    <button class="admin-nav-item" onclick="showSection('fines')">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Fines
                    </button>
                    <button class="admin-nav-item" onclick="showSection('investments')">
                        <i class="fas fa-chart-line mr-2"></i>Investments
                    </button>
                    <button class="admin-nav-item" onclick="showSection('attendance')">
                        <i class="fas fa-user-check mr-2"></i>Attendance
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div id="admin-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        var __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC8-TWRr_vOMTv72scXxu-9l5uVHRVputo",
            authDomain: "group-saving-chama.firebaseapp.com",
            projectId: "group-saving-chama",
            storageBucket: "group-saving-chama.appspot.com",
            messagingSenderId: "570981365925",
            appId: "1:570981365925:web:42422e51e4e02c6ab4f54c"
        });
        var __app_id = "group-saving-chama";
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase initialization
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = __app_id;

        let currentAdmin = null;
        let currentSection = 'overview';

        // Helper functions - Using direct Firestore collections
        function getPublicCollectionPath(collectionName) {
            return collectionName; // Direct collection name
        }

        function showMessage(message, type = 'success') {
            const msgBox = document.getElementById('message-box');
            const msgBoxContent = document.getElementById('message-box-content');
            msgBoxContent.textContent = message;
            msgBox.className = `message-box ${type}`;
            msgBox.classList.add('show');
            setTimeout(() => msgBox.classList.remove('show'), 5000);
        }

        function hideMessage() {
            document.getElementById('message-box').classList.remove('show');
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Admin authentication
        async function checkAdminStatus(userId) {
            try {
                const adminRef = doc(db, 'admins', userId);
                const adminSnap = await getDoc(adminRef);
                return adminSnap.exists() && adminSnap.data().admin === true;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Login function
        async function loginAdmin(email, password) {
            try {
                showLoading();
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                
                const isAdmin = await checkAdminStatus(userId);
                if (!isAdmin) {
                    await signOut(auth);
                    showMessage('Access denied. Admin privileges required.', 'error');
                    return;
                }

                currentAdmin = userCredential.user;
                document.getElementById('admin-name').textContent = userCredential.user.email;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                showMessage('Welcome to Admin Panel!', 'success');
                loadOverview();
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Logout function
        async function logout() {
            try {
                await signOut(auth);
                currentAdmin = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
                showMessage('Logged out successfully', 'info');
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Logout failed', 'error');
            }
        }

        // Section navigation
        function showSection(section) {
            currentSection = section;
            
            // Update active nav item
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const clickedButton = document.querySelector(`[onclick="showSection('${section}')"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            // Load section content
            switch(section) {
                case 'overview':
                    loadOverview();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'contributions':
                    loadContributions();
                    break;
                case 'loans':
                    loadLoans();
                    break;
                case 'meetings':
                    loadMeetings();
                    break;
                case 'fines':
                    loadFines();
                    break;
                case 'investments':
                    loadInvestments();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
            }
        }

        // Data loading functions
        async function loadOverview() {
            showLoading();
            try {
                const [customersSnap, contributionsSnap, loansSnap, meetingsSnap] = await Promise.all([
                    getDocs(collection(db, getPublicCollectionPath('customers'))),
                    getDocs(collection(db, getPublicCollectionPath('contributions'))),
                    getDocs(collection(db, getPublicCollectionPath('loans'))),
                    getDocs(collection(db, getPublicCollectionPath('meetings')))
                ]);

                const totalCustomers = customersSnap.size;
                const totalContributions = contributionsSnap.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
                const totalLoans = loansSnap.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
                const totalMeetings = meetingsSnap.size;

                document.getElementById('admin-content').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-users text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Customers</p>
                                    <p class="text-2xl font-semibold text-gray-900">${totalCustomers}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-money-bill-wave text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Contributions</p>
                                    <p class="text-2xl font-semibold text-gray-900">KSh ${totalContributions.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-hand-holding-usd text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Loans</p>
                                    <p class="text-2xl font-semibold text-gray-900">KSh ${totalLoans.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                    <i class="fas fa-calendar-alt text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Meetings</p>
                                    <p class="text-2xl font-semibold text-gray-900">${totalMeetings}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h3>
                        <div class="space-y-4">
                            <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                                <i class="fas fa-user-plus text-blue-600 mr-3"></i>
                                <div>
                                    <p class="font-medium">New customer registrations</p>
                                    <p class="text-sm text-gray-600">${totalCustomers} total customers registered</p>
                                </div>
                            </div>
                            <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                                <i class="fas fa-chart-line text-green-600 mr-3"></i>
                                <div>
                                    <p class="font-medium">Financial Summary</p>
                                    <p class="text-sm text-gray-600">KSh ${totalContributions.toLocaleString()} in contributions, KSh ${totalLoans.toLocaleString()} in loans</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading overview:', error);
                showMessage('Error loading overview data', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadCustomers() {
            showLoading();
            try {
                const customersSnap = await getDocs(collection(db, getPublicCollectionPath('customers')));
                
                if (customersSnap.empty) {
                    document.getElementById('admin-content').innerHTML = `
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="text-lg font-semibold">Customers Management</h3>
                            </div>
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Customers Found</h3>
                                <p class="text-gray-500">No customers have registered yet.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const customers = customersSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                document.getElementById('admin-content').innerHTML = `
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="text-lg font-semibold">Customers Management (${customers.length})</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${customers.map(customer => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.email || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.phone || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${customer.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${customer.status || 'pending'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${customer.createdAt ? new Date(customer.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="updateCustomerStatus('${customer.id}', '${customer.status === 'approved' ? 'pending' : 'approved'}')" 
                                                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                                                    ${customer.status === 'approved' ? 'Suspend' : 'Approve'}
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading customers:', error);
                showMessage('Error loading customers data', 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateCustomerStatus(customerId, newStatus) {
            try {
                showLoading();
                const customerRef = doc(db, getPublicCollectionPath('customers'), customerId);
                await updateDoc(customerRef, { status: newStatus });
                showMessage(`Customer ${newStatus === 'approved' ? 'approved' : 'suspended'} successfully`, 'success');
                loadCustomers(); // Reload the table
            } catch (error) {
                console.error('Error updating customer status:', error);
                showMessage('Error updating customer status', 'error');
            } finally {
                hideLoading();
            }
        }

        // Similar functions for other sections...
        async function loadContributions() {
            showLoading();
            try {
                const contributionsSnap = await getDocs(collection(db, getPublicCollectionPath('contributions')));
                
                if (contributionsSnap.empty) {
                    document.getElementById('admin-content').innerHTML = `
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="text-lg font-semibold">Contributions Management</h3>
                            </div>
                            <div class="empty-state">
                                <i class="fas fa-money-bill-wave"></i>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Contributions Found</h3>
                                <p class="text-gray-500">No contributions have been made yet.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const contributions = contributionsSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                document.getElementById('admin-content').innerHTML = `
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="text-lg font-semibold">Contributions Management (${contributions.length})</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${contributions.map(contribution => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${contribution.userName || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">KSh ${(contribution.amount || 0).toLocaleString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${contribution.date ? new Date(contribution.date.seconds * 1000).toLocaleDateString() : 'N/A'}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    ${contribution.status || 'completed'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading contributions:', error);
                showMessage('Error loading contributions data', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadLoans() {
            showLoading();
            try {
                const loansSnap = await getDocs(collection(db, getPublicCollectionPath('loans')));
                
                if (loansSnap.empty) {
                    document.getElementById('admin-content').innerHTML = `
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="text-lg font-semibold">Loans Management</h3>
                            </div>
                            <div class="empty-state">
                                <i class="fas fa-hand-holding-usd"></i>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Loans Found</h3>
                                <p class="text-gray-500">No loan applications have been submitted yet.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const loans = loansSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                document.getElementById('admin-content').innerHTML = `
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="text-lg font-semibold">Loans Management (${loans.length})</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purpose</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applied</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${loans.map(loan => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${loan.userName || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">KSh ${(loan.amount || 0).toLocaleString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${loan.purpose || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${loan.status === 'approved' ? 'bg-green-100 text-green-800' : loan.status === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${loan.status || 'pending'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                ${loan.timestamp ? new Date(loan.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                ${loan.status === 'pending' ? `
                                                    <button onclick="updateLoanStatus('${loan.id}', 'approved')" class="text-green-600 hover:text-green-900 mr-3">Approve</button>
                                                    <button onclick="updateLoanStatus('${loan.id}', 'rejected')" class="text-red-600 hover:text-red-900">Reject</button>
                                                ` : 'No actions available'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading loans:', error);
                showMessage('Error loading loans data', 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateLoanStatus(loanId, newStatus) {
            try {
                showLoading();
                const loanRef = doc(db, getPublicCollectionPath('loans'), loanId);
                await updateDoc(loanRef, { status: newStatus });
                showMessage(`Loan ${newStatus} successfully`, 'success');
                loadLoans(); // Reload the table
            } catch (error) {
                console.error('Error updating loan status:', error);
                showMessage('Error updating loan status', 'error');
            } finally {
                hideLoading();
            }
        }

        // Placeholder functions for other sections
        async function loadMeetings() {
            document.getElementById('admin-content').innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="text-lg font-semibold">Meetings Management</h3>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Meetings Management</h3>
                        <p class="text-gray-500">Meeting management functionality coming soon.</p>
                    </div>
                </div>
            `;
        }

        async function loadFines() {
            document.getElementById('admin-content').innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="text-lg font-semibold">Fines Management</h3>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Fines Management</h3>
                        <p class="text-gray-500">Fines management functionality coming soon.</p>
                    </div>
                </div>
            `;
        }

        async function loadInvestments() {
            document.getElementById('admin-content').innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="text-lg font-semibold">Investments Management</h3>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Investments Management</h3>
                        <p class="text-gray-500">Investments management functionality coming soon.</p>
                    </div>
                </div>
            `;
        }

        async function loadAttendance() {
            document.getElementById('admin-content').innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="text-lg font-semibold">Attendance Management</h3>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-user-check"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Attendance Management</h3>
                        <p class="text-gray-500">Attendance management functionality coming soon.</p>
                    </div>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            await loginAdmin(email, password);
        });

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const isAdmin = await checkAdminStatus(user.uid);
                if (isAdmin) {
                    currentAdmin = user;
                    document.getElementById('admin-name').textContent = user.email;
                    document.getElementById('admin-name-mobile').textContent = user.email;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    loadOverview();
                } else {
                    await signOut(auth);
                }
            } else {
                currentAdmin = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        });

        // Admin Mobile Menu Toggle Function
        function toggleAdminMobileMenu() {
            const navTabs = document.getElementById('admin-nav-tabs');
            const hamburgerButton = document.getElementById('admin-hamburger-menu');
            
            if (navTabs && hamburgerButton) {
                if (navTabs.classList.contains('hidden')) {
                    navTabs.classList.remove('hidden');
                    hamburgerButton.innerHTML = '<i class="fas fa-times text-xl"></i>';
                } else {
                    navTabs.classList.add('hidden');
                    hamburgerButton.innerHTML = '<i class="fas fa-bars text-xl"></i>';
                }
            }
        }

        // Initialize admin mobile menu event listener
        document.addEventListener('DOMContentLoaded', function() {
            const hamburgerButton = document.getElementById('admin-hamburger-menu');
            if (hamburgerButton) {
                hamburgerButton.addEventListener('click', toggleAdminMobileMenu);
            }
            
            // Hide nav tabs on mobile by default
            const navTabs = document.getElementById('admin-nav-tabs');
            if (navTabs && window.innerWidth < 768) {
                navTabs.classList.add('hidden');
            }
        });

        // Make functions global
        window.logout = logout;
        window.showSection = showSection;
        window.toggleAdminMobileMenu = toggleAdminMobileMenu;
        window.updateCustomerStatus = updateCustomerStatus;
        window.updateLoanStatus = updateLoanStatus;
        window.hideMessage = hideMessage;
    </script>
</body>
</html>
