<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Digital - Chama Admin Dashboard</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        // IMPORT_FIX: Added collectionGroup for fetching data across subcollections
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp, query, where, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

        // Chart.js for graphs
        // Moved inside the script type="module" block for better scope management
        // although it's generally fine as a global script.
        // For larger apps, consider importing Chart.js via a module bundler.
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <style>
        /* General Styles and Branding */
        :root {
            --maroon: #800000;
            --white: #ffffff;
            --light-gray: #f4f4f4;
            --dark-gray: #333;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        header {
            background-color: var(--maroon);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header-brand h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--dark-gray);
            color: var(--white);
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li a {
            display: block;
            padding: 15px 20px;
            color: var(--white);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--maroon);
        }
        
        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            transition: margin-left 0.3s;
        }

        h2 {
            color: var(--maroon);
            border-bottom: 2px solid var(--maroon);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: var(--maroon);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #a00000;
        }
        
        /* Forms and Inputs */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea { /* Added textarea for consistency */
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* Ensures padding doesn't increase width */
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--white);
        }

        .data-table th, .data-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: var(--maroon);
            color: var(--white);
            cursor: pointer;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--dark-gray);
            color: var(--white);
            position: sticky;
            bottom: 0;
        }
        
        /* Mobile Styles */
        .hamburger {
            display: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--white);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                position: fixed;
                width: 100%;
                height: 100%;
                z-index: 999;
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            header {
                flex-direction: row-reverse;
            }
            .hamburger {
                display: block;
            }
        }
    </style>
</head>
<body>

    <div id="login-page">
        <header>
            <div class="header-brand">
                <h1>Prince Alex Digital</h1>
                <p>Chama Admin Login</p>
            </div>
            <p id="connection-status" style="color: yellow; font-weight: bold;"></p> </header>
        <div style="max-width: 400px; margin: 50px auto; padding: 20px; background: #fff; border-radius: 8px;">
            <h2>Admin Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="login-error" style="color: red; margin-top: 10px;"></p>
            </form>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        <header>
            <div class="header-brand">
                <h1>Prince Alex Digital</h1>
                <p>Chama Admin Dashboard</p>
            </div>
            <p id="dashboard-connection-status" style="color: yellow; font-weight: bold; margin-left: auto;"></p> <button id="logout-btn" class="btn">Logout</button> <div class="hamburger">&#9776;</div>
        </header>

        <div class="container">
            <nav class="sidebar">
                <ul>
                    <li><a href="#" data-section="dashboard-overview" class="active">Dashboard Overview</a></li>
                    <li><a href="#" data-section="members-management">Members Management</a></li>
                    <li><a href="#" data-section="contributions-management">Contributions Management</a></li>
                    <li><a href="#" data-section="loan-management">Loan Management</a></li>
                    <li><a href="#" data-section="meetings-notices">Meetings & Notices</a></li>
                    <li><a href="#" data-section="fines-penalties">Fines & Penalties</a></li>
                    <li><a href="#" data-section="investments">Investments</a></li>
                    <li><a href="#" data-section="voting-polls">Voting & Polls</a></li>
                    <li><a href="#" data-section="documents-management">Documents Management</a></li>
                    <li><a href="#" data-section="attendance">Attendance</a></li>
                    <li><a href="#" data-section="notifications">Notifications</a></li>
                    <li><a href="#" data-section="reports">Reports</a></li>
                </ul>
            </nav>

            <main class="main-content" id="content-container">
                </main>
        </div>

        <footer>
            <p>&copy; 2025 Prince Alex Digital. All rights reserved.</p>
        </footer>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3>Confirm Action</h3>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <button id="modal-confirm-btn" class="btn btn-primary">Yes</button>
            <button type="button" class="btn" id="modal-cancel-btn">No</button>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        // IMPORT_UPDATE: Added browserLocalPersistence and setPersistence
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        // IMPORT_FIX: Added collectionGroup for fetching data across subcollections
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp, query, where, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
        // Chart.js is already loaded as a global script, no need to import here.

        // YOUR FIREBASE CONFIGURATION (LEFT UNTOUCHED AS REQUESTED)
        const firebaseConfig = {
            apiKey: "AIzaSyC8-TWRr_vOMTv72scXxu-9l5uVHRVputo",
            authDomain: "group-saving-chama.firebaseapp.com",
            projectId: "group-saving-chama",
            storageBucket: "group-saving-chama.appspot.com",
            messagingSenderId: "570981365925",
            appId: "1:570981365925:web:42422e51e4e02c6ab4f54c"
        };
        const appId = "group-saving-chama";

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const storage = getStorage(app);

        // Helper to construct public collection paths (for shared data)
        function getPublicCollectionPath(collectionName) {
            return `artifacts/${appId}/public/data/${collectionName}`;
        }

        // Helper to construct private (user-specific) collection paths
        function getPrivateCollectionPath(userId, collectionName) {
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }

        let currentUserId = null; // Variable to hold the authenticated user's ID

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard');
            const loginForm = document.getElementById('login-form');
            const contentContainer = document.getElementById('content-container');
            const sidebar = document.querySelector('.sidebar');
            const hamburger = document.querySelector('.hamburger');
            const logoutBtn = document.getElementById('logout-btn'); // Get the logout button
            const connectionStatusElement = document.getElementById('connection-status');
            const dashboardConnectionStatusElement = document.getElementById('dashboard-connection-status');

            // Function to check admin status
            async function checkAdminStatus(email) {
                try {
                    const adminRef = doc(firestore, getPublicCollectionPath("admins"), email.toLowerCase());
                    const adminSnap = await getDoc(adminRef);
                    const isAdmin = adminSnap.exists() && adminSnap.data().isAdmin === true;
                    if (!isAdmin) {
                        console.warn(`User ${email} is NOT an admin. Admin-only data will not load.`);
                        showConfirmationModal("You are not authorized to access the admin dashboard.", () => {});
                    }
                    return isAdmin;
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    showConfirmationModal(`Error verifying admin status: ${error.message}`, () => {});
                    return false;
                }
            }

            // Function to initialize all Firestore listeners
            function initFirestoreListeners() {
                // These are all the onSnapshot calls that need to be wrapped.
                // Dashboard Overview
                // MODIFIED: 'total-members' now sourced from 'user_profile' collection group
                onSnapshot(collectionGroup(firestore, 'user_profile'), snapshot => { 
                    document.getElementById('total-members').textContent = snapshot.size;
                    if (snapshot.empty) {
                        console.warn(`No documents in 'user_profile' collection group. Possible causes: 
                          1. No data exists
                          2. User not admin or rules blocking access
                          3. Missing collection group index for 'user_profile'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'user_profile' collection group (Dashboard Overview):", error);
                });

                onSnapshot(collectionGroup(firestore, 'contributions'), snapshot => { 
                    let total = 0;
                    snapshot.forEach(doc => total += doc.data().amount || 0);
                    document.getElementById('total-contributions').textContent = `Ksh ${total.toFixed(2)}`;
                    
                    const monthlyContributions = {}; 
                    snapshot.forEach(doc => {
                        const date = doc.data().date.toDate(); 
                        const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                        monthlyContributions[monthYear] = (monthlyContributions[monthYear] || 0) + doc.data().amount;
                    });

                    const labels = Object.keys(monthlyContributions).sort();
                    const data = labels.map(label => monthlyContributions[label]);

                    const ctx1 = document.getElementById('contributions-chart').getContext('2d');
                    if (Chart.getChart(ctx1)) { 
                        Chart.getChart(ctx1).destroy();
                    }
                    new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Monthly Contributions',
                                data: data,
                                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--maroon'),
                                backgroundColor: 'rgba(128, 0, 0, 0.2)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Amount (Ksh)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Month'
                                    }
                                }
                            }
                        }
                    });
                    if (snapshot.empty) {
                        console.warn(`No documents in 'contributions' collection group. Possible causes: 
                          1. No data exists
                          2. User not admin or rules blocking access
                          3. Missing collection group index for 'contributions'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'contributions' collection group (Dashboard Overview):", error);
                });

                onSnapshot(collectionGroup(firestore, 'loans'), snapshot => { 
                    let totalIssued = 0;
                    let totalRepaid = 0;
                    snapshot.forEach(doc => {
                        const loan = doc.data();
                        totalIssued += loan.amount || 0;
                        totalRepaid += loan.repaidAmount || 0; 
                    });
                    document.getElementById('total-loans-issued').textContent = `Ksh ${totalIssued.toFixed(2)}`;
                    
                    const ctx2 = document.getElementById('loans-chart').getContext('2d');
                    if (Chart.getChart(ctx2)) { 
                        Chart.getChart(ctx2).destroy();
                    }
                    new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: ['Loans'],
                            datasets: [
                                {
                                    label: 'Disbursed',
                                    data: [totalIssued],
                                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--maroon'),
                                },
                                {
                                    label: 'Repaid',
                                    data: [totalRepaid],
                                    backgroundColor: '#4CAF50',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Amount (Ksh)'
                                    }
                                }
                            }
                        }
                    });
                    if (snapshot.empty) {
                        console.warn(`No documents in 'loans' collection group. Possible causes: 
                          1. No data exists
                          2. User not admin or rules blocking access
                          3. Missing collection group index for 'loans'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'loans' collection group (Dashboard Overview):", error);
                });

                onSnapshot(collection(firestore, getPublicCollectionPath('meetings')), snapshot => {
                    document.getElementById('meetings-scheduled').textContent = snapshot.size;
                    if (snapshot.empty) {
                        console.warn(`No documents in 'meetings' collection. Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'meetings' collection (Dashboard Overview):", error);
                });

                onSnapshot(collectionGroup(firestore, 'fines'), snapshot => {
                    document.getElementById('fines-issued').textContent = snapshot.size;
                    if (snapshot.empty) {
                        console.warn(`No documents in 'fines' collection group. Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'fines'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'fines' collection group (Dashboard Overview):", error);
                });

                onSnapshot(collection(firestore, getPublicCollectionPath('investments')), snapshot => {
                    document.getElementById('investment-projects').textContent = snapshot.size;
                    if (snapshot.empty) {
                        console.warn(`No documents in 'investments' collection. Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'investments' collection (Dashboard Overview):", error);
                });

                // Members Management listeners
                // MODIFIED: Now fetches from user_profile collection group
                onSnapshot(collectionGroup(firestore, 'user_profile'), snapshot => {
                    // Map the documents to the structure expected by renderMembersTable
                    allMembersData = snapshot.docs.map(doc => ({
                        id: doc.id, // The document ID of the user_profile is the userId
                        name: doc.data().name,
                        email: doc.data().email,
                        status: doc.data().status,
                        profilePicUrl: doc.data().profilePicUrl,
                    }));
                    renderMembersTable(allMembersData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'user_profile' collection group (Members Management). Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'user_profile'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'user_profile' collection group (Members Management):", error);
                });

                // Contributions Management dropdown listener
                // MODIFIED: Now fetches from user_profile collection group
                onSnapshot(collectionGroup(firestore, 'user_profile'), snapshot => {
                    contributionMemberSelect.innerHTML = '<option value="">Select Member</option>';
                    membersMap = {}; // Reset membersMap
                    memberIdToEmailMap = {}; // Reset memberIdToEmailMap
                    snapshot.forEach(doc => {
                        const memberData = doc.data();
                        const memberId = doc.id; // User ID is the doc ID in user_profile
                        membersMap[memberId] = memberData.name; // Update global map
                        memberIdToEmailMap[memberId] = memberData.email; // Update global map
                        const option = document.createElement('option');
                        option.value = memberId;
                        option.textContent = memberData.name;
                        contributionMemberSelect.appendChild(option);
                    });
                    if (snapshot.empty) {
                        console.warn(`No documents in 'user_profile' collection group (Contributions Management - member dropdown). Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'user_profile'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'user_profile' collection group (Contributions Management - member dropdown):", error);
                });

                onSnapshot(collectionGroup(firestore, 'contributions'), snapshot => {
                    allContributionsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        memberUserId: doc.ref.parent.parent.id,
                        ...doc.data()
                    }));
                    renderContributionsTable(allContributionsData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'contributions' collection group (Contributions Management). Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'contributions'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'contributions' collection group (Contributions Management):", error);
                });

                // Loan Management dropdown listener
                // MODIFIED: Now fetches from user_profile collection group
                onSnapshot(collectionGroup(firestore, 'user_profile'), snapshot => {
                    loanMemberSelect.innerHTML = '<option value="">Select Member</option>';
                    // membersMap and memberIdToEmailMap are global, will be updated by other listeners
                    // but it's good practice to ensure consistency if this is the primary source for this section's dropdown.
                    snapshot.forEach(doc => {
                        const memberData = doc.data();
                        const memberId = doc.id; // User ID is the doc ID in user_profile
                        membersMap[memberId] = memberData.name; // Update global map
                        memberIdToEmailMap[memberId] = memberData.email; // Update global map
                        const option = document.createElement('option');
                        option.value = memberId;
                        option.textContent = memberData.name;
                        loanMemberSelect.appendChild(option);
                    });
                    if (snapshot.empty) {
                        console.warn(`No documents in 'user_profile' collection group (Loan Management - member dropdown). Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'user_profile'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'user_profile' collection group (Loan Management - member dropdown):", error);
                });

                onSnapshot(collectionGroup(firestore, 'loans'), snapshot => {
                    allLoansData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        memberUserId: doc.ref.parent.parent.id, // Extract the user ID from the path
                        ...doc.data()
                    }));
                    renderLoansTable(allLoansData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'loans' collection group (Loan Management). Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'loans'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'loans' collection group (Loan Management):", error);
                });

                // Meetings & Notices listener
                onSnapshot(collection(firestore, getPublicCollectionPath('meetings')), snapshot => {
                    allMeetingsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMeetingsNoticesTable(allMeetingsData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'meetings' collection (Meetings & Notices). Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'meetings' collection (Meetings & Notices):", error);
                });

                // Fines & Penalties listener
                onSnapshot(collectionGroup(firestore, 'fines'), snapshot => {
                    allFinesData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        memberUserId: doc.ref.parent.parent.id,
                        ...doc.data()
                    }));
                    renderFinesTable(allFinesData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'fines' collection group (Fines & Penalties). Possible causes: 1. No data exists 2. User not admin or rules blocking access 3. Missing collection group index for 'fines'`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'fines' collection group (Fines & Penalties):", error);
                });

                // Investments listener
                onSnapshot(collection(firestore, getPublicCollectionPath('investments')), snapshot => {
                    allInvestmentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInvestmentsTable(allInvestmentsData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'investments' collection (Investments). Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'investments' collection (Investments):", error);
                });

                // Polls listener
                onSnapshot(collection(firestore, getPublicCollectionPath('polls')), snapshot => {
                    allPollsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderPollsTable(allPollsData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'polls' collection (Voting & Polls). Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'polls' collection (Voting & Polls):", error);
                });

                // Documents listener
                onSnapshot(collection(firestore, getPublicCollectionPath('documents')), snapshot => {
                    allDocumentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDocumentsTable(allDocumentsData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'documents' collection (Documents Management). Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'documents' collection (Documents Management):", error);
                });

                // Chat Messages listener
                onSnapshot(query(collection(firestore, getPublicCollectionPath('chat')), orderBy("timestamp")), snapshot => {
                    // Update chat messages in the dashboard
                    const messages = snapshot.docs.map(doc => doc.data());
                    renderDashboardChat(messages);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'chat' collection (Chat). Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'chat' collection (Chat):", error);
                });

                // Notifications listener
                onSnapshot(collection(firestore, getPublicCollectionPath('notifications')), snapshot => {
                    allNotificationsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNotificationsTable(allNotificationsData);
                    if (snapshot.empty) {
                        console.warn(`No documents in 'notifications' collection (Notifications). Possible causes: 1. No data exists 2. User not admin or rules blocking access`);
                    }
                }, error => {
                    console.error("Firestore listener error for 'notifications' collection (Notifications):", error);
                });
            }

            // Authentication state change handler
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    const isAdmin = await checkAdminStatus(user.email);
                    if (isAdmin) {
                        loginPage.style.display = 'none';
                        dashboardPage.style.display = 'block';
                        initFirestoreListeners(); // Initialize listeners only after a successful admin login
                        renderPage('dashboard-overview'); // Load the default page
                    } else {
                        // Not an admin, log them out. checkAdminStatus() already shows a modal.
                        await signOut(auth);
                    }
                } else {
                    currentUserId = null;
                    dashboardPage.style.display = 'none';
                    loginPage.style.display = 'block';
                    // Clear all data and UI
                    contentContainer.innerHTML = '';
                }
            });

            // Login form submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');

                try {
                    // Set persistence to local to keep the user logged in
                    await setPersistence(auth, browserLocalPersistence);
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("Logged in as:", user.email);
                    loginError.textContent = ''; // Clear any previous errors
                } catch (error) {
                    console.error("Login failed:", error.code, error.message);
                    loginError.textContent = 'Login failed: Invalid email or password.';
                }
            });
            
            // Logout button click handler
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log("User signed out.");
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            });

            // Navigation handler
            sidebar.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.dataset.section) {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar ul li a').forEach(el => el.classList.remove('active'));
                    link.classList.add('active');
                    renderPage(link.dataset.section);
                }
            });
            
            // Hamburger menu handler
            hamburger.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            // Modal handlers
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            let modalCallback = null;
            
            function showConfirmationModal(message, onConfirm) {
                document.getElementById('modal-message').textContent = message;
                modalCallback = onConfirm;
                confirmationModal.style.display = 'flex';
            }

            modalConfirmBtn.addEventListener('click', () => {
                if (modalCallback) {
                    modalCallback();
                }
                confirmationModal.style.display = 'none';
                modalCallback = null;
            });
            
            modalCancelBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                modalCallback = null;
            });

            // --- UI Rendering & Firestore Interactions ---
            let allMembersData = [];
            let allContributionsData = [];
            let allLoansData = [];
            let allMeetingsData = [];
            let allInvestmentsData = [];
            let allPollsData = [];
            let allDocumentsData = [];
            let allFinesData = [];
            let allNotificationsData = [];

            let membersMap = {}; // Map to store memberId -> memberName
            let memberIdToEmailMap = {}; // Map to store memberId -> memberEmail


            // Function to render content based on section
            async function renderPage(section) {
                contentContainer.innerHTML = ''; // Clear previous content

                // Define the page content based on the section
                let pageHtml = '';
                switch (section) {
                    case 'dashboard-overview':
                        pageHtml = `
                            <h2>Dashboard Overview</h2>
                            <p>Admin tools to manage Chama activities and members.</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 2rem;">
                                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Total Members</h3>
                                    <p id="total-members" style="font-size: 2rem; font-weight: bold; color: var(--maroon);">...</p>
                                </div>
                                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Total Contributions</h3>
                                    <p id="total-contributions" style="font-size: 2rem; font-weight: bold; color: var(--maroon);">...</p>
                                </div>
                                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Loans Disbursed</h3>
                                    <p id="total-loans-issued" style="font-size: 2rem; font-weight: bold; color: var(--maroon);">...</p>
                                </div>
                                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Meetings Scheduled</h3>
                                    <p id="meetings-scheduled" style="font-size: 2rem; font-weight: bold; color: var(--maroon);">...</p>
                                </div>
                                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Fines Issued</h3>
                                    <p id="fines-issued" style="font-size: 2rem; font-weight: bold; color: var(--maroon);">...</p>
                                </div>
                                <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Investment Projects</h3>
                                    <p id="investment-projects" style="font-size: 2rem; font-weight: bold; color: var(--maroon);">...</p>
                                </div>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 2rem;">
                                <div style="flex: 1; min-width: 300px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Contributions Trend</h3>
                                    <canvas id="contributions-chart"></canvas>
                                </div>
                                <div style="flex: 1; min-width: 300px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h3>Loans vs Repayments</h3>
                                    <canvas id="loans-chart"></canvas>
                                </div>
                            </div>
                        `;
                        break;
                    case 'members-management':
                        pageHtml = `
                            <h2>Members Management</h2>
                            <p>View and manage all chama members.</p>
                            <table class="data-table" id="members-table">
                                <thead>
                                    <tr>
                                        <th>Profile Picture</th>
                                        <th onclick="sortTable('members-table', 1)">Name</th>
                                        <th onclick="sortTable('members-table', 2)">Email</th>
                                        <th onclick="sortTable('members-table', 3)">Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'contributions-management':
                        pageHtml = `
                            <h2>Contributions Management</h2>
                            <div class="form-group">
                                <label for="contribution-member-select">Select Member:</label>
                                <select id="contribution-member-select"></select>
                            </div>
                            <form id="add-contribution-form" style="display: none;">
                                <h3>Add New Contribution for <span id="contribution-member-name"></span></h3>
                                <div class="form-group">
                                    <label for="contribution-amount">Amount (Ksh)</label>
                                    <input type="number" id="contribution-amount" min="1" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="contribution-date">Date</label>
                                    <input type="date" id="contribution-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="contribution-notes">Notes</label>
                                    <textarea id="contribution-notes" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Contribution</button>
                                <button type="button" class="btn" onclick="document.getElementById('add-contribution-form').style.display='none'">Cancel</button>
                            </form>
                            <h3 style="margin-top: 2rem;">All Contributions</h3>
                            <table class="data-table" id="contributions-table">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'loan-management':
                        pageHtml = `
                            <h2>Loan Management</h2>
                            <div class="form-group">
                                <label for="loan-member-select">Select Member:</label>
                                <select id="loan-member-select"></select>
                            </div>
                            <form id="request-loan-form" style="display: none;">
                                <h3>Request New Loan for <span id="loan-member-name"></span></h3>
                                <div class="form-group">
                                    <label for="loan-amount">Amount (Ksh)</label>
                                    <input type="number" id="loan-amount" min="1" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="loan-purpose">Purpose</label>
                                    <textarea id="loan-purpose" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="loan-dueDate">Due Date</label>
                                    <input type="date" id="loan-dueDate" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Request Loan</button>
                                <button type="button" class="btn" onclick="document.getElementById('request-loan-form').style.display='none'">Cancel</button>
                            </form>
                            <h3 style="margin-top: 2rem;">All Loans</h3>
                            <table class="data-table" id="loans-table">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Amount</th>
                                        <th>Purpose</th>
                                        <th>Date Issued</th>
                                        <th>Due Date</th>
                                        <th>Repaid Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'meetings-notices':
                        pageHtml = `
                            <h2>Meetings & Notices</h2>
                            <form id="add-meeting-form">
                                <h3>Schedule New Meeting/Notice</h3>
                                <div class="form-group">
                                    <label for="meeting-title">Title</label>
                                    <input type="text" id="meeting-title" required>
                                </div>
                                <div class="form-group">
                                    <label for="meeting-date">Date</label>
                                    <input type="datetime-local" id="meeting-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="meeting-location">Location</label>
                                    <input type="text" id="meeting-location" required>
                                </div>
                                <div class="form-group">
                                    <label for="meeting-agenda">Agenda/Notes</label>
                                    <textarea id="meeting-agenda" rows="5"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Meeting</button>
                            </form>
                            <h3 style="margin-top: 2rem;">Scheduled Meetings & Notices</h3>
                            <table class="data-table" id="meetings-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Date & Time</th>
                                        <th>Location</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'fines-penalties':
                        pageHtml = `
                            <h2>Fines & Penalties</h2>
                            <form id="issue-fine-form">
                                <h3>Issue New Fine</h3>
                                <div class="form-group">
                                    <label for="fine-member-select">Select Member:</label>
                                    <select id="fine-member-select" required>
                                        </select>
                                </div>
                                <div class="form-group">
                                    <label for="fine-reason">Reason for Fine</label>
                                    <input type="text" id="fine-reason" required>
                                </div>
                                <div class="form-group">
                                    <label for="fine-amount">Amount (Ksh)</label>
                                    <input type="number" id="fine-amount" min="1" step="0.01" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Issue Fine</button>
                            </form>
                            <h3 style="margin-top: 2rem;">All Fines</h3>
                            <table class="data-table" id="fines-table">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Reason</th>
                                        <th>Amount</th>
                                        <th>Date Issued</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'investments':
                        pageHtml = `
                            <h2>Investments</h2>
                            <form id="add-investment-form">
                                <h3>Add New Investment Project</h3>
                                <div class="form-group">
                                    <label for="investment-name">Project Name</label>
                                    <input type="text" id="investment-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="investment-description">Description</label>
                                    <textarea id="investment-description" rows="5" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="investment-amount">Initial Investment (Ksh)</label>
                                    <input type="number" id="investment-amount" min="1" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="investment-date">Date Started</label>
                                    <input type="date" id="investment-date" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Investment</button>
                            </form>
                            <h3 style="margin-top: 2rem;">Current Investment Projects</h3>
                            <table class="data-table" id="investments-table">
                                <thead>
                                    <tr>
                                        <th>Project Name</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Date Started</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'voting-polls':
                        pageHtml = `
                            <h2>Voting & Polls</h2>
                            <form id="create-poll-form">
                                <h3>Create a New Poll</h3>
                                <div class="form-group">
                                    <label for="poll-question">Poll Question</label>
                                    <input type="text" id="poll-question" required>
                                </div>
                                <div id="poll-options-container" class="form-group">
                                    <label>Poll Options (at least two)</label>
                                    <input type="text" class="poll-option-input" placeholder="Option 1" required>
                                    <input type="text" class="poll-option-input" placeholder="Option 2" required>
                                </div>
                                <button type="button" class="btn" id="add-poll-option-btn">Add Option</button>
                                <button type="submit" class="btn btn-primary">Create Poll</button>
                            </form>
                            <h3 style="margin-top: 2rem;">Active Polls</h3>
                            <table class="data-table" id="polls-table">
                                <thead>
                                    <tr>
                                        <th>Question</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'documents-management':
                        pageHtml = `
                            <h2>Documents Management</h2>
                            <form id="upload-document-form">
                                <h3>Upload New Document</h3>
                                <div class="form-group">
                                    <label for="document-file">Select File</label>
                                    <input type="file" id="document-file" required>
                                </div>
                                <div class="form-group">
                                    <label for="document-title">Title</label>
                                    <input type="text" id="document-title" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Upload Document</button>
                            </form>
                            <h3 style="margin-top: 2rem;">Shared Documents</h3>
                            <table class="data-table" id="documents-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Uploaded By</th>
                                        <th>Date</th>
                                        <th>File</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'attendance':
                        pageHtml = `
                            <h2>Attendance</h2>
                            <p>Attendance tracking for meetings is not yet implemented. This section is a placeholder.</p>
                        `;
                        break;
                    case 'notifications':
                        pageHtml = `
                            <h2>Notifications</h2>
                            <form id="send-notification-form">
                                <h3>Send New Notification</h3>
                                <div class="form-group">
                                    <label for="notification-title">Title</label>
                                    <input type="text" id="notification-title" required>
                                </div>
                                <div class="form-group">
                                    <label for="notification-message">Message</label>
                                    <textarea id="notification-message" rows="5" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Send Notification</button>
                            </form>
                            <h3 style="margin-top: 2rem;">Sent Notifications</h3>
                            <table class="data-table" id="notifications-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Message</th>
                                        <th>Date Sent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        `;
                        break;
                    case 'reports':
                        pageHtml = `
                            <h2>Reports</h2>
                            <p>Financial and member reports are not yet implemented. This section is a placeholder.</p>
                        `;
                        break;
                    default:
                        pageHtml = `<p>Welcome to the dashboard. Select a section from the sidebar.</p>`;
                        break;
                }

                contentContainer.innerHTML = pageHtml;

                // Dynamically attach event listeners and fill tables after content is rendered
                if (section === 'contributions-management') {
                    const contributionMemberSelect = document.getElementById('contribution-member-select');
                    const addContributionForm = document.getElementById('add-contribution-form');
                    const contributionMemberName = document.getElementById('contribution-member-name');
                    contributionMemberSelect.addEventListener('change', () => {
                        const userId = contributionMemberSelect.value;
                        if (userId) {
                            contributionMemberName.textContent = membersMap[userId];
                            addContributionForm.style.display = 'block';
                        } else {
                            addContributionForm.style.display = 'none';
                        }
                    });
                    document.getElementById('add-contribution-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const memberUserId = contributionMemberSelect.value;
                        const amount = parseFloat(document.getElementById('contribution-amount').value);
                        const date = new Date(document.getElementById('contribution-date').value);
                        const notes = document.getElementById('contribution-notes').value;

                        if (isNaN(amount) || amount <= 0 || !memberUserId) {
                            showConfirmationModal("Please enter a valid amount and select a member.", () => {});
                            return;
                        }

                        try {
                            // The path is now a subcollection of the user's document
                            const contributionRef = collection(firestore, getPrivateCollectionPath(memberUserId, "contributions"));
                            await addDoc(contributionRef, {
                                amount: amount,
                                date: date,
                                notes: notes,
                                timestamp: serverTimestamp()
                            });
                            showConfirmationModal("Contribution added successfully!", () => {});
                            e.target.reset(); // Reset the form
                        } catch (e) {
                            console.error("Error adding contribution: ", e);
                            showConfirmationModal(`Error adding contribution: ${e.message}`, () => {});
                        }
                    });
                }
                
                if (section === 'loan-management') {
                    const loanMemberSelect = document.getElementById('loan-member-select');
                    const requestLoanForm = document.getElementById('request-loan-form');
                    const loanMemberName = document.getElementById('loan-member-name');
                    loanMemberSelect.addEventListener('change', () => {
                        const userId = loanMemberSelect.value;
                        if (userId) {
                            loanMemberName.textContent = membersMap[userId];
                            requestLoanForm.style.display = 'block';
                        } else {
                            requestLoanForm.style.display = 'none';
                        }
                    });
                    document.getElementById('request-loan-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const memberUserId = loanMemberSelect.value;
                        const amount = parseFloat(document.getElementById('loan-amount').value);
                        const purpose = document.getElementById('loan-purpose').value;
                        const dueDate = new Date(document.getElementById('loan-dueDate').value);

                        if (isNaN(amount) || amount <= 0 || !memberUserId) {
                            showConfirmationModal("Please enter a valid amount and select a member.", () => {});
                            return;
                        }

                        try {
                            const loanRef = collection(firestore, getPrivateCollectionPath(memberUserId, "loans"));
                            await addDoc(loanRef, {
                                amount: amount,
                                purpose: purpose,
                                dateIssued: serverTimestamp(),
                                dueDate: dueDate,
                                repaidAmount: 0,
                                status: "pending"
                            });
                            showConfirmationModal("Loan request submitted successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error requesting loan: ", e);
                            showConfirmationModal(`Error requesting loan: ${e.message}`, () => {});
                        }
                    });
                }
                
                if (section === 'meetings-notices') {
                    document.getElementById('add-meeting-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const title = document.getElementById('meeting-title').value;
                        const date = new Date(document.getElementById('meeting-date').value);
                        const location = document.getElementById('meeting-location').value;
                        const agenda = document.getElementById('meeting-agenda').value;

                        try {
                            const meetingRef = collection(firestore, getPublicCollectionPath("meetings"));
                            await addDoc(meetingRef, {
                                title: title,
                                date: date,
                                location: location,
                                agenda: agenda,
                                timestamp: serverTimestamp()
                            });
                            showConfirmationModal("Meeting/Notice added successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error adding meeting:", e);
                            showConfirmationModal(`Error adding meeting: ${e.message}`, () => {});
                        }
                    });
                }

                if (section === 'fines-penalties') {
                    const fineMemberSelect = document.getElementById('fine-member-select');
                    // Populate member select dropdown
                    const membersSnapshot = await getDocs(collectionGroup(firestore, 'user_profile'));
                    fineMemberSelect.innerHTML = '<option value="">Select Member</option>';
                    membersSnapshot.forEach(doc => {
                        const memberId = doc.id;
                        const memberName = doc.data().name;
                        membersMap[memberId] = memberName; // Update global map
                        const option = document.createElement('option');
                        option.value = memberId;
                        option.textContent = memberName;
                        fineMemberSelect.appendChild(option);
                    });

                    document.getElementById('issue-fine-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const memberUserId = fineMemberSelect.value;
                        const reason = document.getElementById('fine-reason').value;
                        const amount = parseFloat(document.getElementById('fine-amount').value);

                        if (isNaN(amount) || amount <= 0 || !memberUserId) {
                            showConfirmationModal("Please enter a valid amount, reason, and select a member.", () => {});
                            return;
                        }

                        try {
                            const fineRef = collection(firestore, getPrivateCollectionPath(memberUserId, "fines"));
                            await addDoc(fineRef, {
                                reason: reason,
                                amount: amount,
                                dateIssued: serverTimestamp(),
                                isPaid: false
                            });
                            showConfirmationModal("Fine issued successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error issuing fine: ", e);
                            showConfirmationModal(`Error issuing fine: ${e.message}`, () => {});
                        }
                    });
                }
                
                if (section === 'investments') {
                    document.getElementById('add-investment-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('investment-name').value;
                        const description = document.getElementById('investment-description').value;
                        const amount = parseFloat(document.getElementById('investment-amount').value);
                        const date = new Date(document.getElementById('investment-date').value);

                        if (isNaN(amount) || amount <= 0) {
                            showConfirmationModal("Please enter a valid amount.", () => {});
                            return;
                        }

                        try {
                            const investmentRef = collection(firestore, getPublicCollectionPath("investments"));
                            await addDoc(investmentRef, {
                                name: name,
                                description: description,
                                amount: amount,
                                dateStarted: date,
                                timestamp: serverTimestamp()
                            });
                            showConfirmationModal("Investment added successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error adding investment:", e);
                            showConfirmationModal(`Error adding investment: ${e.message}`, () => {});
                        }
                    });
                }
                
                if (section === 'voting-polls') {
                    document.getElementById('create-poll-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const question = document.getElementById('poll-question').value;
                        const optionInputs = document.querySelectorAll('.poll-option-input');
                        const options = Array.from(optionInputs).map(input => input.value).filter(val => val.trim() !== '');

                        if (options.length < 2) {
                            showConfirmationModal("Please provide at least two poll options.", () => {});
                            return;
                        }
                        
                        // Structure options for Firestore
                        const optionsData = options.map(optionText => ({ text: optionText, votes: 0 }));

                        try {
                            const pollRef = collection(firestore, getPublicCollectionPath("polls"));
                            await addDoc(pollRef, {
                                question: question,
                                options: optionsData,
                                isActive: true,
                                createdAt: serverTimestamp(),
                                createdBy: currentUserId,
                                totalVotes: 0,
                            });
                            showConfirmationModal("Poll created successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error creating poll:", e);
                            showConfirmationModal(`Error creating poll: ${e.message}`, () => {});
                        }
                    });
                    
                    document.getElementById('add-poll-option-btn').addEventListener('click', () => {
                        const optionsContainer = document.getElementById('poll-options-container');
                        const newOption = document.createElement('input');
                        newOption.type = 'text';
                        newOption.className = 'poll-option-input';
                        newOption.placeholder = `Option ${optionsContainer.children.length}`;
                        newOption.required = true;
                        optionsContainer.appendChild(newOption);
                    });
                }
                
                if (section === 'documents-management') {
                    document.getElementById('upload-document-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const file = document.getElementById('document-file').files[0];
                        const title = document.getElementById('document-title').value;

                        if (!file) {
                            showConfirmationModal("Please select a file to upload.", () => {});
                            return;
                        }

                        try {
                            // Upload file to Firebase Storage
                            const fileRef = ref(storage, `documents/${file.name}`);
                            const snapshot = await uploadBytes(fileRef, file);
                            const downloadUrl = await getDownloadURL(snapshot.ref);

                            // Save metadata to Firestore
                            const documentsRef = collection(firestore, getPublicCollectionPath("documents"));
                            await addDoc(documentsRef, {
                                title: title,
                                filename: file.name,
                                url: downloadUrl,
                                uploadedBy: currentUserId, // You'll need to get the current user's ID
                                timestamp: serverTimestamp(),
                                mimeType: file.type
                            });
                            showConfirmationModal("Document uploaded successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error uploading document:", e);
                            showConfirmationModal(`Error uploading document: ${e.message}`, () => {});
                        }
                    });
                }
                
                if (section === 'notifications') {
                    document.getElementById('send-notification-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const title = document.getElementById('notification-title').value;
                        const message = document.getElementById('notification-message').value;

                        try {
                            const notificationRef = collection(firestore, getPublicCollectionPath("notifications"));
                            await addDoc(notificationRef, {
                                title: title,
                                message: message,
                                sentAt: serverTimestamp(),
                                sentBy: currentUserId // You'll need to get the current user's ID
                            });
                            showConfirmationModal("Notification sent successfully!", () => {});
                            e.target.reset();
                        } catch (e) {
                            console.error("Error sending notification:", e);
                            showConfirmationModal(`Error sending notification: ${e.message}`, () => {});
                        }
                    });
                }
            }

            // --- UI Rendering Functions for Data Tables ---
            function renderMembersTable(members) {
                const tableBody = document.querySelector('#members-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                members.forEach(member => {
                    const row = `
                        <tr>
                            <td><img src="${member.profilePicUrl || 'https://via.placeholder.com/40'}" alt="Profile" style="width:40px;height:40px;border-radius:50%;"></td>
                            <td>${member.name}</td>
                            <td>${member.email}</td>
                            <td>${member.status || 'Active'}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete ${member.name}\'s profile? This action is permanent.', () => deleteMember('${member.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            async function deleteMember(userId) {
                try {
                    // Path to the user's profile document
                    const userProfileDocRef = doc(firestore, getPublicCollectionPath("user_profile"), userId);
                    await deleteDoc(userProfileDocRef);
                    showConfirmationModal("Member profile deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting member: ", e);
                    showConfirmationModal(`Error deleting member: ${e.message}`, () => {});
                }
            }
            
            function renderContributionsTable(contributions) {
                const tableBody = document.querySelector('#contributions-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                contributions.forEach(contribution => {
                    const memberName = membersMap[contribution.memberUserId] || 'Unknown Member';
                    const row = `
                        <tr>
                            <td>${memberName}</td>
                            <td>Ksh ${contribution.amount.toFixed(2)}</td>
                            <td>${contribution.date ? new Date(contribution.date.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>${contribution.notes || 'N/A'}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this contribution? This action is permanent.', () => deleteContribution('${contribution.memberUserId}', '${contribution.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            async function deleteContribution(memberUserId, contributionId) {
                try {
                    const contributionDocRef = doc(firestore, getPrivateCollectionPath(memberUserId, "contributions"), contributionId);
                    await deleteDoc(contributionDocRef);
                    showConfirmationModal("Contribution deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting contribution: ", e);
                    showConfirmationModal(`Error deleting contribution: ${e.message}`, () => {});
                }
            }

            function renderLoansTable(loans) {
                const tableBody = document.querySelector('#loans-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                loans.forEach(loan => {
                    const memberName = membersMap[loan.memberUserId] || 'Unknown Member';
                    const statusColor = loan.status === 'repaid' ? 'green' : 'orange';
                    const actionButtons = loan.status === 'pending'
                        ? `
                        <button onclick="approveLoan('${loan.memberUserId}', '${loan.id}')" class="btn btn-primary" style="background-color: #4CAF50;">Approve</button>
                        <button onclick="showConfirmationModal('Are you sure you want to delete this loan?', () => deleteLoan('${loan.memberUserId}', '${loan.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                        `
                        : `
                        <button onclick="showConfirmationModal('Are you sure you want to delete this loan?', () => deleteLoan('${loan.memberUserId}', '${loan.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                        `;

                    const row = `
                        <tr>
                            <td>${memberName}</td>
                            <td>Ksh ${loan.amount.toFixed(2)}</td>
                            <td>${loan.purpose || 'N/A'}</td>
                            <td>${loan.dateIssued ? new Date(loan.dateIssued.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>${loan.dueDate ? new Date(loan.dueDate.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>Ksh ${loan.repaidAmount ? loan.repaidAmount.toFixed(2) : '0.00'}</td>
                            <td style="color: ${statusColor};">${loan.status}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            async function approveLoan(memberUserId, loanId) {
                try {
                    const loanDocRef = doc(firestore, getPrivateCollectionPath(memberUserId, "loans"), loanId);
                    await updateDoc(loanDocRef, {
                        status: "approved"
                    });
                    showConfirmationModal("Loan approved successfully!", () => {});
                } catch (e) {
                    console.error("Error approving loan: ", e);
                    showConfirmationModal(`Error approving loan: ${e.message}`, () => {});
                }
            }
            
            async function deleteLoan(memberUserId, loanId) {
                try {
                    const loanDocRef = doc(firestore, getPrivateCollectionPath(memberUserId, "loans"), loanId);
                    await deleteDoc(loanDocRef);
                    showConfirmationModal("Loan deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting loan: ", e);
                    showConfirmationModal(`Error deleting loan: ${e.message}`, () => {});
                }
            }

            function renderMeetingsNoticesTable(meetings) {
                const tableBody = document.querySelector('#meetings-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                meetings.forEach(meeting => {
                    const row = `
                        <tr>
                            <td>${meeting.title}</td>
                            <td>${meeting.date ? new Date(meeting.date.seconds * 1000).toLocaleString() : 'N/A'}</td>
                            <td>${meeting.location}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this meeting notice? This action is permanent.', () => deleteMeeting('${meeting.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            async function deleteMeeting(meetingId) {
                try {
                    const meetingDocRef = doc(firestore, getPublicCollectionPath("meetings"), meetingId);
                    await deleteDoc(meetingDocRef);
                    showConfirmationModal("Meeting/Notice deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting meeting:", e);
                    showConfirmationModal(`Error deleting meeting: ${e.message}`, () => {});
                }
            }

            function renderFinesTable(fines) {
                const tableBody = document.querySelector('#fines-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                fines.forEach(fine => {
                    const memberName = membersMap[fine.memberUserId] || 'Unknown Member';
                    const row = `
                        <tr>
                            <td>${memberName}</td>
                            <td>${fine.reason}</td>
                            <td>Ksh ${fine.amount.toFixed(2)}</td>
                            <td>${fine.dateIssued ? new Date(fine.dateIssued.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this fine? This action is permanent.', () => deleteFine('${fine.memberUserId}', '${fine.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            async function deleteFine(memberUserId, fineId) {
                try {
                    const fineDocRef = doc(firestore, getPrivateCollectionPath(memberUserId, "fines"), fineId);
                    await deleteDoc(fineDocRef);
                    showConfirmationModal("Fine deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting fine:", e);
                    showConfirmationModal(`Error deleting fine: ${e.message}`, () => {});
                }
            }
            
            function renderInvestmentsTable(investments) {
                const tableBody = document.querySelector('#investments-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                investments.forEach(investment => {
                    const row = `
                        <tr>
                            <td>${investment.name}</td>
                            <td>${investment.description}</td>
                            <td>Ksh ${investment.amount.toFixed(2)}</td>
                            <td>${investment.dateStarted ? new Date(investment.dateStarted.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this investment? This action is permanent.', () => deleteInvestment('${investment.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            async function deleteInvestment(investmentId) {
                try {
                    const investmentDocRef = doc(firestore, getPublicCollectionPath("investments"), investmentId);
                    await deleteDoc(investmentDocRef);
                    showConfirmationModal("Investment deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting investment:", e);
                    showConfirmationModal(`Error deleting investment: ${e.message}`, () => {});
                }
            }
            
            function renderPollsTable(polls) {
                const tableBody = document.querySelector('#polls-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                polls.forEach(poll => {
                    const row = `
                        <tr>
                            <td>${poll.question}</td>
                            <td>${poll.isActive ? 'Active' : 'Closed'}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to close this poll?', () => closePoll('${poll.id}'))" class="btn btn-primary" style="background-color: orange;">Close</button>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this poll?', () => deletePoll('${poll.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            async function closePoll(pollId) {
                try {
                    const pollDocRef = doc(firestore, getPublicCollectionPath("polls"), pollId);
                    await updateDoc(pollDocRef, {
                        isActive: false
                    });
                    showConfirmationModal("Poll closed successfully!", () => {});
                } catch (e) {
                    console.error("Error closing poll:", e);
                    showConfirmationModal(`Error closing poll: ${e.message}`, () => {});
                }
            }

            async function deletePoll(pollId) {
                try {
                    const pollDocRef = doc(firestore, getPublicCollectionPath("polls"), pollId);
                    await deleteDoc(pollDocRef);
                    showConfirmationModal("Poll deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting poll:", e);
                    showConfirmationModal(`Error deleting poll: ${e.message}`, () => {});
                }
            }
            
            function renderDocumentsTable(documents) {
                const tableBody = document.querySelector('#documents-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                documents.forEach(doc => {
                    const uploadedByEmail = memberIdToEmailMap[doc.uploadedBy] || 'Unknown';
                    const row = `
                        <tr>
                            <td>${doc.title}</td>
                            <td>${uploadedByEmail}</td>
                            <td>${doc.timestamp ? new Date(doc.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                            <td><a href="${doc.url}" target="_blank">View File</a></td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this document? This action is permanent.', () => deleteDocument('${doc.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            async function deleteDocument(documentId) {
                try {
                    const documentDocRef = doc(firestore, getPublicCollectionPath("documents"), documentId);
                    await deleteDoc(documentDocRef);
                    showConfirmationModal("Document deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting document:", e);
                    showConfirmationModal(`Error deleting document: ${e.message}`, () => {});
                }
            }
            
            function renderNotificationsTable(notifications) {
                const tableBody = document.querySelector('#notifications-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                notifications.forEach(notification => {
                    const row = `
                        <tr>
                            <td>${notification.title}</td>
                            <td>${notification.message}</td>
                            <td>${notification.sentAt ? new Date(notification.sentAt.seconds * 1000).toLocaleString() : 'N/A'}</td>
                            <td>
                                <button onclick="showConfirmationModal('Are you sure you want to delete this notification?', () => deleteNotification('${notification.id}'))" class="btn btn-primary" style="background-color: red;">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            async function deleteNotification(notificationId) {
                try {
                    const notificationDocRef = doc(firestore, getPublicCollectionPath("notifications"), notificationId);
                    await deleteDoc(notificationDocRef);
                    showConfirmationModal("Notification deleted successfully!", () => {});
                } catch (e) {
                    console.error("Error deleting notification:", e);
                    showConfirmationModal(`Error deleting notification: ${e.message}`, () => {});
                }
            }

            // Global functions for inline event handlers
            window.showConfirmationModal = showConfirmationModal;
            window.deleteMember = deleteMember;
            window.deleteContribution = deleteContribution;
            window.deleteLoan = deleteLoan;
            window.approveLoan = approveLoan;
            window.deleteMeeting = deleteMeeting;
            window.deleteFine = deleteFine;
            window.deleteInvestment = deleteInvestment;
            window.closePoll = closePoll;
            window.deletePoll = deletePoll;
            window.deleteDocument = deleteDocument;
            window.deleteNotification = deleteNotification;

        });

    </script>

</body>
</html>
