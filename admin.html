<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Digital - Chama Admin Dashboard</title>
    
    <!-- Modular Firebase SDKs -->
    <script type="module">
        // UPGRADED FIREBASE IMPORTS FROM v9.22.2 to v10.12.2
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // REMOVED collectionGroup as per instructions, only needed functions are imported
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <style>
        /* General Styles and Branding */
        :root {
            --maroon: #800000;
            --white: #ffffff;
            --light-gray: #f4f4f4;
            --dark-gray: #333;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        header {
            background-color: var(--maroon);
            color: var(--white);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header-brand h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--dark-gray);
            color: var(--white);
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li a {
            display: block;
            padding: 15px 20px;
            color: var(--white);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--maroon);
        }
        
        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            transition: margin-left 0.3s;
        }

        h2 {
            color: var(--maroon);
            border-bottom: 2px solid var(--maroon);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: var(--maroon);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #a00000;
        }
        
        /* Forms and Inputs */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea { /* Added textarea for consistency */
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* Ensures padding doesn't increase width */
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--white);
        }

        .data-table th, .data-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: var(--maroon);
            color: var(--white);
            cursor: pointer;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 1rem;
            background-color: var(--dark-gray);
            color: var(--white);
            position: sticky;
            bottom: 0;
        }
        
        /* Mobile Styles */
        .hamburger {
            display: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--white);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                position: fixed;
                width: 100%;
                height: 100%;
                z-index: 999;
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            header {
                flex-direction: row-reverse;
            }
            .hamburger {
                display: block;
            }
        }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page">
        <header>
            <div class="header-brand">
                <h1>Prince Alex Digital</h1>
                <p>Chama Admin Login</p>
            </div>
            <p id="connection-status" style="color: yellow; font-weight: bold;"></p> <!-- Added for connection status -->
        </header>
        <div style="max-width: 400px; margin: 50px auto; padding: 20px; background: #fff; border-radius: 8px;">
            <h2>Admin Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="login-error" style="color: red; margin-top: 10px;"></p>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" style="display: none;">
        <header>
            <div class="header-brand">
                <h1>Prince Alex Digital</h1>
                <p>Chama Admin Dashboard</p>
            </div>
            <p id="dashboard-connection-status" style="color: yellow; font-weight: bold; margin-left: auto;"></p> <!-- Added for dashboard connection status -->
            <button id="logout-btn" class="btn">Logout</button> <!-- Added Logout Button -->
            <div class="hamburger">&#9776;</div>
        </header>

        <div class="container">
            <nav class="sidebar">
                <ul>
                    <li><a href="#" data-section="dashboard-overview" class="active">Dashboard Overview</a></li>
                    <li><a href="#" data-section="members-management">Members Management</a></li>
                    <li><a href="#" data-section="contributions-management">Contributions Management</a></li>
                    <li><a href="#" data-section="loan-management">Loan Management</a></li>
                    <li><a href="#" data-section="meetings-notices">Meetings & Notices</a></li>
                    <li><a href="#" data-section="fines-penalties">Fines & Penalties</a></li>
                    <li><a href="#" data-section="investments">Investments</a></li>
                    <li><a href="#" data-section="voting-polls">Voting & Polls</a></li>
                    <li><a href="#" data-section="documents-management">Documents Management</a></li>
                    <li><a href="#" data-section="attendance">Attendance</a></li>
                    <li><a href="#" data-section="notifications">Notifications</a></li>
                    <li><a href="#" data-section="reports">Reports</a></li>
                </ul>
            </nav>

            <main class="main-content" id="content-container">
                <!-- Content will be dynamically loaded here -->
            </main>
        </div>

        <footer>
            <p>&copy; 2025 Prince Alex Digital. All rights reserved.</p>
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3>Confirm Action</h3>
            <p id="modal-message">Are you sure you want to perform this action?</p>
            <button id="modal-confirm-btn" class="btn btn-primary">Yes</button>
            <button type="button" class="btn" id="modal-cancel-btn">No</button>
        </div>
    </div>
    
    <!-- Bootstrap & Popper JS for Modals -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" xintegrity="sha384-I7E8Vp9FvY+6u6p7f6y7C8qD+6c7d2A9x5A7P6D9zD1I8p5D5S8W8w8n6y8c8E7B" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" xintegrity="sha384-0+6yB4lE4z5E7o4zD3s6qC5w6a8d6p6l8e7j9z6l6j8k8l7j6p8h7i5o6e5t7j8k" crossorigin="anonymous"></script>
    
    <script type="module">
        // UPGRADED FIREBASE IMPORTS from v9.22.2 to v10.12.2
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, addDoc, deleteDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        // Firebase Configuration and Helper Functions from indexx.html
        const firebaseConfig = {
            apiKey: "AIzaSyC8-TWRr_vOMTv72scXxu-9l5uVHRVputo",
            authDomain: "group-saving-chama.firebaseapp.com",
            projectId: "group-saving-chama",
            storageBucket: "group-saving-chama.appspot.com",
            messagingSenderId: "570981365925",
            appId: "1:570981365925:web:42422e51e4e02c6ab4f54c"
        };

        const appId = "group-saving-chama"; // Consistent with indexx.html

        // Helper to construct public collection paths (for shared data)
        const getPublicCollectionPath = (collectionName) => `artifacts/${appId}/public/data/${collectionName}`;

        // Helper to construct private (user-specific) collection paths
        // Note: For user_profile, the document ID within the 'user_profile' collection is the userId itself.
        const getPrivateCollectionPath = (userId, collectionName) => `artifacts/${appId}/users/${userId}/${collectionName}`;

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const storage = getStorage(app);

        let currentUserId = null; // Variable to hold the authenticated user's ID

        // Global data arrays to aggregate data from all users' subcollections
        let allMembersData = [];
        let allContributionsData = [];
        let allLoansData = [];
        let allFinesData = [];
        let allAttendanceData = [];
        let allNotificationsData = [];

        // Maps for dropdowns and display
        let membersMap = {}; // { userId: "Member Name" }
        let memberIdToEmailMap = {}; // { userId: "member@example.com" }

        // Store unsubscribe functions for private listeners for cleanup
        const privateUnsubscribes = {}; // { userId: [unsubFunc1, unsubFunc2, ...] }


        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard');
            const loginForm = document.getElementById('login-form');
            const contentContainer = document.getElementById('content-container');
            const sidebar = document.querySelector('.sidebar');
            const hamburger = document.querySelector('.hamburger');
            const logoutBtn = document.getElementById('logout-btn');
            const connectionStatusElement = document.getElementById('connection-status');
            const dashboardConnectionStatusElement = document.getElementById('dashboard-connection-status');

            // Function to show connection status
            function showConnectionStatus(message, element) {
                if (element) {
                    element.textContent = message;
                }
            }

            // Function to check admin status
            async function checkAdminStatus(email) {
                try {
                    const adminRef = doc(firestore, "admins", email.toLowerCase());
                    const adminSnap = await getDoc(adminRef);
                    const isAdmin = adminSnap.exists() && adminSnap.data().isAdmin === true;
                    if (!isAdmin) {
                        console.warn(`User ${email} is NOT an admin. Admin-only data will not load.`);
                        showConfirmationModal("You are not authorized to access the admin dashboard.", () => {});
                    }
                    return isAdmin;
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    showConfirmationModal(`Error verifying admin status: ${error.message}`, () => {});
                    return false;
                }
            }

            // Function to initialize all Firestore listeners
            function initFirestoreListeners() {
                initPrivateCollectionListeners(); // Sets up listeners for all users' private data
                initPublicCollectionListeners(); // Sets up listeners for public data
            }

            // Centralized function to set up listeners for all users' private data
            function initPrivateCollectionListeners() {
                const usersRootCollectionRef = collection(firestore, `artifacts/${appId}/users`);

                // Listen for changes in the list of users
                onSnapshot(usersRootCollectionRef, userSnapshot => {
                    const currentUserIds = userSnapshot.docs.map(doc => doc.id);

                    // Identify and unsubscribe from listeners of removed users
                    for (const userId in privateUnsubscribes) {
                        if (!currentUserIds.includes(userId)) {
                            console.log(`Unsubscribing from data for removed user: ${userId}`);
                            privateUnsubscribes[userId].forEach(unsub => unsub()); // Unsubscribe all listeners for this user
                            delete privateUnsubscribes[userId]; // Remove from our tracking object
                            
                            // Clean up data related to this user from global arrays
                            allMembersData = allMembersData.filter(m => m.id !== userId);
                            allContributionsData = allContributionsData.filter(c => c.memberUserId !== userId);
                            allLoansData = allLoansData.filter(l => l.memberUserId !== userId);
                            allFinesData = allFinesData.filter(f => f.memberUserId !== userId);
                            allAttendanceData = allAttendanceData.filter(a => a.memberUserId !== userId);
                            allNotificationsData = allNotificationsData.filter(n => n.memberUserId !== userId);
                        }
                    }

                    // For each current user ID, set up/maintain listeners for their private subcollections
                    currentUserIds.forEach(userId => {
                        // Only set up listeners if they haven't been set for this user yet
                        if (!privateUnsubscribes[userId]) {
                            privateUnsubscribes[userId] = []; // Initialize array for this user's unsubscribes
                            console.log(`Setting up private data listeners for user: ${userId}`);

                            // 1. Listener for user_profile (document is userId within user_profile collection)
                            const userProfileDocRef = doc(firestore, getPrivateCollectionPath(userId, 'user_profile'), userId);
                            privateUnsubscribes[userId].push(onSnapshot(userProfileDocRef, docSnapshot => {
                                const existingIndex = allMembersData.findIndex(member => member.id === userId);
                                if (docSnapshot.exists()) {
                                    const newData = { id: userId, ...docSnapshot.data() };
                                    if (existingIndex > -1) {
                                        allMembersData[existingIndex] = newData; // Update existing
                                    } else {
                                        allMembersData.push(newData); // Add new
                                    }
                                } else if (existingIndex > -1) {
                                    allMembersData.splice(existingIndex, 1); // Remove if profile document no longer exists
                                }
                                renderMembersTable(allMembersData); // Re-render members list
                                renderMemberDropdowns(allMembersData); // Update member select dropdowns
                                updateDashboardOverview(); // Update dashboard overview numbers
                            }, error => console.error(`Error fetching user_profile for ${userId}:`, error)));

                            // 2. Listener for contributions subcollection
                            const contributionsCollectionRef = collection(firestore, getPrivateCollectionPath(userId, 'contributions'));
                            privateUnsubscribes[userId].push(onSnapshot(contributionsCollectionRef, snapshot => {
                                // Remove old contributions for this specific user
                                allContributionsData = allContributionsData.filter(c => c.memberUserId !== userId);
                                // Add new/updated contributions for this user
                                snapshot.forEach(doc => {
                                    allContributionsData.push({ id: doc.id, memberUserId: userId, ...doc.data() });
                                });
                                renderContributionsTable(allContributionsData);
                                updateDashboardOverview(); // Update dashboard overview numbers
                            }, error => console.error(`Error fetching contributions for ${userId}:`, error)));

                            // 3. Listener for loans subcollection
                            const loansCollectionRef = collection(firestore, getPrivateCollectionPath(userId, 'loans'));
                            privateUnsubscribes[userId].push(onSnapshot(loansCollectionRef, snapshot => {
                                allLoansData = allLoansData.filter(l => l.memberUserId !== userId);
                                snapshot.forEach(doc => {
                                    allLoansData.push({ id: doc.id, memberUserId: userId, ...doc.data() });
                                });
                                renderLoansTable(allLoansData);
                                updateDashboardOverview(); // Update dashboard overview numbers
                            }, error => console.error(`Error fetching loans for ${userId}:`, error)));

                            // 4. Listener for fines subcollection
                            const finesCollectionRef = collection(firestore, getPrivateCollectionPath(userId, 'fines'));
                            privateUnsubscribes[userId].push(onSnapshot(finesCollectionRef, snapshot => {
                                allFinesData = allFinesData.filter(f => f.memberUserId !== userId);
                                snapshot.forEach(doc => {
                                    allFinesData.push({ id: doc.id, memberUserId: userId, ...doc.data() });
                                });
                                renderFinesTable(allFinesData);
                                updateDashboardOverview(); // Update dashboard overview numbers
                            }, error => console.error(`Error fetching fines for ${userId}:`, error)));

                            // 5. Listener for attendance subcollection
                            const attendanceCollectionRef = collection(firestore, getPrivateCollectionPath(userId, 'attendance'));
                            privateUnsubscribes[userId].push(onSnapshot(attendanceCollectionRef, snapshot => {
                                allAttendanceData = allAttendanceData.filter(a => a.memberUserId !== userId);
                                snapshot.forEach(doc => {
                                    allAttendanceData.push({ id: doc.id, memberUserId: userId, ...doc.data() });
                                });
                                renderAttendanceTable(allAttendanceData);
                            }, error => console.error(`Error fetching attendance for ${userId}:`, error)));

                            // 6. Listener for notifications subcollection
                            const notificationsCollectionRef = collection(firestore, getPrivateCollectionPath(userId, 'notifications'));
                            privateUnsubscribes[userId].push(onSnapshot(notificationsCollectionRef, snapshot => {
                                allNotificationsData = allNotificationsData.filter(n => n.memberUserId !== userId);
                                snapshot.forEach(doc => {
                                    allNotificationsData.push({ id: doc.id, memberUserId: userId, ...doc.data() });
                                });
                                renderNotificationsTable(allNotificationsData);
                            }, error => console.error(`Error fetching notifications for ${userId}:`, error)));
                        }
                    });
                }, error => console.error("Error listening to artifacts/{appId}/users collection:", error));
            }

            // Initializes listeners for public collections (unchanged)
            function initPublicCollectionListeners() {
                onSnapshot(collection(firestore, getPublicCollectionPath('meetings')), snapshot => { 
                    document.getElementById('meetings-scheduled').textContent = snapshot.size;
                    allMeetingsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMeetingsTable(allMeetingsData);
                }, error => {
                    console.error("Firestore listener error for 'meetings' collection (Dashboard Overview):", error);
                });

                onSnapshot(collection(firestore, getPublicCollectionPath('investments')), snapshot => { 
                    document.getElementById('investment-projects').textContent = snapshot.size;
                    allInvestmentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInvestmentsTable(allInvestmentsData);
                }, error => {
                    console.error("Firestore listener error for 'investments' collection (Dashboard Overview):", error);
                });

                onSnapshot(collection(firestore, getPublicCollectionPath('polls')), snapshot => { 
                    allPollsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderPollsTable(allPollsData);
                }, error => {
                    console.error("Firestore listener error for 'polls' collection (Voting & Polls):", error);
                });

                onSnapshot(collection(firestore, getPublicCollectionPath('documents')), snapshot => { 
                    allDocumentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDocumentsTable(allDocumentsData);
                }, error => {
                    console.error("Firestore listener error for 'documents' collection (Documents Management):", error);
                });
            }

            // Updates the overview cards and charts on the dashboard page
            function updateDashboardOverview() {
                const totalMembers = allMembersData.length;
                document.getElementById('total-members').textContent = totalMembers;
                
                let totalContributions = 0;
                allContributionsData.forEach(c => totalContributions += c.amount || 0);
                document.getElementById('total-contributions').textContent = `Ksh ${totalContributions.toFixed(2)}`;

                let totalLoansIssued = 0;
                let totalLoansRepaid = 0;
                allLoansData.forEach(l => {
                    totalLoansIssued += l.amount || 0;
                    totalLoansRepaid += l.repaidAmount || 0; // Assuming repaidAmount field exists
                });
                document.getElementById('total-loans-issued').textContent = `Ksh ${totalLoansIssued.toFixed(2)}`;
                
                // Simplified funds available calculation (Total Contributions + Fines Paid - Total Loans Issued)
                let totalFinesPaid = allFinesData.filter(f => f.status === 'paid').reduce((sum, f) => sum + (f.amount || 0), 0);
                document.getElementById('funds-available').textContent = `Ksh ${(totalContributions + totalFinesPaid - totalLoansIssued).toFixed(2)}`;
                
                document.getElementById('fines-issued').textContent = allFinesData.length;

                // Contributions Chart
                const monthlyContributions = {}; 
                allContributionsData.forEach(doc => {
                    const date = doc.date ? doc.date.toDate() : new Date(); // Ensure it's a Date object
                    const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    monthlyContributions[monthYear] = (monthlyContributions[monthYear] || 0) + doc.amount;
                });

                const labels = Object.keys(monthlyContributions).sort();
                const data = labels.map(label => monthlyContributions[label]);

                const ctx1 = document.getElementById('contributions-chart');
                if (ctx1) { // Check if canvas element exists
                    const chartInstance = Chart.getChart(ctx1);
                    if (chartInstance) { 
                        chartInstance.destroy(); // Destroy previous chart instance
                    }
                    new Chart(ctx1.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Monthly Contributions',
                                data: data,
                                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--maroon'),
                                backgroundColor: 'rgba(128, 0, 0, 0.2)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Amount (Ksh)' } },
                                x: { title: { display: true, text: 'Month' } }
                            }
                        }
                    });
                }
                
                // Loans Chart
                const ctx2 = document.getElementById('loans-chart');
                if (ctx2) { // Check if canvas element exists
                    const chartInstance = Chart.getChart(ctx2);
                    if (chartInstance) { 
                        chartInstance.destroy(); // Destroy previous chart instance
                    }
                    new Chart(ctx2.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Loans'],
                            datasets: [
                                { label: 'Disbursed', data: [totalLoansIssued], backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--maroon') },
                                { label: 'Repaid', data: [totalLoansRepaid], backgroundColor: '#4CAF50' }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: { y: { beginAtZero: true, title: { display: true, text: 'Amount (Ksh)' } } }
                        }
                    });
                }
            }


            // Authentication State Listener
            onAuthStateChanged(auth, async (user) => {
                showConnectionStatus("Connecting to Firebase...", connectionStatusElement);
                showConnectionStatus("Connecting to Firebase...", dashboardConnectionStatusElement);

                if (user) {
                    showConnectionStatus("Checking admin status...", connectionStatusElement);
                    showConnectionStatus("Checking admin status...", dashboardConnectionStatusElement);
                    currentUserId = user.uid; 
                    const isAdmin = await checkAdminStatus(user.email);

                    if (isAdmin) {
                        // Set persistence to local for consistent login experience
                        await setPersistence(auth, browserLocalPersistence);
                        loginPage.style.display = 'none';
                        dashboardPage.style.display = 'block';
                        showConnectionStatus("Connected (Admin)", connectionStatusElement);
                        showConnectionStatus("Connected (Admin)", dashboardConnectionStatusElement);
                        console.log("Admin logged in:", user.email);
                        renderSection('dashboard-overview'); // Load default section
                        initFirestoreListeners(); // Start all real-time listeners only after admin verification
                    } else {
                        await signOut(auth);
                        showConnectionStatus("Access Denied", connectionStatusElement);
                        showConnectionStatus("Access Denied", dashboardConnectionStatusElement);
                        showConfirmationModal("You are not authorized to access the admin dashboard.", () => {
                            window.location.href = 'http://savingchama.princealex.pro/index.html';
                        });
                    }
                } else {
                    currentUserId = null; 
                    loginPage.style.display = 'block';
                    dashboardPage.style.display = 'none';
                    showConnectionStatus("Not Signed In", connectionStatusElement);
                    showConnectionStatus("Not Signed In", dashboardConnectionStatusElement);
                    console.warn("No user signed in. Real-time listeners not started.");
                }
            });

            // Handle Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm.email.value;
                const password = loginForm.password.value;
                try {
                    // Persistence is handled in onAuthStateChanged
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle UI update and listener initialization
                } catch (error) {
                    document.getElementById('login-error').textContent = error.message;
                    console.error("Login error:", error);
                    showConnectionStatus("Login Error", connectionStatusElement);
                    showConnectionStatus("Login Error", dashboardConnectionStatusElement);
                }
            });

            // Handle Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth); 
                    showConfirmationModal("You have been logged out. Redirecting to the main login page.", () => {
                        window.location.href = 'http://savingchama.princealex.pro/index.html';
                    });
                } catch (error) {
                    console.error("Error signing out:", error);
                    showConfirmationModal("Failed to log out. Please try again.", () => {});
                }
            });

            // Handle Sidebar Navigation
            sidebar.addEventListener('click', (e) => {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    document.querySelector('.sidebar a.active')?.classList.remove('active');
                    e.target.classList.add('active');
                    const section = e.target.dataset.section;
                    renderSection(section);
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                }
            });

            // Hamburger Menu Toggle
            hamburger.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Dynamic Content Rendering Function
            function renderSection(sectionName) {
                contentContainer.innerHTML = ''; // Clear previous content
                switch (sectionName) {
                    case 'dashboard-overview':
                        renderDashboardOverview();
                        break;
                    case 'members-management':
                        renderMembersManagement();
                        break;
                    case 'contributions-management':
                        renderContributionsManagement();
                        break;
                    case 'loan-management':
                        renderLoanManagement();
                        break;
                    case 'meetings-notices':
                        renderMeetingsNotices();
                        break;
                    case 'fines-penalties':
                        renderFinesPenalties();
                        break;
                    case 'investments':
                        renderInvestments();
                        break;
                    case 'voting-polls':
                        renderVotingPolls();
                        break;
                    case 'documents-management':
                        renderDocumentsManagement();
                        break;
                    case 'attendance':
                        renderAttendance();
                        break;
                    case 'notifications':
                        renderNotifications();
                        break;
                    case 'reports':
                        renderReports();
                        break;
                    default:
                        contentContainer.innerHTML = `<h2>${sectionName.replace('-', ' ').toUpperCase()}</h2><p>Content for ${sectionName} will be loaded here.</p>`;
                }
            }
            
            // --- SECTION-SPECIFIC RENDERING FUNCTIONS ---
            
            async function renderDashboardOverview() {
                contentContainer.innerHTML = `
                    <h2>Dashboard Overview</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Total Members</h3>
                            <p id="total-members" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Total Contributions</h3>
                            <p id="total-contributions" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Total Loans Issued</h3>
                            <p id="total-loans-issued" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Funds Available</h3>
                            <p id="funds-available" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Meetings Scheduled</h3>
                            <p id="meetings-scheduled" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Fines Issued</h3>
                            <p id="fines-issued" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Investment Projects</h3>
                            <p id="investment-projects" style="font-size: 2em; font-weight: bold; color: var(--maroon);">...</p>
                        </div>
                    </div>
                    <div class="charts-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Contributions Trend</h3>
                            <canvas id="contributions-chart"></canvas>
                        </div>
                        <div style="background-color: var(--white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <h3>Loan Disbursement vs Repayment</h3>
                            <canvas id="loans-chart"></canvas>
                        </div>
                    </div>`;
                
                // Update the dashboard overview using the globally collected data
                updateDashboardOverview();
            }
            
            async function renderMembersManagement() {
                contentContainer.innerHTML = `
                    <h2>Members Management</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="member-search" placeholder="Search by name or email..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" id="add-member-btn">Add New Member</button>
                        <button class="btn btn-primary" id="bulk-approve-btn">Bulk Approve</button>
                        <button class="btn btn-primary" id="bulk-deactivate-btn">Bulk Deactivate</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-members"></th>
                                <th>Name <span data-sort="name" class="sort-icon">⬆⬇</span></th>
                                <th>Email <span data-sort="email" class="sort-icon">⬆⬇</span></th>
                                <th>Status <span data-sort="status" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="members-list">
                            <!-- Members will be loaded here -->
                        </tbody>
                    </table>
                    <div id="member-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Add/Edit Member</h3>
                            <form id="member-form">
                                <input type="hidden" id="member-id">
                                <div class="form-group">
                                    <label for="member-name">Name</label>
                                    <input type="text" id="member-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="member-email">Email</label>
                                    <input type="email" id="member-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="member-status">Status</label>
                                    <select id="member-status">
                                        <option value="pending">Pending</option>
                                        <option value="active">Active</option>
                                        <option value="deactivated">Deactivated</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="member-profile-pic">Profile Picture</label>
                                    <input type="file" id="member-profile-pic" accept="image/*">
                                    <img id="current-profile-pic" src="" alt="Profile Pic" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-top: 10px; display: none;">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Member</button>
                                <button type="button" class="btn" id="cancel-member-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const membersList = document.getElementById('members-list');
                const memberSearchInput = document.getElementById('member-search');
                const addMemberBtn = document.getElementById('add-member-btn');
                const memberFormModal = document.getElementById('member-form-modal');
                const memberForm = document.getElementById('member-form');
                const cancelMemberFormBtn = document.getElementById('cancel-member-form');
                const selectAllMembersCheckbox = document.getElementById('select-all-members');
                const bulkApproveBtn = document.getElementById('bulk-approve-btn');
                const bulkDeactivateBtn = document.getElementById('bulk-deactivate-btn');
                
                // Initial render of members table from the global data
                renderMembersTable(allMembersData);

                const renderMembersTable = (membersToDisplay) => {
                    membersList.innerHTML = '';
                    membersToDisplay.forEach(member => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="checkbox" class="member-checkbox" data-id="${member.id}"></td>
                            <td>${member.name}</td>
                            <td>${member.email}</td>
                            <td>${member.status}</td>
                            <td>
                                <button class="btn btn-primary edit-member-btn" data-id="${member.id}">Edit</button>
                                <button class="btn" data-action="approve" data-id="${member.id}" style="background-color: #28a745; color: white;">Approve</button>
                                <button class="btn" data-action="deactivate" data-id="${member.id}" style="background-color: #dc3545; color: white;">Deactivate</button>
                                <button class="btn delete-member-btn" data-id="${member.id}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        membersList.appendChild(tr);
                    });
                };

                // Search functionality
                memberSearchInput.addEventListener('keyup', () => {
                    const searchTerm = memberSearchInput.value.toLowerCase();
                    const filteredMembers = allMembersData.filter(member => 
                        (member.name || '').toLowerCase().includes(searchTerm) || 
                        (member.email || '').toLowerCase().includes(searchTerm)
                    );
                    renderMembersTable(filteredMembers);
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedMembers = [...allMembersData].sort((a, b) => {
                            const valA = a[sortBy] || '';
                            const valB = b[sortBy] || '';
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allMembersData as it's updated by onSnapshot.
                        // Instead, just render the sorted copy.
                        renderMembersTable(sortedMembers);
                    });
                });

                // Add/Edit Member Form
                addMemberBtn.addEventListener('click', () => {
                    memberForm.reset();
                    document.getElementById('member-id').value = ''; // Clear for new member
                    document.getElementById('current-profile-pic').style.display = 'none';
                    document.getElementById('current-profile-pic').src = ''; // Clear image src
                    memberFormModal.style.display = 'flex';
                });

                cancelMemberFormBtn.addEventListener('click', () => {
                    memberFormModal.style.display = 'none';
                });

                membersList.addEventListener('click', async (e) => { 
                    if (e.target.classList.contains('edit-member-btn')) {
                        const memberId = e.target.dataset.id;
                        // Path: artifacts/{appId}/users/{userId}/user_profile/{userId}
                        const docSnapshot = await getDoc(doc(firestore, getPrivateCollectionPath(memberId, 'user_profile'), memberId)); 
                        if (docSnapshot.exists()) {
                            const member = docSnapshot.data();
                            document.getElementById('member-id').value = docSnapshot.id;
                            document.getElementById('member-name').value = member.name || '';
                            document.getElementById('member-email').value = member.email || '';
                            document.getElementById('member-status').value = member.status || 'pending';
                            const profilePicElement = document.getElementById('current-profile-pic');
                            if (member.profilePicUrl) {
                                profilePicElement.src = member.profilePicUrl;
                                profilePicElement.style.display = 'block';
                            } else {
                                profilePicElement.style.display = 'none';
                                profilePicElement.src = '';
                            }
                            memberFormModal.style.display = 'flex';
                        } else {
                            console.error(`Member document not found for ID: ${memberId}`);
                            showConfirmationModal('Member record not found.', () => {});
                        }
                    }
                    if (e.target.dataset.action === 'approve' || e.target.dataset.action === 'deactivate') {
                        const memberId = e.target.dataset.id;
                        const newStatus = e.target.dataset.action === 'approve' ? 'approved' : 'deactivated'; // Consistent with indexx.html: 'approved' not 'active'
                        showConfirmationModal(`Are you sure you want to ${newStatus} this member?`, async () => {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/user_profile/{userId}
                                await updateDoc(doc(firestore, getPrivateCollectionPath(memberId, 'user_profile'), memberId), { status: newStatus }); 
                            } catch (error) {
                                console.error(`Error updating status for member ${memberId}:`, error);
                                showConfirmationModal(`Failed to update member status: ${error.message}`, () => {});
                            }
                        });
                    }
                    if (e.target.classList.contains('delete-member-btn')) {
                        const memberId = e.target.dataset.id;
                        showConfirmationModal('Are you sure you want to delete this member permanently? This will delete all their associated data!', async () => {
                            try {
                                // Delete profile document
                                await deleteDoc(doc(firestore, getPrivateCollectionPath(memberId, 'user_profile'), memberId)); 

                                // Optionally, delete all subcollections for the user.
                                // This requires fetching all documents in each subcollection and deleting them.
                                // For simplicity and avoiding complex batch writes, we might leave subcollections
                                // if the user is not actively deleted from Firebase Auth.
                                // If full data cleanup is required, you'd iterate and delete each doc:
                                const collectionsToDelete = ['contributions', 'loans', 'fines', 'attendance', 'notifications'];
                                for (const collectionName of collectionsToDelete) {
                                    const q = query(collection(firestore, getPrivateCollectionPath(memberId, collectionName)));
                                    const snapshot = await getDocs(q);
                                    snapshot.forEach(async (docToDelete) => {
                                        await deleteDoc(doc(firestore, getPrivateCollectionPath(memberId, collectionName), docToDelete.id));
                                    });
                                }
                                showConfirmationModal(`Member ${memberId} and their data deleted successfully.`, () => {});
                            } catch (error) {
                                console.error("Error deleting member:", error);
                                showConfirmationModal(`Failed to delete member: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                memberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    let memberId = document.getElementById('member-id').value; // Existing memberId or empty for new
                    const name = document.getElementById('member-name').value;
                    const email = document.getElementById('member-email').value;
                    const status = document.getElementById('member-status').value;
                    const profilePicFile = document.getElementById('member-profile-pic').files[0];
                    
                    let profilePicUrl = document.getElementById('current-profile-pic').src; 

                    if (!memberId) {
                        // For a NEW member added via admin, generate a UUID for the userId (doc ID)
                        memberId = `admin-gen-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; 
                    }

                    if (profilePicFile) {
                        const storageRefPath = `profile_pictures/${memberId}-${profilePicFile.name}`; 
                        const fileRef = ref(storage, storageRefPath); 
                        await uploadBytes(fileRef, profilePicFile); 
                        profilePicUrl = await getDownloadURL(fileRef); 
                    }

                    const memberData = { 
                        name: name, 
                        email: email, 
                        status: status, 
                        profilePicUrl: profilePicUrl,
                        // Add other default fields for consistency with indexx.html's user profile creation
                        phone: "", 
                        nationalId: "",
                        contribution_balance: 0,
                        loan_balance: 0,
                        next_meeting_date: "To be announced",
                        createdAt: serverTimestamp() // Only set if creating, not updating
                    };

                    try {
                        const memberDocRef = doc(firestore, getPrivateCollectionPath(memberId, 'user_profile'), memberId);
                        const docSnapshot = await getDoc(memberDocRef);

                        if (docSnapshot.exists()) {
                            // Update existing member
                            await updateDoc(memberDocRef, memberData); 
                            showConfirmationModal("Member updated successfully!", () => {});
                        } else {
                            // Add new member (with their generated ID as document ID)
                            await setDoc(memberDocRef, memberData); 
                            showConfirmationModal("New member added successfully!", () => {});
                        }
                        memberFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving member:", error);
                        showConfirmationModal(`Failed to save member: ${error.message}`, () => {});
                    }
                });

                // Bulk Actions
                selectAllMembersCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.member-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });

                const getSelectedMemberIds = () => {
                    const selectedIds = [];
                    document.querySelectorAll('.member-checkbox:checked').forEach(checkbox => {
                        if (checkbox.id !== 'select-all-members') { 
                            selectedIds.push(checkbox.dataset.id);
                        }
                    });
                    return selectedIds;
                };

                bulkApproveBtn.addEventListener('click', () => {
                    const selectedIds = getSelectedMemberIds();
                    if (selectedIds.length === 0) {
                        showConfirmationModal('No members selected for bulk approval.', () => {});
                        return;
                    }
                    showConfirmationModal(`Approve ${selectedIds.length} members?`, async () => {
                        for (const id of selectedIds) {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/user_profile/{userId}
                                await updateDoc(doc(firestore, getPrivateCollectionPath(id, 'user_profile'), id), { status: 'approved' }); 
                            } catch (error) {
                                console.error(`Error bulk approving member ${id}:`, error);
                                showConfirmationModal(`Failed to approve member ${id}: ${error.message}`, () => {});
                            }
                        }
                        showConfirmationModal(`Successfully approved ${selectedIds.length} members.`, () => {});
                    });
                });

                bulkDeactivateBtn.addEventListener('click', () => {
                    const selectedIds = getSelectedMemberIds();
                    if (selectedIds.length === 0) {
                        showConfirmationModal('No members selected for bulk deactivation.', () => {});
                        return;
                    }
                    showConfirmationModal(`Deactivate ${selectedIds.length} members?`, async () => {
                        for (const id of selectedIds) {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/user_profile/{userId}
                                await updateDoc(doc(firestore, getPrivateCollectionPath(id, 'user_profile'), id), { status: 'deactivated' }); 
                            } catch (error) {
                                console.error(`Error bulk deactivating member ${id}:`, error);
                                showConfirmationModal(`Failed to deactivate member ${id}: ${error.message}`, () => {});
                            }
                        }
                        showConfirmationModal(`Successfully deactivated ${selectedIds.length} members.`, () => {});
                    });
                });
            }

            async function renderContributionsManagement() {
                contentContainer.innerHTML = `
                    <h2>Contributions Management</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="contribution-search" placeholder="Search by member or date..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <input type="date" id="contribution-date-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" id="add-contribution-btn">Add New Contribution</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Member Name <span data-sort="memberName" class="sort-icon">⬆⬇</span></th>
                                <th>Amount <span data-sort="amount" class="sort-icon">⬆⬇</span></th>
                                <th>Date <span data-sort="date" class="sort-icon">⬆⬇</span></th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contributions-list">
                            <!-- Contributions will be loaded here -->
                        </tbody>
                    </table>
                    <div id="contribution-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Add/Edit Contribution</h3>
                            <form id="contribution-form">
                                <input type="hidden" id="contribution-id">
                                <div class="form-group">
                                    <label for="contribution-member-id">Member (Select Member)</label>
                                    <select id="contribution-member-id" required></select>
                                </div>
                                <div class="form-group">
                                    <label for="contribution-amount">Amount</label>
                                    <input type="number" id="contribution-amount" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="contribution-date">Date</label>
                                    <input type="date" id="contribution-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="contribution-description">Description</label>
                                    <textarea id="contribution-description"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Contribution</button>
                                <button type="button" class="btn" id="cancel-contribution-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;

                const contributionsList = document.getElementById('contributions-list');
                const contributionSearchInput = document.getElementById('contribution-search');
                const contributionDateFilter = document.getElementById('contribution-date-filter');
                const addContributionBtn = document.getElementById('add-contribution-btn');
                const contributionFormModal = document.getElementById('contribution-form-modal');
                const contributionForm = document.getElementById('contribution-form');
                const cancelContributionFormBtn = document.getElementById('cancel-contribution-form');
                const contributionMemberSelect = document.getElementById('contribution-member-id');
                
                // Initial render and dropdown population
                renderContributionsTable(allContributionsData);
                renderMemberDropdowns(allMembersData); // Populate the member select

                const renderContributionsTable = (contributionsToDisplay) => {
                    contributionsList.innerHTML = '';
                    contributionsToDisplay.forEach(contribution => {
                        const tr = document.createElement('tr');
                        const memberName = membersMap[contribution.memberUserId] || 'Unknown Member'; // Use memberUserId from data
                        const date = contribution.date ? new Date(contribution.date.seconds * 1000).toLocaleDateString() : 'N/A';
                        tr.innerHTML = `
                            <td>${memberName}</td>
                            <td>Ksh ${contribution.amount.toFixed(2)}</td>
                            <td>${date}</td>
                            <td>${contribution.description || ''}</td>
                            <td>
                                <button class="btn btn-primary edit-contribution-btn" data-id="${contribution.id}" data-member-id="${contribution.memberUserId}">Edit</button>
                                <button class="btn delete-contribution-btn" data-id="${contribution.id}" data-member-id="${contribution.memberUserId}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        contributionsList.appendChild(tr);
                    });
                };

                // Search and Filter
                const applyFilters = () => {
                    let filtered = [...allContributionsData];
                    const searchTerm = contributionSearchInput.value.toLowerCase();
                    const filterDate = contributionDateFilter.value;

                    if (searchTerm) {
                        filtered = filtered.filter(c => 
                            (membersMap[c.memberUserId] || 'Unknown Member').toLowerCase().includes(searchTerm) || // Use memberUserId
                            (c.description || '').toLowerCase().includes(searchTerm)
                        );
                    }
                    if (filterDate) {
                        filtered = filtered.filter(c => {
                            const cDate = c.date ? new Date(c.date.seconds * 1000).toISOString().split('T')[0] : '';
                            return cDate === filterDate;
                        });
                    }
                    renderContributionsTable(filtered);
                };

                contributionSearchInput.addEventListener('keyup', applyFilters);
                contributionDateFilter.addEventListener('change', applyFilters);

                // Add/Edit Contribution
                addContributionBtn.addEventListener('click', () => {
                    contributionForm.reset();
                    document.getElementById('contribution-id').value = '';
                    contributionMemberSelect.value = ''; 
                    contributionFormModal.style.display = 'flex';
                });

                cancelContributionFormBtn.addEventListener('click', () => {
                    contributionFormModal.style.display = 'none';
                });

                contributionsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit-contribution-btn')) {
                        const contributionId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId; // Get memberUserId
                        // Path: artifacts/{appId}/users/{userId}/contributions/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'contributions'), contributionId)); 
                        if (docSnapshot.exists()) {
                            const contribution = docSnapshot.data();
                            document.getElementById('contribution-id').value = docSnapshot.id;
                            document.getElementById('contribution-member-id').value = memberUserId; // Set memberUserId
                            document.getElementById('contribution-amount').value = contribution.amount;
                            document.getElementById('contribution-date').value = contribution.date ? new Date(contribution.date.seconds * 1000).toISOString().split('T')[0] : '';
                            document.getElementById('contribution-description').value = contribution.description || '';
                            contributionFormModal.style.display = 'flex';
                        } else {
                            console.error(`Contribution document not found for ID: ${contributionId}, Member: ${memberUserId}`);
                            showConfirmationModal('Contribution record not found.', () => {});
                        }
                    }
                    if (e.target.classList.contains('delete-contribution-btn')) {
                        const contributionId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId; // Get memberUserId
                        showConfirmationModal('Are you sure you want to delete this contribution?', async () => {
                            try {
                                // Get the contribution amount before deleting to adjust balance
                                const contributionDoc = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'contributions'), contributionId));
                                let deletedAmount = 0;
                                if (contributionDoc.exists()) {
                                    deletedAmount = contributionDoc.data().amount || 0;
                                }

                                // Path: artifacts/{appId}/users/{userId}/contributions/{docId}
                                await deleteDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'contributions'), contributionId)); 
                                
                                // Update user's contribution balance
                                // Path: artifacts/{appId}/users/{userId}/user_profile/{userId}
                                const userProfileRef = doc(firestore, getPrivateCollectionPath(memberUserId, 'user_profile'), memberUserId);
                                const userProfileSnap = await getDoc(userProfileRef);
                                if (userProfileSnap.exists()) {
                                    const currentContributionBalance = userProfileSnap.data().contribution_balance || 0;
                                    await updateDoc(userProfileRef, {
                                        contribution_balance: currentContributionBalance - deletedAmount
                                    });
                                } else {
                                    console.warn(`User profile not found for ${memberUserId}. Cannot update contribution_balance after deletion.`);
                                }
                                showConfirmationModal('Contribution deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting contribution:", error);
                                showConfirmationModal(`Failed to delete contribution: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                contributionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const contributionId = document.getElementById('contribution-id').value;
                    const memberUserId = document.getElementById('contribution-member-id').value; 

                    if (!memberUserId) {
                        showConfirmationModal('Please select a valid member.', () => {});
                        return;
                    }

                    const amount = parseFloat(document.getElementById('contribution-amount').value);
                    const date = new Date(document.getElementById('contribution-date').value);
                    const description = document.getElementById('contribution-description').value;

                    const contributionData = {
                        memberId: memberUserId, // Store the userId here
                        amount: amount,
                        date: new Date(date), 
                        description: description,
                        timestamp: serverTimestamp()
                    };

                    try {
                        let oldAmount = 0;
                        // Path: artifacts/{appId}/users/{userId}/contributions/{docId}
                        if (contributionId) {
                            const oldContributionDoc = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'contributions'), contributionId));
                            oldAmount = oldContributionDoc.exists() ? oldContributionDoc.data().amount || 0 : 0;
                            await updateDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'contributions'), contributionId), contributionData); 
                        } else {
                            await addDoc(collection(firestore, getPrivateCollectionPath(memberUserId, 'contributions')), contributionData); 
                        }
                        
                        // Update user's contribution balance
                        // Path: artifacts/{appId}/users/{userId}/user_profile/{userId}
                        const userProfileRef = doc(firestore, getPrivateCollectionPath(memberUserId, 'user_profile'), memberUserId);
                        const userProfileSnap = await getDoc(userProfileRef);
                        if (userProfileSnap.exists()) {
                            const currentContributionBalance = userProfileSnap.data().contribution_balance || 0;
                            const balanceChange = amount - oldAmount;
                            await updateDoc(userProfileRef, {
                                contribution_balance: currentContributionBalance + balanceChange
                            });
                        } else {
                            console.warn(`User profile not found for ${memberUserId}. Cannot update contribution_balance.`);
                        }

                        showConfirmationModal('Contribution saved successfully!', () => {});
                        contributionFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving contribution:", error);
                        showConfirmationModal(`Failed to save contribution: ${error.message}`, () => {});
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedContributions = [...allContributionsData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'date') { 
                                valA = a.date ? a.date.toMillis() : 0;
                                valB = b.date ? b.date.toMillis() : 0;
                            } else if (sortBy === 'memberName') { 
                                valA = membersMap[a.memberUserId] || 'Unknown'; // Use memberUserId
                                valB = membersMap[b.memberUserId] || 'Unknown'; // Use memberUserId
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allContributionsData.
                        renderContributionsTable(sortedContributions);
                    });
                });
            }
            
            async function renderLoanManagement() {
                contentContainer.innerHTML = `
                    <h2>Loan Management</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="loan-search" placeholder="Search by member or status..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <select id="loan-status-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="repaid">Repaid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                        <button class="btn btn-primary" id="add-loan-btn">Add New Loan</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Member Name <span data-sort="memberName" class="sort-icon">⬆⬇</span></th>
                                <th>Amount <span data-sort="amount" class="sort-icon">⬆⬇</span></th>
                                <th>Interest <span data-sort="interestRate" class="sort-icon">⬆⬇</span></th>
                                <th>Due Date <span data-sort="dueDate" class="sort-icon">⬆⬇</span></th>
                                <th>Status <span data-sort="status" class="sort-icon">⬆⬇</span></th>
                                <th>Repaid Amount <span data-sort="repaidAmount" class="sort-icon">⬆⬇</span></th>
                                <th>Balance <span data-sort="balance" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loans-list">
                            <!-- Loans will be loaded here -->
                        </tbody>
                    </table>
                    <div id="loan-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Add/Edit Loan</h3>
                            <form id="loan-form">
                                <input type="hidden" id="loan-id">
                                <div class="form-group">
                                    <label for="loan-member-id">Member (Select Member)</label>
                                    <select id="loan-member-id" required></select>
                                </div>
                                <div class="form-group">
                                    <label for="loan-amount">Amount</label>
                                    <input type="number" id="loan-amount" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="loan-interest-rate">Interest Rate (%)</label>
                                    <input type="number" id="loan-interest-rate" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="loan-due-date">Due Date</label>
                                    <input type="date" id="loan-due-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="loan-status">Status</label>
                                    <select id="loan-status">
                                        <option value="pending">Pending</option>
                                        <option value="approved">Approved</option>
                                        <option value="repaid">Repaid</option>
                                        <option value="overdue">Overdue</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="loan-repaid-amount">Repaid Amount</label>
                                    <input type="number" id="loan-repaid-amount" step="0.01">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Loan</button>
                                <button type="button" class="btn" id="cancel-loan-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const loansList = document.getElementById('loans-list');
                const loanSearchInput = document.getElementById('loan-search');
                const loanStatusFilter = document.getElementById('loan-status-filter');
                const addLoanBtn = document.getElementById('add-loan-btn');
                const loanFormModal = document.getElementById('loan-form-modal');
                const loanForm = document.getElementById('loan-form');
                const cancelLoanFormBtn = document.getElementById('cancel-loan-form');
                const loanMemberSelect = document.getElementById('loan-member-id');
                
                // Initial render and dropdown population
                renderLoansTable(allLoansData);
                renderMemberDropdowns(allMembersData); // Populate the member select

                const renderLoansTable = (loansToDisplay) => {
                    loansList.innerHTML = '';
                    loansToDisplay.forEach(loan => {
                        const tr = document.createElement('tr');
                        const memberName = membersMap[loan.memberUserId] || 'Unknown Member'; // Use memberUserId from data
                        const dueDate = loan.dueDate ? new Date(loan.dueDate.seconds * 1000).toLocaleDateString() : 'N/A';
                        const balance = (loan.amount * (1 + (loan.interestRate / 100))) - (loan.repaidAmount || 0); // Calculate balance based on current data

                        tr.innerHTML = `
                            <td>${memberName}</td>
                            <td>Ksh ${loan.amount.toFixed(2)}</td>
                            <td>${loan.interestRate}%</td>
                            <td>${dueDate}</td>
                            <td>${loan.status}</td>
                            <td>Ksh ${(loan.repaidAmount || 0).toFixed(2)}</td>
                            <td>Ksh ${balance.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-primary edit-loan-btn" data-id="${loan.id}" data-member-id="${loan.memberUserId}">Edit</button>
                                <button class="btn" data-action="mark-repaid" data-id="${loan.id}" data-member-id="${loan.memberUserId}" style="background-color: #28a745; color: white;">Mark Repaid</button>
                                <button class="btn delete-loan-btn" data-id="${loan.id}" data-member-id="${loan.memberUserId}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        loansList.appendChild(tr);
                    });
                };

                // Search and Filter
                const applyFilters = () => {
                    let filtered = [...allLoansData];
                    const searchTerm = loanSearchInput.value.toLowerCase();
                    const filterStatus = loanStatusFilter.value;

                    if (searchTerm) {
                        filtered = filtered.filter(l => 
                            (membersMap[l.memberUserId] || 'Unknown Member').toLowerCase().includes(searchTerm) || // Use memberUserId
                            (l.status || '').toLowerCase().includes(searchTerm)
                        );
                    }
                    if (filterStatus) {
                        filtered = filtered.filter(l => l.status === filterStatus);
                    }
                    renderLoansTable(filtered);
                };

                loanSearchInput.addEventListener('keyup', applyFilters);
                loanStatusFilter.addEventListener('change', applyFilters);

                // Add/Edit Loan
                addLoanBtn.addEventListener('click', () => {
                    loanForm.reset();
                    document.getElementById('loan-id').value = '';
                    loanMemberSelect.value = ''; 
                    loanFormModal.style.display = 'flex';
                });

                cancelLoanFormBtn.addEventListener('click', () => {
                    loanFormModal.style.display = 'none';
                });

                loansList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit-loan-btn')) {
                        const loanId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        // Path: artifacts/{appId}/users/{userId}/loans/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'loans'), loanId)); 
                        if (docSnapshot.exists()) {
                            const loan = docSnapshot.data();
                            document.getElementById('loan-id').value = docSnapshot.id;
                            document.getElementById('loan-member-id').value = memberUserId;
                            document.getElementById('loan-amount').value = loan.amount;
                            document.getElementById('loan-interest-rate').value = loan.interestRate;
                            document.getElementById('loan-due-date').value = loan.dueDate ? new Date(loan.dueDate.seconds * 1000).toISOString().split('T')[0] : '';
                            document.getElementById('loan-status').value = loan.status;
                            document.getElementById('loan-repaid-amount').value = loan.repaidAmount || 0;
                            loanFormModal.style.display = 'flex';
                        } else {
                            console.error(`Loan document not found for ID: ${loanId}, Member: ${memberUserId}`);
                            showConfirmationModal('Loan record not found.', () => {});
                        }
                    }
                    if (e.target.dataset.action === 'mark-repaid') {
                        const loanId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        showConfirmationModal('Mark this loan as fully repaid?', async () => {
                            const docRef = doc(firestore, getPrivateCollectionPath(memberUserId, 'loans'), loanId);
                            const docSnapshot = await getDoc(docRef); 
                            if (docSnapshot.exists()) {
                                const loan = docSnapshot.data();
                                const updatedRepaidAmount = loan.amount * (1 + (loan.interestRate || 0) / 100); // Calculate total amount due
                                try {
                                    await updateDoc(docRef, { status: 'repaid', repaidAmount: updatedRepaidAmount }); 

                                    // Update user's loan balance in their profile
                                    const userProfileRef = doc(firestore, getPrivateCollectionPath(memberUserId, 'user_profile'), memberUserId);
                                    const userProfileSnap = await getDoc(userProfileRef);
                                    if (userProfileSnap.exists()) {
                                        const currentLoanBalance = userProfileSnap.data().loan_balance || 0;
                                        // Subtract the full amount of this loan from user's balance
                                        await updateDoc(userProfileRef, {
                                            loan_balance: currentLoanBalance - (loan.amount * (1 + (loan.interestRate || 0) / 100))
                                        });
                                    } else {
                                        console.warn(`User profile not found for ${memberUserId}. Cannot update loan_balance.`);
                                    }
                                    showConfirmationModal('Loan marked as repaid successfully!', () => {});
                                } catch (error) {
                                    console.error("Error marking loan repaid:", error);
                                    showConfirmationModal(`Failed to mark loan repaid: ${error.message}`, () => {});
                                }
                            } else {
                                console.error(`Loan document not found for ID: ${loanId}, Member: ${memberUserId}`);
                                showConfirmationModal('Loan record not found.', () => {});
                            }
                        });
                    }
                    if (e.target.classList.contains('delete-loan-btn')) {
                        const loanId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        showConfirmationModal('Are you sure you want to delete this loan record?', async () => {
                            try {
                                // Get loan details before deleting to adjust balance
                                const loanDoc = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'loans'), loanId));
                                let deletedLoanAmount = 0;
                                let deletedRepaidAmount = 0;
                                let deletedInterestRate = 0;
                                if (loanDoc.exists()) {
                                    const loanData = loanDoc.data();
                                    deletedLoanAmount = loanData.amount || 0;
                                    deletedRepaidAmount = loanData.repaidAmount || 0;
                                    deletedInterestRate = loanData.interestRate || 0;
                                }

                                await deleteDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'loans'), loanId)); 
                                
                                // Adjust user's loan balance in their profile
                                const userProfileRef = doc(firestore, getPrivateCollectionPath(memberUserId, 'user_profile'), memberUserId);
                                const userProfileSnap = await getDoc(userProfileRef);
                                if (userProfileSnap.exists()) {
                                    const currentLoanBalance = userProfileSnap.data().loan_balance || 0;
                                    const amountToDeduct = (deletedLoanAmount * (1 + deletedInterestRate / 100)) - deletedRepaidAmount;
                                    await updateDoc(userProfileRef, {
                                        loan_balance: currentLoanBalance - amountToDeduct
                                    });
                                } else {
                                    console.warn(`User profile not found for ${memberUserId}. Cannot update loan_balance after deletion.`);
                                }
                                showConfirmationModal('Loan record deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting loan:", error);
                                showConfirmationModal(`Failed to delete loan: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                loanForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const loanId = document.getElementById('loan-id').value;
                    const memberUserId = document.getElementById('loan-member-id').value;

                    if (!memberUserId) {
                        showConfirmationModal('Please select a valid member.', () => {});
                        return;
                    }

                    const amount = parseFloat(document.getElementById('loan-amount').value);
                    const interestRate = parseFloat(document.getElementById('loan-interest-rate').value);
                    const dueDate = new Date(document.getElementById('loan-due-date').value);
                    const status = document.getElementById('loan-status').value;
                    const repaidAmount = parseFloat(document.getElementById('loan-repaid-amount').value) || 0;

                    const loanData = {
                        memberId: memberUserId,
                        amount: amount,
                        interestRate: interestRate,
                        dueDate: new Date(dueDate), 
                        status: status,
                        repaidAmount: repaidAmount,
                        timestamp: serverTimestamp()
                    };

                    try {
                        const userProfileRef = doc(firestore, getPrivateCollectionPath(memberUserId, 'user_profile'), memberUserId);
                        const userProfileSnap = await getDoc(userProfileRef);
                        let currentLoanBalance = userProfileSnap.exists() ? userProfileSnap.data().loan_balance || 0 : 0;
                        
                        if (loanId) {
                            // Update existing loan
                            const oldLoanDoc = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'loans'), loanId));
                            let oldLoanAmount = 0;
                            let oldRepaidAmount = 0;
                            let oldInterestRate = 0;
                            if (oldLoanDoc.exists()) {
                                oldLoanAmount = oldLoanDoc.data().amount || 0;
                                oldRepaidAmount = oldLoanDoc.data().repaidAmount || 0;
                                oldInterestRate = oldLoanDoc.data().interestRate || 0;
                            }
                            await updateDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'loans'), loanId), loanData); 
                            
                            // Adjust user's loan balance
                            const oldOutstanding = (oldLoanAmount * (1 + oldInterestRate / 100)) - oldRepaidAmount;
                            const newOutstanding = (amount * (1 + interestRate / 100)) - repaidAmount;
                            await updateDoc(userProfileRef, {
                                loan_balance: currentLoanBalance - oldOutstanding + newOutstanding
                            });
                        } else {
                            // Add new loan
                            await addDoc(collection(firestore, getPrivateCollectionPath(memberUserId, 'loans')), loanData); 
                            // Add new loan's outstanding to user's balance
                            const newOutstanding = (amount * (1 + interestRate / 100)) - repaidAmount;
                            await updateDoc(userProfileRef, {
                                loan_balance: currentLoanBalance + newOutstanding
                            });
                        }
                        showConfirmationModal('Loan saved successfully!', () => {});
                        loanFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving loan:", error);
                        showConfirmationModal(`Failed to save loan: ${error.message}`, () => {});
                    }
                });
                // Sorting functionality (similar to members/contributions)
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedLoans = [...allLoansData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'dueDate') { 
                                valA = a.dueDate ? a.dueDate.toMillis() : 0;
                                valB = b.dueDate ? b.dueDate.toMillis() : 0;
                            } else if (sortBy === 'memberName') { 
                                valA = membersMap[a.memberUserId] || 'Unknown'; // Use memberUserId
                                valB = membersMap[b.memberUserId] || 'Unknown'; // Use memberUserId
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allLoansData.
                        renderLoansTable(sortedLoans);
                    });
                });
            }

            async function renderMeetingsNotices() {
                contentContainer.innerHTML = `
                    <h2>Meetings & Notices</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="meeting-search" placeholder="Search by title or date..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" id="add-meeting-btn">Add New Meeting/Notice</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title <span data-sort="title" class="sort-icon">⬆⬇</span></th>
                                <th>Date <span data-sort="date" class="sort-icon">⬆⬇</span></th>
                                <th>Time</th>
                                <th>Location</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="meetings-list">
                            <!-- Meetings/Notices will be loaded here -->
                        </tbody>
                    </table>
                    <div id="meeting-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Add/Edit Meeting/Notice</h3>
                            <form id="meeting-form">
                                <input type="hidden" id="meeting-id">
                                <div class="form-group">
                                    <label for="meeting-title">Title</label>
                                    <input type="text" id="meeting-title" required>
                                </div>
                                <div class="form-group">
                                    <label for="meeting-date">Date</label>
                                    <input type="date" id="meeting-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="meeting-time">Time</label>
                                    <input type="time" id="meeting-time">
                                </div>
                                <div class="form-group">
                                    <label for="meeting-location">Location</label>
                                    <input type="text" id="meeting-location">
                                </div>
                                <div class="form-group">
                                    <label for="meeting-description">Description</label>
                                    <textarea id="meeting-description"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="meeting-type">Type</label>
                                    <select id="meeting-type">
                                        <option value="meeting">Meeting</option>
                                        <option value="notice">Notice</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Meeting/Notice</button>
                                <button type="button" class="btn" id="cancel-meeting-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const meetingsList = document.getElementById('meetings-list');
                const meetingSearchInput = document.getElementById('meeting-search');
                const addMeetingBtn = document.getElementById('add-meeting-btn');
                const meetingFormModal = document.getElementById('meeting-form-modal');
                const meetingForm = document.getElementById('meeting-form');
                const cancelMeetingFormBtn = document.getElementById('cancel-meeting-form');
                
                renderMeetingsTable(allMeetingsData); // Initial render

                const renderMeetingsTable = (meetingsToDisplay) => {
                    meetingsList.innerHTML = '';
                    meetingsToDisplay.forEach(meeting => {
                        const tr = document.createElement('tr');
                        // Use 'date' and 'time' fields for display
                        const date = meeting.date ? new Date(meeting.date.seconds * 1000).toLocaleDateString() : 'N/A';
                        tr.innerHTML = `
                            <td>${meeting.title}</td>
                            <td>${date}</td>
                            <td>${meeting.time || 'N/A'}</td>
                            <td>${meeting.location || 'N/A'}</td>
                            <td>${meeting.type || 'N/A'}</td>
                            <td>
                                <button class="btn btn-primary edit-meeting-btn" data-id="${meeting.id}">Edit</button>
                                <button class="btn delete-meeting-btn" data-id="${meeting.id}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        meetingsList.appendChild(tr);
                    });
                };

                // Search functionality
                meetingSearchInput.addEventListener('keyup', () => {
                    const searchTerm = meetingSearchInput.value.toLowerCase();
                    const filteredMeetings = allMeetingsData.filter(m => 
                        (m.title || '').toLowerCase().includes(searchTerm) || 
                        (m.description || '').toLowerCase().includes(searchTerm) ||
                        (m.date ? new Date(m.date.seconds * 1000).toLocaleDateString().includes(searchTerm) : false)
                    );
                    renderMeetingsTable(filteredMeetings);
                });

                // Add/Edit Meeting
                addMeetingBtn.addEventListener('click', () => {
                    meetingForm.reset();
                    document.getElementById('meeting-id').value = '';
                    meetingFormModal.style.display = 'flex';
                });

                cancelMeetingFormBtn.addEventListener('click', () => {
                    meetingFormModal.style.display = 'none';
                });

                meetingsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit-meeting-btn')) {
                        const meetingId = e.target.dataset.id;
                        // Path: artifacts/{appId}/public/data/meetings/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPublicCollectionPath('meetings'), meetingId)); 
                        if (docSnapshot.exists()) {
                            const meeting = docSnapshot.data();
                            document.getElementById('meeting-id').value = docSnapshot.id;
                            document.getElementById('meeting-title').value = meeting.title;
                            document.getElementById('meeting-date').value = meeting.date ? new Date(meeting.date.seconds * 1000).toISOString().split('T')[0] : '';
                            document.getElementById('meeting-time').value = meeting.time || '';
                            document.getElementById('meeting-location').value = meeting.location || '';
                            document.getElementById('meeting-description').value = meeting.description || '';
                            document.getElementById('meeting-type').value = meeting.type || 'meeting';
                            meetingFormModal.style.display = 'flex';
                        } else {
                            console.error(`Meeting document not found for ID: ${meetingId}`);
                            showConfirmationModal('Meeting record not found.', () => {});
                        }
                    }
                    if (e.target.classList.contains('delete-meeting-btn')) {
                        const meetingId = e.target.dataset.id;
                        showConfirmationModal('Are you sure you want to delete this meeting/notice?', async () => {
                            try {
                                // Path: artifacts/{appId}/public/data/meetings/{docId}
                                await deleteDoc(doc(firestore, getPublicCollectionPath('meetings'), meetingId)); 
                                showConfirmationModal('Meeting/notice deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting meeting:", error);
                                showConfirmationModal(`Failed to delete meeting: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                meetingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const meetingId = document.getElementById('meeting-id').value;
                    const title = document.getElementById('meeting-title').value;
                    const date = new Date(document.getElementById('meeting-date').value);
                    const time = document.getElementById('meeting-time').value;
                    const location = document.getElementById('meeting-location').value;
                    const description = document.getElementById('meeting-description').value;
                    const type = document.getElementById('meeting-type').value;

                    const meetingData = {
                        title: title,
                        date: new Date(date), 
                        time: time,
                        location: location,
                        description: description,
                        type: type,
                        timestamp: serverTimestamp() // Use timestamp for creation/last update
                    };

                    try {
                        if (meetingId) {
                            // Path: artifacts/{appId}/public/data/meetings/{docId}
                            await updateDoc(doc(firestore, getPublicCollectionPath('meetings'), meetingId), meetingData); 
                        } else {
                            // Path: artifacts/{appId}/public/data/meetings
                            await addDoc(collection(firestore, getPublicCollectionPath('meetings')), meetingData); 
                        }
                        showConfirmationModal('Meeting/Notice saved successfully!', () => {});
                        meetingFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving meeting:", error);
                        showConfirmationModal(`Failed to save meeting: ${error.message}`, () => {});
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedMeetings = [...allMeetingsData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'date') { 
                                valA = a.date ? a.date.toMillis() : 0;
                                valB = b.date ? b.date.toMillis() : 0;
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allMeetingsData.
                        renderMeetingsTable(sortedMeetings);
                    });
                });
            }

            async function renderFinesPenalties() {
                contentContainer.innerHTML = `
                    <h2>Fines & Penalties</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="fine-search" placeholder="Search by member or reason..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <select id="fine-status-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">All Statuses</option>
                            <option value="unpaid">Unpaid</option>
                            <option value="paid">Paid</option>
                        </select>
                        <button class="btn btn-primary" id="add-fine-btn">Add New Fine</button>
                        <button class="btn btn-primary" id="bulk-mark-paid-btn">Bulk Mark Paid</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-fines"></th>
                                <th>Member Name <span data-sort="memberName" class="sort-icon">⬆⬇</span></th>
                                <th>Reason</th>
                                <th>Amount <span data-sort="amount" class="sort-icon">⬆⬇</span></th>
                                <th>Date Issued <span data-sort="dateIssued" class="sort-icon">⬆⬇</span></th>
                                <th>Status <span data-sort="status" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fines-list">
                            <!-- Fines will be loaded here -->
                        </tbody>
                    </table>
                    <div id="fine-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Add/Edit Fine</h3>
                            <form id="fine-form">
                                <input type="hidden" id="fine-id">
                                <div class="form-group">
                                    <label for="fine-member-id">Member (Select Member)</label>
                                    <select id="fine-member-id" required></select>
                                </div>
                                <div class="form-group">
                                    <label for="fine-reason">Reason</label>
                                    <input type="text" id="fine-reason" required>
                                </div>
                                <div class="form-group">
                                    <label for="fine-amount">Amount</label>
                                    <input type="number" id="fine-amount" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="fine-date-issued">Date Issued</label>
                                    <input type="date" id="fine-date-issued" required>
                                </div>
                                <div class="form-group">
                                    <label for="fine-status">Status</label>
                                    <select id="fine-status">
                                        <option value="unpaid">Unpaid</option>
                                        <option value="paid">Paid</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Fine</button>
                                <button type="button" class="btn" id="cancel-fine-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const finesList = document.getElementById('fines-list');
                const fineSearchInput = document.getElementById('fine-search');
                const fineStatusFilter = document.getElementById('fine-status-filter');
                const addFineBtn = document.getElementById('add-fine-btn');
                const fineFormModal = document.getElementById('fine-form-modal');
                const fineForm = document.getElementById('fine-form');
                const cancelFineFormBtn = document.getElementById('cancel-fine-form');
                const fineMemberSelect = document.getElementById('fine-member-id');
                const selectAllFinesCheckbox = document.getElementById('select-all-fines');
                const bulkMarkPaidBtn = document.getElementById('bulk-mark-paid-btn');
                
                renderFinesTable(allFinesData); // Initial render
                renderMemberDropdowns(allMembersData); // Populate the member select

                const renderFinesTable = (finesToDisplay) => {
                    finesList.innerHTML = '';
                    finesToDisplay.forEach(fine => {
                        const tr = document.createElement('tr');
                        const memberName = membersMap[fine.memberUserId] || 'Unknown Member'; // Use memberUserId
                        const dateIssued = fine.dateIssued ? new Date(fine.dateIssued.seconds * 1000).toLocaleDateString() : 'N/A';
                        tr.innerHTML = `
                            <td><input type="checkbox" class="fine-checkbox" data-id="${fine.id}" data-member-id="${fine.memberUserId}"></td>
                            <td>${memberName}</td>
                            <td>${fine.reason}</td>
                            <td>Ksh ${fine.amount.toFixed(2)}</td>
                            <td>${dateIssued}</td>
                            <td>${fine.status}</td>
                            <td>
                                <button class="btn btn-primary edit-fine-btn" data-id="${fine.id}" data-member-id="${fine.memberUserId}">Edit</button>
                                ${fine.status === 'unpaid' ? `<button class="btn" data-action="mark-paid" data-id="${fine.id}" data-member-id="${fine.memberUserId}" style="background-color: #28a745; color: white;">Mark Paid</button>` : ''}
                                <button class="btn delete-fine-btn" data-id="${fine.id}" data-member-id="${fine.memberUserId}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        finesList.appendChild(tr);
                    });
                };

                // Search and Filter
                const applyFilters = () => {
                    let filtered = [...allFinesData];
                    const searchTerm = fineSearchInput.value.toLowerCase();
                    const filterStatus = fineStatusFilter.value;

                    if (searchTerm) {
                        filtered = filtered.filter(f => 
                            (membersMap[f.memberUserId] || 'Unknown Member').toLowerCase().includes(searchTerm) || // Use memberUserId
                            (f.reason || '').toLowerCase().includes(searchTerm)
                        );
                    }
                    if (filterStatus) {
                        filtered = filtered.filter(f => f.status === filterStatus);
                    }
                    renderFinesTable(filtered);
                };

                fineSearchInput.addEventListener('keyup', applyFilters);
                fineStatusFilter.addEventListener('change', applyFilters);

                // Add/Edit Fine
                addFineBtn.addEventListener('click', () => {
                    fineForm.reset();
                    document.getElementById('fine-id').value = '';
                    fineMemberSelect.value = ''; 
                    fineFormModal.style.display = 'flex';
                });

                cancelFineFormBtn.addEventListener('click', () => {
                    fineFormModal.style.display = 'none';
                });

                finesList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit-fine-btn')) {
                        const fineId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        // Path: artifacts/{appId}/users/{userId}/fines/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'fines'), fineId)); 
                        if (docSnapshot.exists()) {
                            const fine = docSnapshot.data();
                            document.getElementById('fine-id').value = docSnapshot.id;
                            document.getElementById('fine-member-id').value = memberUserId;
                            document.getElementById('fine-reason').value = fine.reason;
                            document.getElementById('fine-amount').value = fine.amount;
                            document.getElementById('fine-date-issued').value = fine.dateIssued ? new Date(fine.dateIssued.seconds * 1000).toISOString().split('T')[0] : '';
                            document.getElementById('fine-status').value = fine.status;
                            fineFormModal.style.display = 'flex';
                        } else {
                            console.error(`Fine document not found for ID: ${fineId}, Member: ${memberUserId}`);
                            showConfirmationModal('Fine record not found.', () => {});
                        }
                    }
                    if (e.target.dataset.action === 'mark-paid') {
                        const fineId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        showConfirmationModal('Mark this fine as paid?', async () => {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/fines/{docId}
                                await updateDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'fines'), fineId), { status: 'paid' }); 
                                showConfirmationModal('Fine marked as paid successfully!', () => {});
                            } catch (error) {
                                console.error("Error marking fine paid:", error);
                                showConfirmationModal(`Failed to mark fine paid: ${error.message}`, () => {});
                            }
                        });
                    }
                    if (e.target.classList.contains('delete-fine-btn')) {
                        const fineId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        showConfirmationModal('Are you sure you want to delete this fine record?', async () => {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/fines/{docId}
                                await deleteDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'fines'), fineId)); 
                                showConfirmationModal('Fine record deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting fine:", error);
                                showConfirmationModal(`Failed to delete fine: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                fineForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fineId = document.getElementById('fine-id').value;
                    const memberUserId = document.getElementById('fine-member-id').value;

                    if (!memberUserId) {
                        showConfirmationModal('Please select a valid member.', () => {});
                        return;
                    }

                    const reason = document.getElementById('fine-reason').value;
                    const amount = parseFloat(document.getElementById('fine-amount').value);
                    const dateIssued = new Date(document.getElementById('fine-date-issued').value);
                    const status = document.getElementById('fine-status').value;

                    const fineData = {
                        memberId: memberUserId, // Store the userId here
                        reason: reason,
                        amount: amount,
                        dateIssued: new Date(dateIssued), 
                        status: status,
                        timestamp: serverTimestamp()
                    };

                    try {
                        if (fineId) {
                            // Path: artifacts/{appId}/users/{userId}/fines/{docId}
                            await updateDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'fines'), fineId), fineData); 
                        } else {
                            // Path: artifacts/{appId}/users/{userId}/fines
                            await addDoc(collection(firestore, getPrivateCollectionPath(memberUserId, 'fines')), fineData); 
                        }
                        showConfirmationModal('Fine saved successfully!', () => {});
                        fineFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving fine:", error);
                        showConfirmationModal(`Failed to save fine: ${error.message}`, () => {});
                    }
                });

                // Bulk Actions
                selectAllFinesCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.fine-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });

                const getSelectedFineIdsAndMemberIds = () => {
                    const selected = [];
                    document.querySelectorAll('.fine-checkbox:checked').forEach(checkbox => {
                        if (checkbox.id !== 'select-all-fines') { 
                            selected.push({ id: checkbox.dataset.id, memberId: checkbox.dataset.memberId });
                        }
                    });
                    return selected;
                };

                bulkMarkPaidBtn.addEventListener('click', () => {
                    const selected = getSelectedFineIdsAndMemberIds();
                    if (selected.length === 0) {
                        showConfirmationModal('No fines selected for bulk marking as paid.', () => {});
                        return;
                    }
                    showConfirmationModal(`Mark ${selected.length} fines as paid?`, async () => {
                        for (const item of selected) {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/fines/{docId}
                                await updateDoc(doc(firestore, getPrivateCollectionPath(item.memberId, 'fines'), item.id), { status: 'paid' }); 
                            } catch (error) {
                                console.error(`Error bulk marking fine ${item.id} as paid:`, error);
                                showConfirmationModal(`Failed to mark fine ${item.id} as paid: ${error.message}`, () => {});
                            }
                        }
                        showConfirmationModal(`Successfully marked ${selected.length} fines as paid.`, () => {});
                    });
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedFines = [...allFinesData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'dateIssued') { 
                                valA = a.dateIssued ? a.dateIssued.toMillis() : 0;
                                valB = b.dateIssued ? b.dateIssued.toMillis() : 0;
                            } else if (sortBy === 'memberName') { 
                                valA = membersMap[a.memberUserId] || 'Unknown'; // Use memberUserId
                                valB = membersMap[b.memberUserId] || 'Unknown'; // Use memberUserId
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allFinesData.
                        renderFinesTable(sortedFines);
                    });
                });
            }

            async function renderInvestments() {
                contentContainer.innerHTML = `
                    <h2>Investments</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="investment-search" placeholder="Search by name or status..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <select id="investment-status-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="">All Statuses</option>
                            <option value="planning">Planning</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                        <button class="btn btn-primary" id="add-investment-btn">Add New Investment</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project Name <span data-sort="projectName" class="sort-icon">⬆⬇</span></th>
                                <th>Description</th>
                                <th>Target Amount <span data-sort="targetAmount" class="sort-icon">⬆⬇</span></th>
                                <th>Pledged Amount <span data-sort="pledgedAmount" class="sort-icon">⬆⬇</span></th>
                                <th>Status <span data-sort="status" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="investments-list">
                            <!-- Investments will be loaded here -->
                        </tbody>
                    </table>
                    <div id="investment-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Add/Edit Investment</h3>
                            <form id="investment-form">
                                <input type="hidden" id="investment-id">
                                <div class="form-group">
                                    <label for="investment-project-name">Project Name</label>
                                    <input type="text" id="investment-project-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="investment-description">Description</label>
                                    <textarea id="investment-description"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="investment-target-amount">Target Amount</label>
                                    <input type="number" id="investment-target-amount" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="investment-pledged-amount">Pledged Amount</label>
                                    <input type="number" id="investment-pledged-amount" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="investment-status">Status</label>
                                    <select id="investment-status">
                                        <option value="planning">Planning</option>
                                        <option value="active">Active</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Investment</button>
                                <button type="button" class="btn" id="cancel-investment-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const investmentsList = document.getElementById('investments-list');
                const investmentSearchInput = document.getElementById('investment-search');
                const investmentStatusFilter = document.getElementById('investment-status-filter');
                const addInvestmentBtn = document.getElementById('add-investment-btn');
                const investmentFormModal = document.getElementById('investment-form-modal');
                const investmentForm = document.getElementById('investment-form');
                const cancelInvestmentFormBtn = document.getElementById('cancel-investment-form');
                
                renderInvestmentsTable(allInvestmentsData); // Initial render

                const renderInvestmentsTable = (investmentsToDisplay) => {
                    investmentsList.innerHTML = '';
                    investmentsToDisplay.forEach(investment => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${investment.projectName}</td>
                            <td>${investment.description || 'N/A'}</td>
                            <td>Ksh ${investment.targetAmount.toFixed(2)}</td>
                            <td>Ksh ${(investment.pledgedAmount || 0).toFixed(2)}</td>
                            <td>${investment.status}</td>
                            <td>
                                <button class="btn btn-primary edit-investment-btn" data-id="${investment.id}">Edit</button>
                                ${investment.status !== 'completed' ? `<button class="btn" data-action="mark-completed" data-id="${investment.id}" style="background-color: #28a745; color: white;">Mark Completed</button>` : ''}
                                <button class="btn delete-investment-btn" data-id="${investment.id}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        investmentsList.appendChild(tr);
                    });
                };

                // Search and Filter
                const applyFilters = () => {
                    let filtered = [...allInvestmentsData];
                    const searchTerm = investmentSearchInput.value.toLowerCase();
                    const filterStatus = investmentStatusFilter.value;

                    if (searchTerm) {
                        filtered = filtered.filter(i => 
                            (i.projectName || '').toLowerCase().includes(searchTerm) ||
                            (i.description || '').toLowerCase().includes(searchTerm)
                        );
                    }
                    if (filterStatus) {
                        filtered = filtered.filter(i => i.status === filterStatus);
                    }
                    renderInvestmentsTable(filtered);
                };

                investmentSearchInput.addEventListener('keyup', applyFilters);
                investmentStatusFilter.addEventListener('change', applyFilters);

                // Add/Edit Investment
                addInvestmentBtn.addEventListener('click', () => {
                    investmentForm.reset();
                    document.getElementById('investment-id').value = '';
                    document.getElementById('investment-pledged-amount').value = 0; 
                    investmentFormModal.style.display = 'flex';
                });

                cancelInvestmentFormBtn.addEventListener('click', () => {
                    investmentFormModal.style.display = 'none';
                });

                investmentsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit-investment-btn')) {
                        const investmentId = e.target.dataset.id;
                        // Path: artifacts/{appId}/public/data/investments/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPublicCollectionPath('investments'), investmentId)); 
                        if (docSnapshot.exists()) {
                            const investment = docSnapshot.data();
                            document.getElementById('investment-id').value = docSnapshot.id;
                            document.getElementById('investment-project-name').value = investment.projectName;
                            document.getElementById('investment-description').value = investment.description || '';
                            document.getElementById('investment-target-amount').value = investment.targetAmount;
                            document.getElementById('investment-pledged-amount').value = investment.pledgedAmount || 0;
                            document.getElementById('investment-status').value = investment.status;
                            investmentFormModal.style.display = 'flex';
                        } else {
                            console.error(`Investment document not found for ID: ${investmentId}`);
                            showConfirmationModal('Investment record not found.', () => {});
                        }
                    }
                    if (e.target.dataset.action === 'mark-completed') {
                        const investmentId = e.target.dataset.id;
                        showConfirmationModal('Mark this investment as completed?', async () => {
                            try {
                                // Path: artifacts/{appId}/public/data/investments/{docId}
                                await updateDoc(doc(firestore, getPublicCollectionPath('investments'), investmentId), { status: 'completed' }); 
                                showConfirmationModal('Investment marked as completed successfully!', () => {});
                            } catch (error) {
                                console.error("Error marking investment completed:", error);
                                showConfirmationModal(`Failed to mark investment completed: ${error.message}`, () => {});
                            }
                        });
                    }
                    if (e.target.classList.contains('delete-investment-btn')) {
                        const investmentId = e.target.dataset.id;
                        showConfirmationModal('Are you sure you want to delete this investment?', async () => {
                            try {
                                // Path: artifacts/{appId}/public/data/investments/{docId}
                                await deleteDoc(doc(firestore, getPublicCollectionPath('investments'), investmentId)); 
                                showConfirmationModal('Investment deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting investment:", error);
                                showConfirmationModal(`Failed to delete investment: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                investmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const investmentId = document.getElementById('investment-id').value;
                    const projectName = document.getElementById('investment-project-name').value;
                    const description = document.getElementById('investment-description').value;
                    const targetAmount = parseFloat(document.getElementById('investment-target-amount').value);
                    const pledgedAmount = parseFloat(document.getElementById('investment-pledged-amount').value) || 0;
                    const status = document.getElementById('investment-status').value;

                    const investmentData = {
                        projectName: projectName,
                        description: description,
                        targetAmount: targetAmount,
                        pledgedAmount: pledgedAmount,
                        status: status,
                        timestamp: serverTimestamp() // Use timestamp for creation/last update
                    };

                    try {
                        if (investmentId) {
                            // Path: artifacts/{appId}/public/data/investments/{docId}
                            await updateDoc(doc(firestore, getPublicCollectionPath('investments'), investmentId), investmentData); 
                        } else {
                            // Path: artifacts/{appId}/public/data/investments
                            await addDoc(collection(firestore, getPublicCollectionPath('investments')), investmentData); 
                        }
                        showConfirmationModal('Investment saved successfully!', () => {});
                        investmentFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving investment:", error);
                        showConfirmationModal(`Failed to save investment: ${error.message}`, () => {});
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedInvestments = [...allInvestmentsData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allInvestmentsData.
                        renderInvestmentsTable(sortedInvestments);
                    });
                });
            }
            
            async function renderVotingPolls() {
                contentContainer.innerHTML = `
                    <h2>Voting & Polls</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="poll-search" placeholder="Search by title..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" id="add-poll-btn">Create New Poll</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title <span data-sort="title" class="sort-icon">⬆⬇</span></th>
                                <th>Description</th>
                                <th>Status <span data-sort="status" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="polls-list">
                            <!-- Polls will be loaded here -->
                        </tbody>
                    </table>
                    <div id="poll-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Create/Edit Poll</h3>
                            <form id="poll-form">
                                <input type="hidden" id="poll-id">
                                <div class="form-group">
                                    <label for="poll-title">Poll Title</label>
                                    <input type="text" id="poll-title" required>
                                </div>
                                <div class="form-group">
                                    <label for="poll-description">Description</label>
                                    <textarea id="poll-description"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="poll-options">Options (one per line)</label>
                                    <textarea id="poll-options" placeholder="Option A\nOption B\nOption C" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="poll-status">Status</label>
                                    <select id="poll-status">
                                        <option value="open">Open</option>
                                        <option value="closed">Closed</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Poll</button>
                                <button type="button" class="btn" id="cancel-poll-form">Cancel</button>
                            </form>
                        </div>
                    </div>
                    <div id="poll-results-modal" class="modal">
                        <div class="modal-content">
                            <h3 id="poll-results-title">Poll Results</h3>
                            <div id="poll-results-chart-container" style="max-height: 400px;">
                                <canvas id="poll-results-chart"></canvas>
                            </div>
                            <button type="button" class="btn" id="close-poll-results-modal">Close</button>
                        </div>
                    </div>`;
                
                const pollsList = document.getElementById('polls-list');
                const pollSearchInput = document.getElementById('poll-search');
                const addPollBtn = document.getElementById('add-poll-btn');
                const pollFormModal = document.getElementById('poll-form-modal');
                const pollForm = document.getElementById('poll-form');
                const cancelPollFormBtn = document.getElementById('cancel-poll-form');
                const pollResultsModal = document.getElementById('poll-results-modal');
                const closePollResultsModalBtn = document.getElementById('close-poll-results-modal');
                
                renderPollsTable(allPollsData); // Initial render

                const renderPollsTable = (pollsToDisplay) => {
                    pollsList.innerHTML = '';
                    pollsToDisplay.forEach(poll => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${poll.title}</td>
                            <td>${poll.description || 'N/A'}</td>
                            <td>${poll.status}</td>
                            <td>
                                <button class="btn btn-primary edit-poll-btn" data-id="${poll.id}">Edit</button>
                                <button class="btn" data-action="view-results" data-id="${poll.id}" style="background-color: #007bff; color: white;">View Results</button>
                                ${poll.status === 'open' ? `<button class="btn" data-action="close-poll" data-id="${poll.id}" style="background-color: #dc3545; color: white;">Close Poll</button>` : ''}
                                <button class="btn delete-poll-btn" data-id="${poll.id}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        pollsList.appendChild(tr);
                    });
                };

                // Search functionality
                pollSearchInput.addEventListener('keyup', () => {
                    const searchTerm = pollSearchInput.value.toLowerCase();
                    const filteredPolls = allPollsData.filter(p => 
                        (p.title || '').toLowerCase().includes(searchTerm) ||
                        (p.description || '').toLowerCase().includes(searchTerm)
                    );
                    renderPollsTable(filteredPolls);
                });

                // Create/Edit Poll
                addPollBtn.addEventListener('click', () => {
                    pollForm.reset();
                    document.getElementById('poll-id').value = '';
                    document.getElementById('poll-options').value = ''; 
                    document.getElementById('poll-status').value = 'open'; 
                    pollFormModal.style.display = 'flex';
                });

                cancelPollFormBtn.addEventListener('click', () => {
                    pollFormModal.style.display = 'none';
                });

                pollsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit-poll-btn')) {
                        const pollId = e.target.dataset.id;
                        // Path: artifacts/{appId}/public/data/polls/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPublicCollectionPath('polls'), pollId)); 
                        if (docSnapshot.exists()) {
                            const poll = docSnapshot.data();
                            document.getElementById('poll-id').value = docSnapshot.id;
                            document.getElementById('poll-title').value = poll.title;
                            document.getElementById('poll-description').value = poll.description || '';
                            // Ensure options are handled correctly (array to newline separated string)
                            document.getElementById('poll-options').value = Array.isArray(poll.options) ? poll.options.join('\n') : '';
                            document.getElementById('poll-status').value = poll.status;
                            pollFormModal.style.display = 'flex';
                        } else {
                            console.error(`Poll document not found for ID: ${pollId}`);
                            showConfirmationModal('Poll record not found.', () => {});
                        }
                    }
                    if (e.target.dataset.action === 'close-poll') {
                        const pollId = e.target.dataset.id;
                        showConfirmationModal('Are you sure you want to close this poll?', async () => {
                            try {
                                // Path: artifacts/{appId}/public/data/polls/{docId}
                                await updateDoc(doc(firestore, getPublicCollectionPath('polls'), pollId), { status: 'closed' }); 
                                showConfirmationModal('Poll closed successfully!', () => {});
                            } catch (error) {
                                console.error("Error closing poll:", error);
                                showConfirmationModal(`Failed to close poll: ${error.message}`, () => {});
                            }
                        });
                    }
                    if (e.target.dataset.action === 'view-results') {
                        const pollId = e.target.dataset.id;
                        // Path: artifacts/{appId}/public/data/polls/{docId}
                        const docSnapshot = await getDoc(doc(firestore, getPublicCollectionPath('polls'), pollId)); 
                        if (docSnapshot.exists()) {
                            const poll = docSnapshot.data();
                            document.getElementById('poll-results-title').textContent = `Results for: ${poll.title}`;
                            
                            const pollResultsChartCtx = document.getElementById('poll-results-chart');
                            if (pollResultsChartCtx) { // Ensure canvas exists
                                const chartInstance = Chart.getChart(pollResultsChartCtx);
                                if (chartInstance) { 
                                    chartInstance.destroy();
                                }

                                const labels = poll.options || [];
                                const data = labels.map(label => poll.votes?.[label] || 0); 

                                new Chart(pollResultsChartCtx.getContext('2d'), {
                                    type: 'bar',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Number of Votes',
                                            data: data,
                                            backgroundColor: [
                                                'rgba(128, 0, 0, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
                                                'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'
                                            ],
                                            borderColor: [
                                                'rgba(128, 0, 0, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                                                'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                                            ],
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                                        }
                                    }
                                });
                            } else {
                                console.error("Poll results canvas not found.");
                            }
                            pollResultsModal.style.display = 'flex';
                        } else {
                            console.error(`Poll document not found for ID: ${pollId}`);
                            showConfirmationModal('Poll record not found.', () => {});
                        }
                    }
                    if (e.target.classList.contains('delete-poll-btn')) {
                        const pollId = e.target.dataset.id;
                        showConfirmationModal('Are you sure you want to delete this poll?', async () => {
                            try {
                                // Path: artifacts/{appId}/public/data/polls/{docId}
                                await deleteDoc(doc(firestore, getPublicCollectionPath('polls'), pollId)); 
                                showConfirmationModal('Poll deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting poll:", error);
                                showConfirmationModal(`Failed to delete poll: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                closePollResultsModalBtn.addEventListener('click', () => {
                    pollResultsModal.style.display = 'none';
                });

                pollForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const pollId = document.getElementById('poll-id').value;
                    const title = document.getElementById('poll-title').value;
                    const description = document.getElementById('poll-description').value;
                    const options = document.getElementById('poll-options').value.split('\n').map(opt => opt.trim()).filter(opt => opt !== '');
                    const status = document.getElementById('poll-status').value;

                    if (options.length < 2) {
                        showConfirmationModal('Please provide at least two options for the poll.', () => {});
                        return;
                    }

                    let votes = {};
                    if (pollId) { 
                        // If editing an existing poll, preserve existing votes for unchanged options
                        // Path: artifacts/{appId}/public/data/polls/{docId}
                        const existingPollDoc = await getDoc(doc(firestore, getPublicCollectionPath('polls'), pollId)); 
                        const existingPoll = existingPollDoc.data();
                        if (existingPoll && existingPoll.votes) {
                            votes = { ...existingPoll.votes };
                        }
                    }
                    // Initialize votes for new options
                    options.forEach(option => {
                        if (votes[option] === undefined) {
                            votes[option] = 0;
                        }
                    });

                    const pollData = {
                        title: title,
                        description: description,
                        options: options,
                        status: status,
                        votes: votes,
                        timestamp: serverTimestamp() // Use timestamp for creation/last update
                    };

                    try {
                        if (pollId) {
                            // Path: artifacts/{appId}/public/data/polls/{docId}
                            await updateDoc(doc(firestore, getPublicCollectionPath('polls'), pollId), pollData); 
                        } else {
                            // Path: artifacts/{appId}/public/data/polls
                            await addDoc(collection(firestore, getPublicCollectionPath('polls')), pollData); 
                        }
                        showConfirmationModal('Poll saved successfully!', () => {});
                        pollFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error saving poll:", error);
                        showConfirmationModal(`Failed to save poll: ${error.message}`, () => {});
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedPolls = [...allPollsData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allPollsData.
                        renderPollsTable(sortedPolls);
                    });
                });
            }
            
            async function renderDocumentsManagement() {
                contentContainer.innerHTML = `
                    <h2>Documents Management</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="text" id="document-search" placeholder="Search by name or type..." style="flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" id="add-document-btn">Upload New Document</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Document Name <span data-sort="name" class="sort-icon">⬆⬇</span></th>
                                <th>File Type</th>
                                <th>Uploaded By</th>
                                <th>Upload Date <span data-sort="uploadDate" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documents-list">
                            <!-- Documents will be loaded here -->
                        </tbody>
                    </table>
                    <div id="document-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Upload Document</h3>
                            <form id="document-form">
                                <input type="hidden" id="document-id">
                                <div class="form-group">
                                    <label for="document-name">Document Name</label>
                                    <input type="text" id="document-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="document-file">Select File</label>
                                    <input type="file" id="document-file" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Upload Document</button>
                                <button type="button" class="btn" id="cancel-document-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const documentsList = document.getElementById('documents-list');
                const documentSearchInput = document.getElementById('document-search');
                const addDocumentBtn = document.getElementById('add-document-btn');
                const documentFormModal = document.getElementById('document-form-modal');
                const documentForm = document.getElementById('document-form');
                const cancelDocumentFormBtn = document.getElementById('cancel-document-form');
                
                renderDocumentsTable(allDocumentsData); // Initial render

                const renderDocumentsTable = (documentsToDisplay) => {
                    documentsList.innerHTML = '';
                    documentsToDisplay.forEach(doc => {
                        const tr = document.createElement('tr');
                        const uploadDate = doc.uploadedAt ? new Date(doc.uploadedAt.seconds * 1000).toLocaleDateString() : 'N/A'; // Use 'uploadedAt'
                        tr.innerHTML = `
                            <td>${doc.title}</td> <!-- Use 'title' for consistency -->
                            <td>${doc.fileType || 'N/A'}</td>
                            <td>${doc.uploadedBy || 'Admin'}</td>
                            <td>${uploadDate}</td>
                            <td>
                                <a href="${doc.fileUrl}" target="_blank" class="btn btn-primary" style="background-color: #007bff;">Download</a> <!-- Use 'fileUrl' -->
                                <button class="btn delete-document-btn" data-id="${doc.id}" data-path="${doc.filePath}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        documentsList.appendChild(tr);
                    });
                };

                // Search functionality
                documentSearchInput.addEventListener('keyup', () => {
                    const searchTerm = documentSearchInput.value.toLowerCase();
                    const filteredDocuments = allDocumentsData.filter(d => 
                        (d.title || '').toLowerCase().includes(searchTerm) || // Use 'title'
                        (d.fileType || '').toLowerCase().includes(searchTerm)
                    );
                    renderDocumentsTable(filteredDocuments);
                });

                // Upload Document
                addDocumentBtn.addEventListener('click', () => {
                    documentForm.reset();
                    document.getElementById('document-id').value = '';
                    documentFormModal.style.display = 'flex';
                });

                cancelDocumentFormBtn.addEventListener('click', () => {
                    documentFormModal.style.display = 'none';
                });

                documentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const docName = document.getElementById('document-name').value;
                    const file = document.getElementById('document-file').files[0];

                    if (!file) {
                        showConfirmationModal('Please select a file to upload.', () => {});
                        return;
                    }

                    const filePath = `documents/${Date.now()}_${file.name}`;
                    const fileRef = ref(storage, filePath); 
                    
                    try {
                        await uploadBytes(fileRef, file); 
                        const downloadUrl = await getDownloadURL(fileRef); 

                        const documentData = {
                            title: docName, // Use 'title' for consistency
                            fileType: file.type,
                            filePath: filePath, 
                            fileUrl: downloadUrl, // Use 'fileUrl' for consistency
                            uploadedBy: auth.currentUser ? auth.currentUser.email : 'Admin',
                            uploadedAt: serverTimestamp() // Use 'uploadedAt' for consistency
                        };

                        // Path: artifacts/{appId}/public/data/documents
                        await addDoc(collection(firestore, getPublicCollectionPath('documents')), documentData); 
                        showConfirmationModal('Document uploaded successfully!', () => {});
                        documentFormModal.style.display = 'none';
                    } catch (error) {
                        console.error("Error uploading file:", error);
                        showConfirmationModal("Failed to upload document: " + error.message, () => {});
                    }
                });

                // Delete Document
                documentsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('delete-document-btn')) {
                        const documentId = e.target.dataset.id;
                        const filePath = e.target.dataset.path; // Path to file in Storage
                        showConfirmationModal('Are you sure you want to delete this document?', async () => {
                            try {
                                if (filePath) {
                                    const fileRefToDelete = ref(storage, filePath); 
                                    await deleteObject(fileRefToDelete); 
                                }
                                // Path: artifacts/{appId}/public/data/documents/{docId}
                                await deleteDoc(doc(firestore, getPublicCollectionPath('documents'), documentId)); 
                                showConfirmationModal('Document deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting document:", error);
                                showConfirmationModal("Failed to delete document: " + error.message, () => {});
                            }
                        });
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedDocuments = [...allDocumentsData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'uploadedAt') { // Use 'uploadedAt'
                                valA = a.uploadedAt ? a.uploadedAt.toMillis() : 0;
                                valB = b.uploadedAt ? b.uploadedAt.toMillis() : 0;
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allDocumentsData.
                        renderDocumentsTable(sortedDocuments);
                    });
                });
            }

            async function renderAttendance() {
                contentContainer.innerHTML = `
                    <h2>Attendance</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;">
                        <input type="date" id="attendance-date-filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <button class="btn btn-primary" id="export-attendance-btn">Export Attendance (CSV)</button>
                        <button class="btn btn-primary" id="new-attendance-record-btn">New Attendance Record</button>
                    </div>
                    <table class="data-table" id="attendance-table">
                        <thead>
                            <tr>
                                <th>Date <span data-sort="date" class="sort-icon">⬆⬇</span></th>
                                <th>Member Name <span data-sort="memberName" class="sort-icon">⬆⬇</span></th>
                                <th>Status <span data-sort="status" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-list">
                            <!-- Attendance records will be loaded here -->
                        </tbody>
                    </table>
                    <div id="attendance-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Mark Attendance for Date: <span id="attendance-form-date-display"></span></h3>
                            <form id="attendance-form">
                                <input type="hidden" id="attendance-record-date-input">
                                <div id="members-for-attendance">
                                    <!-- Member checkboxes will be dynamically loaded here -->
                                </div>
                                <button type="submit" class="btn btn-primary">Save Attendance</button>
                                <button type="button" class="btn" id="cancel-attendance-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const attendanceList = document.getElementById('attendance-list');
                const attendanceDateFilter = document.getElementById('attendance-date-filter');
                const exportAttendanceBtn = document.getElementById('export-attendance-btn');
                const newAttendanceRecordBtn = document.getElementById('new-attendance-record-btn');
                const attendanceFormModal = document.getElementById('attendance-form-modal');
                const attendanceForm = document.getElementById('attendance-form');
                const cancelAttendanceFormBtn = document.getElementById('cancel-attendance-form');
                const attendanceFormDateDisplay = document.getElementById('attendance-form-date-display');
                const membersForAttendanceDiv = document.getElementById('members-for-attendance');

                // Initial render
                renderAttendanceTable(allAttendanceData);

                const renderAttendanceTable = (attendanceToDisplay) => {
                    attendanceList.innerHTML = '';
                    attendanceToDisplay.forEach(record => {
                        const tr = document.createElement('tr');
                        const date = record.date ? new Date(record.date.seconds * 1000).toLocaleDateString() : 'N/A';
                        const memberName = membersMap[record.memberId] || 'Unknown Member'; // Use memberId
                        tr.innerHTML = `
                            <td>${date}</td>
                            <td>${memberName}</td>
                            <td>${record.status}</td>
                            <td>
                                <button class="btn delete-attendance-btn" data-id="${record.id}" data-member-id="${record.memberId}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        attendanceList.appendChild(tr);
                    });
                };

                // Filter by date
                attendanceDateFilter.addEventListener('change', () => {
                    const filterDate = attendanceDateFilter.value;
                    let filtered = [...allAttendanceData];
                    if (filterDate) {
                        filtered = filtered.filter(record => {
                            const recordDate = record.date ? new Date(record.date.seconds * 1000).toISOString().split('T')[0] : '';
                            return recordDate === filterDate;
                        });
                    }
                    renderAttendanceTable(filtered);
                });

                // Export to CSV
                exportAttendanceBtn.addEventListener('click', () => {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Date,Member Name,Status\n"; 

                    allAttendanceData.forEach(record => {
                        const date = record.date ? new Date(record.date.seconds * 1000).toLocaleDateString() : 'N/A';
                        const memberName = membersMap[record.memberId] || 'Unknown Member'; // Use memberId
                        csvContent += `${date},"${memberName}","${record.status}"\n`;
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "chama_attendance.csv");
                    document.body.appendChild(link); 
                    link.click();
                    document.body.removeChild(link);
                    showConfirmationModal(`Generated and downloaded: chama_attendance.csv`, () => {});
                });

                // New Attendance Record
                newAttendanceRecordBtn.addEventListener('click', () => {
                    attendanceForm.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('attendance-record-date-input').value = today;
                    attendanceFormDateDisplay.textContent = new Date(today).toLocaleDateString();
                    
                    // Populate member checkboxes
                    membersForAttendanceDiv.innerHTML = '';
                    allMembersData.forEach(member => { // Use allMembersData
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <input type="checkbox" id="member-${member.id}" name="attendance-member" value="${member.id}" data-name="${member.name}">
                            <label for="member-${member.id}">${member.name}</label>`;
                        membersForAttendanceDiv.appendChild(div);
                    });
                    attendanceFormModal.style.display = 'flex';
                });

                cancelAttendanceFormBtn.addEventListener('click', () => {
                    attendanceFormModal.style.display = 'none';
                });

                attendanceForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const recordDate = new Date(document.getElementById('attendance-record-date-input').value);
                    const checkedMembers = document.querySelectorAll('input[name="attendance-member"]:checked');

                    if (checkedMembers.length === 0) {
                        showConfirmationModal('Please select at least one member to mark attendance for.', () => {});
                        return;
                    }

                    for (const memberCheckbox of checkedMembers) {
                        const memberUserId = memberCheckbox.value;
                        const memberName = memberCheckbox.dataset.name;
                        
                        try {
                            // Path: artifacts/{appId}/users/{userId}/attendance
                            await addDoc(collection(firestore, getPrivateCollectionPath(memberUserId, 'attendance')), { 
                                memberId: memberUserId, // Store the userId here
                                memberName: memberName, 
                                date: new Date(recordDate), 
                                status: 'present',
                                timestamp: serverTimestamp()
                            });
                        } catch (error) {
                            console.error(`Error marking attendance for ${memberName}:`, error);
                            showConfirmationModal(`Failed to mark attendance for ${memberName}: ${error.message}`, () => {});
                        }
                    }
                    showConfirmationModal('Attendance saved successfully!', () => {});
                    attendanceFormModal.style.display = 'none';
                });

                // Delete Attendance Record
                attendanceList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('delete-attendance-btn')) {
                        const recordId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId;
                        showConfirmationModal('Are you sure you want to delete this attendance record?', async () => {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/attendance/{docId}
                                await deleteDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'attendance'), recordId)); 
                                showConfirmationModal('Attendance record deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting attendance record:", error);
                                showConfirmationModal(`Failed to delete attendance record: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedAttendance = [...allAttendanceData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'date') { 
                                valA = a.date ? a.date.toMillis() : 0;
                                valB = b.date ? b.date.toMillis() : 0;
                            } else if (sortBy === 'memberName') { 
                                valA = membersMap[a.memberId] || 'Unknown'; // Use memberId
                                valB = membersMap[b.memberId] || 'Unknown'; // Use memberId
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allAttendanceData.
                        renderAttendanceTable(sortedAttendance);
                    });
                });
            }

            async function renderNotifications() {
                contentContainer.innerHTML = `
                    <h2>Notifications</h2>
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-primary" id="compose-notification-btn">Compose New Notification</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Subject <span data-sort="subject" class="sort-icon">⬆⬇</span></th>
                                <th>Message</th>
                                <th>Recipients</th>
                                <th>Date Sent <span data-sort="timestamp" class="sort-icon">⬆⬇</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notifications-list">
                            <!-- Notifications will be loaded here -->
                        </tbody>
                    </table>
                    <div id="notification-form-modal" class="modal">
                        <div class="modal-content">
                            <h3>Compose Notification</h3>
                            <form id="notification-form">
                                <div class="form-group">
                                    <label for="notification-subject">Subject</label>
                                    <input type="text" id="notification-subject" required>
                                </div>
                                <div class="form-group">
                                    <label for="notification-message">Message</label>
                                    <textarea id="notification-message" rows="5" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Recipients</label>
                                    <div>
                                        <input type="checkbox" id="send-to-all"> <label for="send-to-all">Send to All Members</label>
                                    </div>
                                    <div id="notification-member-selects" style="margin-top: 10px; border: 1px solid #eee; padding: 10px; max-height: 150px; overflow-y: auto;">
                                        <!-- Dynamic member checkboxes -->
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Send Notification</button>
                                <button type="button" class="btn" id="cancel-notification-form">Cancel</button>
                            </form>
                        </div>
                    </div>`;
                
                const notificationsList = document.getElementById('notifications-list');
                const composeNotificationBtn = document.getElementById('compose-notification-btn');
                const notificationFormModal = document.getElementById('notification-form-modal');
                const notificationForm = document.getElementById('notification-form');
                const cancelNotificationFormBtn = document.getElementById('cancel-notification-form');
                const sendToAllCheckbox = document.getElementById('send-to-all');
                const notificationMemberSelectsDiv = document.getElementById('notification-member-selects');
                
                renderNotificationsTable(allNotificationsData); // Initial render
                renderMemberDropdowns(allMembersData); // Populate member checkboxes

                const renderNotificationsTable = (notificationsToDisplay) => {
                    notificationsList.innerHTML = '';
                    notificationsToDisplay.forEach(notification => {
                        const tr = document.createElement('tr');
                        const dateSent = notification.timestamp ? new Date(notification.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                        
                        let recipientsDisplay = '';
                        // Assuming 'memberId' in notification object refers to the recipient's userId
                        const recipientName = membersMap[notification.memberId] || `ID: ${notification.memberId}`;
                        recipientsDisplay = recipientName;


                        tr.innerHTML = `
                            <td>${notification.subject}</td>
                            <td>${notification.message.substring(0, 50)}...</td>
                            <td>${recipientsDisplay}</td>
                            <td>${dateSent}</td>
                            <td>
                                <button class="btn delete-notification-btn" data-id="${notification.id}" data-member-id="${notification.memberId}" style="background-color: #ffc107; color: black;">Delete</button>
                            </td>`;
                        notificationsList.appendChild(tr);
                    });
                };

                // Compose Notification
                composeNotificationBtn.addEventListener('click', () => {
                    notificationForm.reset();
                    sendToAllCheckbox.checked = false;
                    document.querySelectorAll('.notification-member-checkbox').forEach(cb => cb.checked = false);
                    notificationMemberSelectsDiv.style.display = 'block'; 
                    notificationFormModal.style.display = 'flex';
                });

                cancelNotificationFormBtn.addEventListener('click', () => {
                    notificationFormModal.style.display = 'none';
                });

                sendToAllCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        notificationMemberSelectsDiv.style.display = 'none';
                        document.querySelectorAll('.notification-member-checkbox').forEach(cb => cb.checked = false);
                    } else {
                        notificationMemberSelectsDiv.style.display = 'block';
                    }
                });

                notificationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const subject = document.getElementById('notification-subject').value;
                    const message = document.getElementById('notification-message').value;
                    let recipientIds = []; 

                    if (sendToAllCheckbox.checked) {
                        recipientIds = allMembersData.map(member => member.id); 
                    } else {
                        document.querySelectorAll('.notification-member-checkbox:checked').forEach(cb => {
                            recipientIds.push(cb.value); 
                        });
                    }

                    if (recipientIds.length === 0) {
                        showConfirmationModal('Please select recipients or choose "Send to All".', () => {});
                        return;
                    }

                    const baseNotificationData = {
                        subject: subject,
                        message: message,
                        timestamp: serverTimestamp()
                    };

                    for (const targetUserId of recipientIds) {
                        try {
                            // Path: artifacts/{appId}/users/{userId}/notifications
                            await addDoc(collection(firestore, getPrivateCollectionPath(targetUserId, 'notifications')), {
                                ...baseNotificationData,
                                memberId: targetUserId // Add memberId to know who it's for
                            });
                        } catch (error) {
                            console.error(`Error sending notification to ${targetUserId}:`, error);
                            showConfirmationModal(`Failed to send notification to ${targetUserId}: ${error.message}`, () => {});
                        }
                    }
                    showConfirmationModal('Notifications sent successfully to selected members.', () => {});
                    notificationFormModal.style.display = 'none';
                });

                // Delete Notification
                notificationsList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('delete-notification-btn')) {
                        const notificationId = e.target.dataset.id;
                        const memberUserId = e.target.dataset.memberId; // Get the recipient's user ID
                        if (!memberUserId) {
                             console.error("Member User ID not found for deletion.");
                             showConfirmationModal('Cannot delete notification: User ID not found.', () => {});
                             return;
                        }
                        showConfirmationModal('Are you sure you want to delete this notification record?', async () => {
                            try {
                                // Path: artifacts/{appId}/users/{userId}/notifications/{docId}
                                await deleteDoc(doc(firestore, getPrivateCollectionPath(memberUserId, 'notifications'), notificationId)); 
                                showConfirmationModal('Notification deleted successfully!', () => {});
                            } catch (error) {
                                console.error("Error deleting notification:", error);
                                showConfirmationModal(`Failed to delete notification: ${error.message}`, () => {});
                            }
                        });
                    }
                });

                // Sorting functionality
                contentContainer.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const sortBy = e.target.dataset.sort;
                        const sortedNotifications = [...allNotificationsData].sort((a, b) => {
                            let valA = a[sortBy];
                            let valB = b[sortBy];

                            if (sortBy === 'timestamp') { 
                                valA = a.timestamp ? a.timestamp.toMillis() : 0;
                                valB = b.timestamp ? b.timestamp.toMillis() : 0;
                            }
                            
                            if (typeof valA === 'string') return valA.localeCompare(valB);
                            return valA - valB;
                        });
                        // Do not reassign allNotificationsData.
                        renderNotificationsTable(sortedNotifications);
                    });
                });
            }
            
            async function renderReports() {
                contentContainer.innerHTML = `
                    <h2>Reports</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <button class="btn btn-primary" id="generate-financial-report-btn">Financial Statements (CSV)</button>
                        <button class="btn btn-primary" id="generate-contributions-summary-btn">Contributions Summary (CSV)</button>
                        <button class="btn btn-primary" id="generate-loan-report-btn">Loan Report (CSV)</button>
                        <button class="btn btn-primary" id="generate-fines-report-btn">Fines Report (CSV)</button>
                        <button class="btn btn-primary" id="generate-attendance-report-btn">Attendance Report (CSV)</button>
                    </div>`;
                
                // Member map is already populated by initPrivateCollectionListeners()
                
                document.getElementById('generate-financial-report-btn').addEventListener('click', async () => {
                    try {
                        // Use the globally aggregated data arrays
                        let totalContributions = allContributionsData.reduce((sum, c) => sum + (c.amount || 0), 0);
                        let totalLoansIssued = allLoansData.reduce((sum, l) => sum + (l.amount || 0), 0);
                        let totalLoansRepaid = allLoansData.reduce((sum, l) => sum + (l.repaidAmount || 0), 0);
                        let totalFinesIssued = allFinesData.reduce((sum, f) => sum + (f.amount || 0), 0);
                        let totalFinesPaid = allFinesData.filter(f => f.status === 'paid').reduce((sum, f) => sum + (f.amount || 0), 0);

                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Report Type,Amount\n";
                        csvContent += `Total Contributions,${totalContributions.toFixed(2)}\n`;
                        csvContent += `Total Loans Issued,${totalLoansIssued.toFixed(2)}\n`;
                        csvContent += `Total Loans Repaid,${totalLoansRepaid.toFixed(2)}\n`;
                        csvContent += `Total Fines Issued,${totalFinesIssued.toFixed(2)}\n`;
                        csvContent += `Total Fines Paid,${totalFinesPaid.toFixed(2)}\n`;
                        csvContent += `Net Funds (Simplified Calculation),${(totalContributions + totalFinesPaid - totalLoansIssued).toFixed(2)}\n`;

                        downloadCSV(csvContent, 'financial_statements.csv');
                    } catch (error) {
                        console.error("Error generating financial report:", error);
                        showConfirmationModal(`Failed to generate financial report: ${error.message}`, () => {});
                    }
                });

                document.getElementById('generate-contributions-summary-btn').addEventListener('click', async () => {
                    try {
                        // Use the globally aggregated data array
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Member Name,Amount,Date,Description\n";

                        allContributionsData.forEach(c => {
                            const memberName = membersMap[c.memberUserId] || 'Unknown'; // Use memberUserId
                            const date = c.date ? new Date(c.date.seconds * 1000).toLocaleDateString() : 'N/A';
                            csvContent += `"${memberName}",${(c.amount || 0).toFixed(2)},"${date}","${c.description || ''}"\n`;
                        });
                        downloadCSV(csvContent, 'contributions_summary.csv');
                    } catch (error) {
                        console.error("Error generating contributions summary:", error);
                        showConfirmationModal(`Failed to generate contributions summary: ${error.message}`, () => {});
                    }
                });

                document.getElementById('generate-loan-report-btn').addEventListener('click', async () => {
                    try {
                        // Use the globally aggregated data array
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Member Name,Amount,Interest Rate,Due Date,Status,Repaid Amount,Balance\n";

                        allLoansData.forEach(l => {
                            const memberName = membersMap[l.memberUserId] || 'Unknown'; // Use memberUserId
                            const dueDate = l.dueDate ? new Date(l.dueDate.seconds * 1000).toLocaleDateString() : 'N/A';
                            const balance = ((l.amount || 0) * (1 + (l.interestRate || 0) / 100)) - (l.repaidAmount || 0);
                            csvContent += `"${memberName}",${(l.amount || 0).toFixed(2)},${(l.interestRate || 0)},"${dueDate}","${l.status}",${(l.repaidAmount || 0).toFixed(2)},${balance.toFixed(2)}\n`;
                        });
                        downloadCSV(csvContent, 'loan_report.csv');
                    } catch (error) {
                        console.error("Error generating loan report:", error);
                        showConfirmationModal(`Failed to generate loan report: ${error.message}`, () => {});
                    }
                });

                document.getElementById('generate-fines-report-btn').addEventListener('click', async () => {
                    try {
                        // Use the globally aggregated data array
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Member Name,Reason,Amount,Date Issued,Status\n";

                        allFinesData.forEach(f => {
                            const memberName = membersMap[f.memberUserId] || 'Unknown'; // Use memberUserId
                            const dateIssued = f.dateIssued ? new Date(f.dateIssued.seconds * 1000).toLocaleDateString() : 'N/A';
                            csvContent += `"${memberName}","${f.reason}",${(f.amount || 0).toFixed(2)},"${dateIssued}","${f.status}"\n`;
                        });
                        downloadCSV(csvContent, 'fines_report.csv');
                    } catch (error) {
                        console.error("Error generating fines report:", error);
                        showConfirmationModal(`Failed to generate fines report: ${error.message}`, () => {});
                    }
                });

                document.getElementById('generate-attendance-report-btn').addEventListener('click', async () => {
                    try {
                        // Use the globally aggregated data array
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Date,Member Name,Status\n";

                        allAttendanceData.forEach(a => {
                            const memberName = membersMap[a.memberId] || 'Unknown'; // Use memberId
                            const date = a.date ? new Date(a.date.seconds * 1000).toLocaleDateString() : 'N/A';
                            csvContent += `${date},"${memberName}","${a.status}"\n`;
                        });
                        downloadCSV(csvContent, 'attendance_report.csv');
                    } catch (error) {
                        console.error("Error generating attendance report:", error);
                        showConfirmationModal(`Failed to generate attendance report: ${error.message}`, () => {});
                    }
                });

                function downloadCSV(content, filename) {
                    const encodedUri = encodeURI(content);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", filename);
                    document.body.appendChild(link); 
                    link.click();
                    document.body.removeChild(link);
                    showConfirmationModal(`Generated and downloaded: ${filename}`, () => {});
                }
            }


            // --- MODAL LOGIC (reusable) ---
            function showConfirmationModal(message, onConfirm) {
                document.getElementById('modal-message').textContent = message;
                document.getElementById('confirmation-modal').style.display = 'flex';
                
                document.getElementById('modal-confirm-btn').onclick = () => {
                    onConfirm();
                    document.getElementById('confirmation-modal').style.display = 'none';
                };
                
                document.getElementById('modal-cancel-btn').onclick = () => {
                    document.getElementById('confirmation-modal').style.display = 'none';
                };
            }
            
            // Function to dynamically populate member dropdowns/checkboxes
            function renderMemberDropdowns(members) {
                // Clear existing options/checkboxes in all relevant places
                const memberSelects = [
                    document.getElementById('contribution-member-id'),
                    document.getElementById('loan-member-id'),
                    document.getElementById('fine-member-id')
                ];

                memberSelects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">Select Member</option>';
                        members.forEach(member => {
                            const option = document.createElement('option');
                            option.value = member.id;
                            option.textContent = `${member.name} (${member.email})`;
                            select.appendChild(option);
                        });
                    }
                });

                // Populate checkboxes for notifications
                const notificationMemberSelectsDiv = document.getElementById('notification-member-selects');
                if (notificationMemberSelectsDiv) {
                    notificationMemberSelectsDiv.innerHTML = '';
                    members.forEach(member => {
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <input type="checkbox" id="notify-member-${member.id}" class="notification-member-checkbox" value="${member.id}">
                            <label for="notify-member-${member.id}">${member.name} (${member.email})</label>
                        `;
                        notificationMemberSelectsDiv.appendChild(div);
                    });
                }

                // Update the global membersMap
                membersMap = members.reduce((map, member) => {
                    map[member.id] = member.name;
                    return map;
                }, {});

                memberIdToEmailMap = members.reduce((map, member) => {
                    map[member.id] = member.email;
                    return map;
                }, {});
            }


        }); // End of DOMContentLoaded
    </script>
</body>
</html>
