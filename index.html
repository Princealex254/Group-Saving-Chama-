<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Digital - Group Saving Chama</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons (e.g., hamburger menu) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for the theme colors and fonts */
        :root {
            --primary-maroon: #800000;
            --secondary-white: #ffffff;
            --maroon-light: #a00000;
            --maroon-dark: #600000;
            --gradient-maroon: linear-gradient(135deg, #800000 0%, #a00000 100%);
            --gradient-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --shadow-soft: 0 10px 25px rgba(128, 0, 0, 0.1);
            --shadow-hover: 0 20px 40px rgba(128, 0, 0, 0.15);
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gradient-bg);
            padding-top: 80px;
            line-height: 1.6;
            color: #2d3748;
        }
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            background: var(--gradient-maroon);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-soft);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .bg-maroon {
            background-color: var(--primary-maroon);
        }
        .text-maroon {
            color: var(--primary-maroon);
        }
        .border-maroon {
            border-color: var(--primary-maroon);
        }
        .btn-primary {
            background: var(--gradient-maroon);
            color: var(--secondary-white);
            padding: 0.875rem 2rem;
            border-radius: var(--border-radius-sm);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .link-maroon {
            color: var(--primary-maroon);
            text-decoration: none;
        }
        .link-maroon:hover {
            text-decoration: underline;
        }
        .input-field {
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: var(--secondary-white);
            transition: var(--transition);
            font-family: inherit;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-maroon);
            box-shadow: 0 0 0 3px rgba(128, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        .input-field::placeholder {
            color: #a0aec0;
            opacity: 0.8;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden; /* Start hidden */
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex; /* Use flexbox to align message and close button */
            align-items: center;
            justify-content: space-between;
        }
        .message-box.error {
            background-color: #f44336; /* Red for error */
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        .message-box-content {
            flex-grow: 1;
            padding-right: 10px; /* Space between text and button */
        }
        .message-box-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .message-box-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        /* Specific styles for scrollable sections in dashboard */
        .scroll-y {
            max-height: 300px; /* Adjust as needed */
            overflow-y: auto;
        }
        .table-auto {
            width: 100%;
            border-collapse: collapse;
        }
        .table-auto th, .table-auto td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .table-auto th {
            background-color: var(--primary-maroon);
            color: var(--secondary-white);
        }
        /* Modern hero section */
        .attractive-hero {
            background: var(--gradient-maroon);
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            padding: 4rem 2rem;
            position: relative;
            overflow: hidden;
        }
        .attractive-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="40" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        .attractive-hero > * {
            position: relative;
            z-index: 1;
        }


        /* Modern card styles */
        .modern-card {
            background: var(--secondary-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(128, 0, 0, 0.1);
            transition: var(--transition);
            overflow: hidden;
        }
        .modern-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-4px);
        }
        .modern-card-header {
            background: var(--gradient-maroon);
            color: white;
            padding: 1.5rem;
            font-weight: 600;
            font-size: 1.25rem;
        }
        .modern-card-body {
            padding: 2rem;
        }

        /* Navigation link styles */
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            font-weight: 500;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: white;
            transition: width 0.3s ease;
        }
        .nav-link:hover::after {
            width: 80%;
        }

        /* Floating Chat Button */
        .chat-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--gradient-maroon);
            color: white;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-hover);
            z-index: 900;
            transition: var(--transition);
            border: none;
        }
        .chat-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 25px 50px rgba(128, 0, 0, 0.25);
        }

        /* Footer Modern Styles */
        .py-16 {
            padding-top: 4rem;
            padding-bottom: 4rem;
        }

        .relative {
            position: relative;
        }

        .overflow-hidden {
            overflow: hidden;
        }

        .absolute {
            position: absolute;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, var(--primary-maroon), var(--maroon-light), var(--maroon-dark));
        }

        .from-maroon {
            --tw-gradient-from: var(--primary-maroon);
            --tw-gradient-to: rgba(128, 0, 0, 0);
            --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
        }

        .via-maroon-light {
            --tw-gradient-to: rgba(160, 0, 0, 0);
            --tw-gradient-stops: var(--primary-maroon), var(--maroon-light), var(--tw-gradient-to);
        }

        .to-maroon-dark {
            --tw-gradient-to: var(--maroon-dark);
        }

        .opacity-10 {
            opacity: 0.1;
        }

        .z-10 {
            z-index: 10;
        }

        .gap-12 {
            gap: 3rem;
        }

        .mb-12 {
            margin-bottom: 3rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mb-1 {
            margin-bottom: 0.25rem;
        }

        .w-16 {
            width: 4rem;
        }

        .h-16 {
            height: 4rem;
        }

        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .mr-4 {
            margin-right: 1rem;
        }

        .hover\:scale-110:hover {
            transform: scale(1.1);
        }

        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .duration-300 {
            transition-duration: 300ms;
        }

        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }

        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .text-base {
            font-size: 1rem;
            line-height: 1.5rem;
        }

        .leading-relaxed {
            line-height: 1.625;
        }

        .space-x-4 > * + * {
            margin-left: 1rem;
        }

        .w-10 {
            width: 2.5rem;
        }

        .h-10 {
            height: 2.5rem;
        }

        .bg-opacity-20 {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .hover\:bg-opacity-30:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .hover\:text-yellow-300:hover {
            color: #fde047;
        }

        .hover\:translate-x-2:hover {
            transform: translateX(0.5rem);
        }

        .mr-3 {
            margin-right: 0.75rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .pt-8 {
            padding-top: 2rem;
        }

        .space-x-6 > * + * {
            margin-left: 1.5rem;
        }

        .md\:space-y-0 > * + * {
            margin-top: 0;
        }

        .hover\:opacity-100:hover {
            opacity: 1;
        }

        /* Chat Modal */
        .chat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 950;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .chat-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .chat-modal-content {
            background-color: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            overflow: hidden; /* Ensures rounded corners on inner content */
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .chat-modal-overlay.show .chat-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .chat-header {
            background-color: var(--primary-maroon);
            color: white;
            padding: 12px 16px;
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .chat-close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .chat-close-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        .chat-message.user {
            align-self: flex-end;
            background-color: #DCF8C6; /* Light green for user messages */
            color: #333;
            border-bottom-right-radius: 2px;
        }
        .chat-message.admin {
            align-self: flex-start;
            background-color: #E2E2E2; /* Light gray for admin messages */
            color: #333;
            border-bottom-left-radius: 2px;
        }
        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            background-color: #fff;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        .chat-input-area input {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            margin-right: 10px;
            font-size: 0.95rem;
        }
        .chat-input-area button {
            background-color: var(--primary-maroon);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .chat-input-area button:hover {
            background-color: #a00000;
        }
        
        /* Service Modal Styles */
        .service-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .service-modal-overlay.show {
            display: flex !important;
        }
        
        /* Dashboard Styles */
        .dashboard-menu-item.active {
            background-color: #8B0000;
            color: white;
        }
        
        .dashboard-menu-item.active i {
            color: white;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .dashboard-stat {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #8B0000, #A00000);
            color: white;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .dashboard-stat h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .dashboard-stat p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        /* Dashboard Feature Buttons */
        .dashboard-feature-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            color: #374151;
        }
        
        .dashboard-feature-btn:hover {
            border-color: #8B0000;
            background: #fef2f2;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 0, 0, 0.1);
        }
        
        .dashboard-feature-btn i {
            transition: all 0.3s ease;
        }
        
        .dashboard-feature-btn:hover i {
            transform: scale(1.1);
        }
        
        .service-modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .service-modal-overlay.show .service-modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        .service-modal-header {
            background: var(--gradient-maroon);
            color: white;
            padding: 20px;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .service-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .service-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .service-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .service-modal-body {
            padding: 30px;
        }
        
        .service-form-group {
            margin-bottom: 20px;
        }
        
        .service-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .service-form-group input,
        .service-form-group select,
        .service-form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .service-form-group input:focus,
        .service-form-group select:focus,
        .service-form-group textarea:focus {
            outline: none;
            border-color: var(--primary-maroon);
        }
        
        .service-form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .service-modal-actions {
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Header -->
    <header class="text-white py-4 px-6">
        <nav class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <!-- Modern Logo with gradient background -->
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                    <span class="text-maroon font-bold text-lg">PAD</span>
                </div>
                <div>
                    <span class="text-2xl font-bold">Prince Alex Digital</span>
                    <p class="text-sm opacity-90">Group Saving Chama</p>
                </div>
            </div>
            <div class="hidden md:flex space-x-8">
                <a href="#home" class="nav-link hover:text-white transition-all duration-300 relative" onclick="window.renderPage('home')">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <a href="#about" class="nav-link hover:text-white transition-all duration-300 relative" onclick="window.renderPage('about')">
                    <i class="fas fa-info-circle mr-2"></i>About
                </a>
                <a href="#services" class="nav-link hover:text-white transition-all duration-300 relative" onclick="window.renderPage('services')">
                    <i class="fas fa-cogs mr-2"></i>Services
                </a>
                <a href="#signup" id="signup-link" class="nav-link hover:text-white transition-all duration-300 relative" onclick="window.renderPage('signup')">
                    <i class="fas fa-user-plus mr-2"></i>Sign Up
                </a>
                <a href="#login" id="login-link" class="nav-link hover:text-white transition-all duration-300 relative" onclick="openServiceModal('service-name')">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </a>
                <a href="#dashboard" id="dashboard-link" class="hidden nav-link hover:text-white transition-all duration-300 relative" onclick="window.renderPage('dashboard')">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </a>
                <button id="logout-button" class="hidden nav-link hover:text-white transition-all duration-300 relative" onclick="window.handleLogout()">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
            <div class="md:hidden">
                <button id="hamburger-menu" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-maroon mt-2 rounded-md shadow-lg py-2">
            <a href="#home" class="block px-4 py-2 text-white hover:bg-red-700" onclick="window.renderPage('home'); window.toggleMobileMenu()">Home</a>
            <a href="#about" class="block px-4 py-2 text-white hover:bg-red-700" onclick="window.renderPage('about'); window.toggleMobileMenu()">About</a>
            <a href="#services" class="block px-4 py-2 text-white hover:bg-red-700" onclick="window.renderPage('services'); window.toggleMobileMenu()">Services</a>
            <a href="#signup" id="signup-link-mobile" class="block px-4 py-2 text-white hover:bg-red-700" onclick="window.renderPage('signup'); window.toggleMobileMenu()">Sign Up</a>
            <a href="#login" id="login-link-mobile" class="block px-4 py-2 text-white hover:bg-red-700" onclick="window.renderPage('login'); window.toggleMobileMenu()">Login</a>
            <a href="#dashboard-mobile" id="dashboard-link-mobile" class="hidden block px-4 py-2 text-white hover:bg-red-700" onclick="window.renderPage('dashboard'); window.toggleMobileMenu()">Dashboard</a>
            <button id="logout-button-mobile" class="hidden w-full text-left px-4 py-2 text-white hover:bg-red-700" onclick="window.handleLogout(); window.toggleMobileMenu()">Logout</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-grow container mx-auto p-6 md:p-8">
        <!-- Content will be dynamically loaded here by JavaScript -->
        <!-- For an initial static page (e.g., home), its content could be placed here directly for SEO/non-JS users. -->
        <!-- However, given the current application structure, all page content is rendered via JavaScript for dynamic routing. -->
    </main>

    <!-- Footer -->
    <footer class="bg-maroon text-white py-6 mt-auto">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <!-- Company Info -->
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                        <span class="text-maroon font-bold text-sm">PAD</span>
                        </div>
                        <div>
                        <h3 class="text-lg font-bold">Prince Alex Digital</h3>
                        <p class="text-xs opacity-90">Group Saving Chama</p>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="flex space-x-6 text-sm">
                    <a href="#about" class="hover:text-yellow-300 transition-colors" onclick="window.renderPage('about')">About</a>
                    <a href="#services" class="hover:text-yellow-300 transition-colors" onclick="window.renderPage('services')">Services</a>
                    <a href="#signup" class="hover:text-yellow-300 transition-colors" onclick="window.renderPage('signup')">Join</a>
                    <a href="mailto:princealexdigital@gmail.com" class="hover:text-yellow-300 transition-colors">Contact</a>
                </div>
                
                <!-- Copyright -->
                <p class="text-xs opacity-75">
                        &copy; 2024 Prince Alex Digital. All rights reserved.
                    </p>
            </div>
        </div>
    </footer>

    <!-- Message Box -->
    <div id="message-box" class="message-box">
        <span id="message-box-content" class="message-box-content"></span>
        <button id="message-box-close" class="message-box-close">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Floating Chat Button -->
    <button class="chat-button" id="chat-button">
        <i class="fas fa-comments"></i>
    </button>

    <!-- Chat Modal -->
    <div id="chat-modal-overlay" class="chat-modal-overlay">
        <div class="chat-modal-content">
            <div class="chat-header">
                <span>Support Chat</span>
                <button class="chat-close-button" id="chat-close-button"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will be loaded here -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type your message..." autocomplete="off">
                <button id="chat-send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="service-modal-overlay" class="service-modal-overlay">
        <div class="service-modal-content">
            <div class="service-modal-header">
                <h2 id="service-modal-title">Service Form</h2>
                <button class="service-modal-close" id="service-modal-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="service-modal-body" id="service-modal-body">
                <!-- Service form content will be loaded here -->
            </div>
            <div class="service-modal-actions" id="service-modal-actions">
                <button class="btn-secondary" id="service-modal-cancel">Cancel</button>
                <button class="btn-primary" id="service-modal-submit">Submit</button>
            </div>
        </div>
    </div>

    <!-- Firebase Config Injection - IMPORTANT FOR GITHUB PAGES DEPLOYMENT -->
    <!-- This script provides the necessary global variables for Firebase initialization -->
    <!-- Ensure these values match your actual Firebase project settings. -->
    <script>
        // Your Firebase project configuration
        var __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC8-TWRr_vOMTv72scXxu-9l5uVHRVputo",
            authDomain: "group-saving-chama.firebaseapp.com",
            projectId: "group-saving-chama",
            // FIX 1: Corrected Firebase Storage Bucket
            storageBucket: "group-saving-chama.appspot.com",
            messagingSenderId: "570981365925",
            appId: "1:570981365925:web:42422e51e4e02c6ab4f54c"
        });

        // Your App ID (can be anything unique for your project)
        var __app_id = "group-saving-chama";

        // Optional: If you want to auto-login anonymously at start, set to null otherwise
        var __initial_auth_token = null;
    </script>

    <!-- Firebase SDKs and Main Application Logic -->
    <!-- Moved to the very bottom of <body> to ensure DOM is ready and reduce render-blocking -->
    <script type="module">
        // Firebase imports must be at the top level of the module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, signInWithCustomToken, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Wrap all JavaScript in DOMContentLoaded to ensure HTML is fully parsed before script execution
        document.addEventListener("DOMContentLoaded", () => {

            // Global Firebase variables
            let app;
            let auth;
            let db;
            let currentUserId = null;
            let currentUserName = null;
            let currentUserData = {}; // To store full user profile data

            // Firebase Helper Functions
            // These functions use direct Firestore collection paths.
            // Firestore collections are implicitly created when the first document is added to them.
            function getPublicCollectionPath(collectionName) {
              return collectionName; // Direct collection name
            }

            function getPrivateCollectionPath(userId, collectionName) {
              return collectionName; // Direct collection name
            }

            // Message Box function
            function showMessage(message, type = 'success') {
                const msgBox = document.getElementById('message-box');
                const msgBoxContent = document.getElementById('message-box-content');
                msgBoxContent.textContent = message;
                msgBox.className = `message-box ${type}`; // Reset classes
                setTimeout(() => msgBox.classList.add('show'), 10); // Trigger transition
                // Message will now stay until dismissed by the user clicking the close button
            }

            // Function to hide the message box
            function hideMessageBox() {
                const msgBox = document.getElementById('message-box');
                msgBox.classList.remove('show');
                // Give it a moment to transition out before resetting classes
                setTimeout(() => msgBox.className = 'message-box', 500);
            }

            // Initialize Firebase with the provided configuration
            // Using __firebase_config from the environment, not hardcoded.
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Handle initial authentication state
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .then((userCredential) => {
                        // Signed in successfully
                        console.log("Signed in with custom token:", userCredential.user.uid);
                    })
                    .catch((error) => {
                        console.error("Error signing in with custom token:", error.message);
                        // If custom token sign-in fails, do not attempt anonymous sign-in.
                        // Instead, let the user proceed to login/signup.
                    });
            } else {
                // If no custom token is provided, do not attempt anonymous sign-in.
                // The user will be redirected to the login page by the onAuthStateChanged listener
                // if they try to access authenticated routes.
            }

            // Authentication state change listener
            onAuthStateChanged(auth, async (user) => {
                const dashboardLink = document.getElementById('dashboard-link');
                const logoutButton = document.getElementById('logout-button');
                const dashboardLinkMobile = document.getElementById('dashboard-link-mobile');
                const logoutButtonMobile = document.getElementById('logout-button-mobile');

                // Get references to login/signup links/buttons
                const signupLink = document.getElementById('signup-link');
                const loginLink = document.getElementById('login-link');
                const signupLinkMobile = document.getElementById('signup-link-mobile');
                const loginLinkMobile = document.getElementById('login-link-mobile');


                if (user) {
                    currentUserId = user.uid;
                    console.log(`onAuthStateChanged: User logged in with UID: ${user.uid}`);

                    // Do NOT log out the user immediately if email is not verified.
                    // Instead, keep them authenticated and restrict access based on emailVerified and profile status.

                    dashboardLink.classList.remove('hidden');
                    logoutButton.classList.remove('hidden');
                    dashboardLinkMobile.classList.remove('hidden');
                    logoutButtonMobile.classList.remove('hidden');

                    // Update user info in dashboard if services page is active
                    if (document.getElementById('user-name')) {
                        document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
                        document.getElementById('user-email').textContent = user.email;
                    }
                    
                    // Initialize dashboard if on services page
                    if (window.currentPage === 'services') {
                        showDashboardContent('overview');
                    }

                    // Hide signup and login links/buttons
                    if (signupLink) signupLink.classList.add('hidden');
                    if (loginLink) loginLink.classList.add('hidden');
                    if (signupLinkMobile) signupLinkMobile.classList.add('hidden');
                    if (loginLinkMobile) loginLinkMobile.classList.add('hidden');

                    // Update customers collection with email verification status
                    try {
                        const customerRef = doc(db, 'customers', currentUserId);
                        await updateDoc(customerRef, {
                            emailVerified: user.emailVerified,
                            lastLogin: serverTimestamp()
                        });
                        console.log("Customer collection updated with email verification status");
                    } catch (error) {
                        console.error("Error updating customer collection:", error);
                    }

                    // Fetch user's full name for dashboard welcome and check Firestore profile from customers collection
                    const customerRef = doc(db, 'customers', currentUserId);
                    try {
                        console.log(`Attempting to fetch user profile for UID: ${currentUserId}`);
                        const userDoc = await getDoc(customerRef);
                        if (userDoc.exists()) {
                            currentUserData = userDoc.data();
                            console.log("User profile fetched successfully:", currentUserData);
                            currentUserName = currentUserData.name || user.email;
                        } else {
                            // Profile document missing (e.g., first login after signup, but Firestore write failed or delayed).
                            console.warn("User exists in Firebase Auth but no customer profile found. Creating default profile data.");
                            currentUserData = {
                                uid: currentUserId,
                                name: user.email,
                                email: user.email,
                                phone: "N/A",
                                nationalId: "N/A",
                                contribution_balance: 0,
                                loan_balance: 0,
                                next_meeting_date: "To be announced",
                                status: "pending", // Default to pending
                                profilePicUrl: "",
                                lastLogin: null,
                                emailVerified: false
                            };
                            currentUserName = user.email; // Use email as name fallback
                            // Attempt to save default profile data if it's missing
                            await setDoc(customerRef, currentUserData, { merge: true }); // Use merge:true to avoid overwriting if partial data exists
                            showMessage("Your profile data was incomplete and has been initialized. Please update your profile from the dashboard.", "error");
                        }
                    } catch (error) {
                        console.error("Error fetching or initializing user profile from Firestore:", error);
                        // If there's an error fetching or initializing, still proceed but with a warning
                        currentUserData = { // Ensure currentUserData is populated even on error
                            uid: currentUserId,
                            name: user.email,
                            email: user.email,
                            phone: "N/A",
                            nationalId: "N/A",
                            contribution_balance: 0,
                            loan_balance: 0,
                            next_meeting_date: "To be announced",
                            status: "pending",
                            profilePicUrl: "",
                            lastLogin: null,
                            emailVerified: false
                        };
                        currentUserName = user.email;
                        showMessage("Failed to retrieve or set your full profile. Please refresh or update your profile from the dashboard.", "error");
                    }

                    // If currently on dashboard or if we should redirect to dashboard (after successful login)
                    if (window.location.hash.includes('dashboard') || window.location.hash.includes('login') || window.location.hash === '#home' || window.location.hash === '') {
                        window.renderPage('dashboard');
                    }
                    // Load chat history when user is authenticated and chat modal is open
                    if (chatModalOverlay.classList.contains('show')) {
                        loadChatHistory();
                    }
                } else {
                    currentUserId = null;
                    currentUserName = null;
                    currentUserData = {}; // Clear user data on logout
                    console.log("onAuthStateChanged: User logged out.");

                    dashboardLink.classList.add('hidden');
                    logoutButton.classList.add('hidden');
                    dashboardLinkMobile.classList.add('hidden');
                    logoutButtonMobile.classList.add('hidden');

                    // Show signup and login links/buttons
                    if (signupLink) signupLink.classList.remove('hidden');
                    if (loginLink) loginLink.classList.remove('hidden');
                    if (signupLinkMobile) signupLinkMobile.classList.remove('hidden');
                    if (loginLinkMobile) loginLinkMobile.classList.remove('hidden');

                    // If user logs out or session expires, redirect from dashboard
                    if (window.location.hash.includes('dashboard')) {
                        window.renderPage('login');
                    }
                    // Clear chat messages if user logs out
                    document.getElementById('chat-messages').innerHTML = '';
                    // Unsubscribe from chat listener on logout
                    if (unsubscribeChat) {
                        unsubscribeChat();
                    }
                }
            });


            // Page Content Definitions
            const pages = {
                home: `
                    <section class="text-center py-16 md:py-24 text-white rounded-lg shadow-xl attractive-hero">
                        <div class="max-w-4xl mx-auto">
                            <div class="mb-8">
                                <img src="https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" 
                                     alt="Financial Growth" class="w-24 h-24 mx-auto mb-6 rounded-full object-cover shadow-2xl">
                            </div>
                            <h1 class="text-4xl md:text-6xl font-extrabold mb-6 leading-tight">
                                Empower Your Financial Future with Our 
                                <span class="text-yellow-300">Group Saving Chama</span>!
                            </h1>
                            <p class="text-xl md:text-2xl mb-10 max-w-3xl mx-auto leading-relaxed">
                                Join a thriving community focused on <strong>savings pooling, accessible loans, and smart investment opportunities</strong>.
                                Achieve your financial goals faster, together!
                            </p>
                            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                                <button class="btn-primary text-lg md:text-xl px-8 py-4 transform hover:scale-105 transition-transform duration-300" onclick="window.renderPage('signup')">
                                    <i class="fas fa-rocket mr-2"></i>Join Us Today!
                                </button>
                                <button class="bg-white text-maroon px-8 py-4 rounded-lg font-semibold text-lg hover:bg-gray-100 transition-colors duration-300" onclick="window.renderPage('about')">
                                    <i class="fas fa-info-circle mr-2"></i>Learn More
                                </button>
                            </div>
                        </div>
                    </section>

                    <section class="py-16 md:py-20">
                        <div class="text-center mb-16">
                            <h2 class="text-3xl md:text-5xl font-bold text-maroon mb-4">Why Join Our Chama?</h2>
                            <div class="w-24 h-1 bg-gradient-to-r from-maroon to-yellow-500 mx-auto rounded-full"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="modern-card group">
                                <div class="modern-card-header">
                                    <i class="fas fa-piggy-bank text-3xl mb-4"></i>
                                    <h3 class="text-xl font-semibold">Collective Savings</h3>
                                </div>
                                <div class="modern-card-body">
                                    <p class="text-gray-700 leading-relaxed">Pool resources with like-minded individuals to grow your savings much faster than traditional methods. Our digital platform makes it easy to track and manage your contributions.</p>
                                    <div class="mt-4 flex items-center text-sm text-maroon">
                                        <i class="fas fa-chart-line mr-2"></i>
                                        <span>Average 15% higher returns</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modern-card group">
                                <div class="modern-card-header">
                                    <i class="fas fa-hand-holding-usd text-3xl mb-4"></i>
                                    <h3 class="text-xl font-semibold">Easy Access Loans</h3>
                                </div>
                                <div class="modern-card-body">
                                    <p class="text-gray-700 leading-relaxed">Access affordable loans from the group's pooled funds, often with better terms than conventional banks. Quick approval process and flexible repayment options.</p>
                                    <div class="mt-4 flex items-center text-sm text-maroon">
                                        <i class="fas fa-clock mr-2"></i>
                                        <span>Same-day approval</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modern-card group">
                                <div class="modern-card-header">
                                    <i class="fas fa-chart-pie text-3xl mb-4"></i>
                                    <h3 class="text-xl font-semibold">Investment Opportunities</h3>
                                </div>
                                <div class="modern-card-body">
                                    <p class="text-gray-700 leading-relaxed">Explore collective investment ventures, diversifying your portfolio and maximizing returns as a group. Professional guidance and risk management included.</p>
                                    <div class="mt-4 flex items-center text-sm text-maroon">
                                        <i class="fas fa-shield-alt mr-2"></i>
                                        <span>Risk-managed investments</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="py-16 bg-gradient-to-r from-gray-50 to-white">
                        <div class="container mx-auto px-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                                <div>
                                    <h2 class="text-3xl md:text-4xl font-bold text-maroon mb-6">Join Over 500+ Members</h2>
                                    <p class="text-lg text-gray-700 mb-8 leading-relaxed">
                                        Our community has grown to include members from all walks of life, united by the common goal of financial empowerment. 
                                        Experience the power of collective savings and mutual support.
                                    </p>
                                    <div class="grid grid-cols-2 gap-6">
                                        <div class="text-center">
                                            <div class="text-3xl font-bold text-maroon mb-2">500+</div>
                                            <div class="text-sm text-gray-600">Active Members</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-3xl font-bold text-maroon mb-2">KSh 2M+</div>
                                            <div class="text-sm text-gray-600">Total Savings</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-3xl font-bold text-maroon mb-2">98%</div>
                                            <div class="text-sm text-gray-600">Satisfaction Rate</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-3xl font-bold text-maroon mb-2">24/7</div>
                                            <div class="text-sm text-gray-600">Support Available</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="relative">
                                    <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" 
                                         alt="Community Meeting" class="rounded-lg shadow-2xl w-full h-80 object-cover">
                                    <div class="absolute inset-0 bg-gradient-to-t from-maroon to-transparent opacity-20 rounded-lg"></div>
                                </div>
                            </div>
                        </div>
                    </section>
                `,
                about: `
                    <section class="py-12 md:py-16">
                        <div class="text-center mb-12">
                            <h1 class="text-4xl md:text-5xl font-bold text-maroon mb-6">About Prince Alex Digital</h1>
                            <div class="w-24 h-1 bg-gradient-to-r from-maroon to-yellow-500 mx-auto rounded-full mb-8"></div>
                            <p class="text-xl text-gray-600 max-w-3xl mx-auto">Empowering communities through innovative digital group savings solutions</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center mb-16">
                            <div>
                                <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" 
                                     alt="Digital Finance" class="rounded-lg shadow-2xl w-full h-80 object-cover">
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold text-maroon mb-6">What is Prince Alex Digital Group Saving Chama?</h2>
                                <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                                    The Prince Alex Digital Group Saving Chama is a modern, technology-driven rotating savings and credit association (ROSCA) 
                                    that combines traditional community savings principles with cutting-edge digital solutions.
                                </p>
                                <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                                    Our platform enables members to contribute regularly to a common fund, access affordable loans, and participate in 
                                    collective investment opportunities - all while fostering financial literacy and mutual support within our community.
                                </p>
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center text-maroon">
                                        <i class="fas fa-shield-alt text-2xl mr-3"></i>
                                        <span class="font-semibold">Secure & Transparent</span>
                                    </div>
                                    <div class="flex items-center text-maroon">
                                        <i class="fas fa-mobile-alt text-2xl mr-3"></i>
                                        <span class="font-semibold">Mobile-First</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modern-card mb-12">
                            <div class="modern-card-header">
                                <h2 class="text-2xl font-semibold">Our Mission & Vision</h2>
                            </div>
                            <div class="modern-card-body">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h3 class="text-xl font-semibold text-maroon mb-4 flex items-center">
                                            <i class="fas fa-bullseye mr-3"></i>Our Mission
                                        </h3>
                                        <p class="text-gray-700 leading-relaxed">
                                            To democratize access to financial services by providing a secure, transparent, and user-friendly platform 
                                            that empowers individuals and communities to achieve their financial goals through collective savings and mutual support.
                                        </p>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-semibold text-maroon mb-4 flex items-center">
                                            <i class="fas fa-eye mr-3"></i>Our Vision
                                        </h3>
                                        <p class="text-gray-700 leading-relaxed">
                                            To become the leading digital platform for group savings in East Africa, fostering financial inclusion 
                                            and economic empowerment for communities across the region.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                            <h2 class="text-2xl font-semibold text-maroon mb-4">Our Rules & Operation</h2>
                            <ul class="list-disc list-inside text-gray-700 mb-4 space-y-2">
                                <li><strong>Membership:</strong> Open to individuals committed to financial growth and community support.</li>
                                <li><strong>Contributions:</strong> Each member contributes a fixed amount (e.g., KES 1,000) weekly/monthly on a pre-agreed date.</li>
                                <li><strong>Disbursement:</strong> The accumulated fund is disbursed to one member in rotation. The order is agreed upon by the group.</li>
                                <li><strong>Loans:</strong> Members can apply for loans from the Chama's fund. Loan terms, interest rates, and repayment schedules are determined by group consensus.</li>
                                <li><strong>Meetings:</strong> Regular meetings (e.g., monthly) are held to discuss finances, approve loans, admit new members, and plan investments.</li>
                                <li><strong>Transparency:</strong> All financial transactions are recorded and made accessible to members.</li>
                                <li><strong>Investment:</strong> A portion of the Chama's funds can be set aside for collective investments as agreed by members.</li>
                            </ul>

                            <h2 class="2xl font-semibold text-maroon mb-4">Benefits of Joining</h2>
                            <ul class="list-disc list-inside text-gray-700 space-y-2">
                                <li><strong>Financial Discipline:</b> Encourages regular saving habits.</li>
                                <li><strong>Access to Capital:</strong> Provides a source of funds for personal projects or emergencies without complex bank procedures.</li>
                                <li><strong>Investment Opportunities:</strong> Participate in larger investments than you might be able individually.</li>
                                <li><strong>Networking:</strong> Connect with a supportive community and learn from diverse financial experiences.</li>
                                <li><strong>Financial Literacy:</b> Learn about managing finances, budgeting, and investment strategies.</li>
                            </ul>
                        </div>
                    </section>
                `,
                services: `
                    <section class="py-16 md:py-20">
                        <!-- Hero Section -->
                        <div class="text-center mb-16">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-maroon to-maroon-light rounded-full mb-6">
                                <i class="fas fa-cogs text-white text-3xl"></i>
                            </div>
                            <h1 class="text-4xl md:text-6xl font-bold text-maroon mb-6">Our Services</h1>
                            <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                                Comprehensive digital solutions for modern group savings management. 
                                Everything you need to grow your financial future, all in one place.
                            </p>
                        </div>
                        
                        <!-- Services Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
                            <!-- Financial Services -->
                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-money-bill-wave text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Make Contributions</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Seamlessly contribute to your Chama with multiple payment options. 
                                        Track your contributions in real-time.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('make-contribution')">
                                        <i class="fas fa-plus mr-2"></i>Make Contribution
                                    </button>
                            </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-hand-holding-usd text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Request Loans</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Access affordable loans from the Chama fund with competitive rates 
                                        and flexible repayment terms.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('request-loan')">
                                        <i class="fas fa-file-signature mr-2"></i>Request Loan
                                    </button>
                            </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-file-invoice text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Financial Statements</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Access detailed financial reports and statements. 
                                        Monitor your financial health and progress.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('view-statements')">
                                        <i class="fas fa-chart-line mr-2"></i>View Statements
                                    </button>
                            </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-history text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Contribution History</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Track your contribution history and savings progress. 
                                        View detailed transaction records.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('contribution-history')">
                                        <i class="fas fa-clock mr-2"></i>View History
                                    </button>
                            </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-money-check-alt text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Loan History</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Monitor all your loan applications, approvals, and repayment history. 
                                        Stay on top of your financial obligations.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('loan-history')">
                                        <i class="fas fa-receipt mr-2"></i>View Loan History
                                    </button>
                            </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-chart-pie text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Group Overview</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Get comprehensive insights into Chama performance, 
                                        member statistics, and collective financial health.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('group-overview')">
                                        <i class="fas fa-eye mr-2"></i>View Overview
                                    </button>
                                </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-calendar-alt text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Meeting Management</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Stay informed about upcoming meetings, access agendas, 
                                        and review minutes from past sessions.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('meetings')">
                                        <i class="fas fa-calendar-check mr-2"></i>View Meetings
                                    </button>
                                </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-chart-line text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Investment Opportunities</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Explore collective investment opportunities and 
                                        participate in promising ventures with the group.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('investments')">
                                        <i class="fas fa-trending-up mr-2"></i>View Investments
                                    </button>
                                </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-user-edit text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Profile Management</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Update your personal information, contact details, 
                                        and preferences to keep your profile current.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('update-profile')">
                                        <i class="fas fa-user-cog mr-2"></i>Manage Profile
                                    </button>
                                </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-bell text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Notifications</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Stay updated with important announcements, 
                                        meeting reminders, and payment notifications.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('notifications')">
                                        <i class="fas fa-bell mr-2"></i>View Notifications
                                    </button>
                                </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-chart-bar text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Reports & Analytics</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Access detailed reports on your financial performance 
                                        and comprehensive analytics to track progress.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('reports')">
                                        <i class="fas fa-chart-bar mr-2"></i>View Reports
                                    </button>
                                </div>
                            </div>

                            <div class="group relative bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 overflow-hidden border border-gray-100">
                                <div class="absolute inset-0 bg-gradient-to-br from-maroon/5 to-maroon-light/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="relative p-8">
                                    <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-r from-maroon to-maroon-light rounded-2xl mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-shield-alt text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Security & Support</h3>
                                    <p class="text-gray-600 mb-6 leading-relaxed">
                                        Access security features, change passwords, and get support. 
                                        Your data is protected with enterprise-grade security.
                                    </p>
                                    <button class="w-full bg-gradient-to-r from-maroon to-maroon-light text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1" onclick="openServiceModal('security-support')">
                                        <i class="fas fa-shield-alt mr-2"></i>Security Center
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Call to Action Section -->
                        <div class="relative overflow-hidden bg-gradient-to-r from-maroon via-maroon-light to-maroon rounded-3xl p-12 text-center text-white">
                            <div class="absolute inset-0 bg-black/10"></div>
                            <div class="relative z-10">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-white/20 rounded-full mb-8">
                                    <i class="fas fa-rocket text-white text-3xl"></i>
                                </div>
                                <h2 class="text-4xl font-bold mb-6">Ready to Transform Your Financial Future?</h2>
                                <p class="text-xl mb-8 opacity-90 max-w-2xl mx-auto">
                                    Join thousands of members who are already building wealth through our innovative 
                                    group savings platform. Start your journey today!
                                </p>
                                <div class="flex flex-col sm:flex-row gap-6 justify-center">
                                    <button class="bg-white text-maroon px-10 py-4 rounded-2xl font-bold text-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-lg" onclick="window.renderPage('signup')">
                                        <i class="fas fa-user-plus mr-3"></i>Get Started Free
                                    </button>
                                    <button class="border-2 border-white text-white px-10 py-4 rounded-2xl font-bold text-lg hover:bg-white hover:text-maroon transition-all duration-300 transform hover:scale-105" onclick="window.renderPage('login')">
                                        <i class="fas fa-sign-in-alt mr-3"></i>Sign In
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                `,
                signup: `
                    <section class="py-8 md:py-12 flex justify-center items-center">
                        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border-t-4 border-maroon">
                            <h1 class="text-3xl font-bold text-maroon text-center mb-6">Create Your Account</h1>
                            <form id="signup-form" class="space-y-4">
                                <div>
                                    <label for="signup-name" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                                    <input type="text" id="signup-name" class="input-field" placeholder="John Doe" required>
                                </div>
                                <div>
                                    <label for="signup-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                    <input type="email" id="signup-email" class="input-field" placeholder="you@example.com" required>
                                </div>
                                <div>
                                    <label for="signup-phone" class="block text-700 text-sm font-bold mb-2">Phone Number</label>
                                    <input type="tel" id="signup-phone" class="input-field" placeholder="+254 7XX XXX XXX" required pattern="^\\+?\\d{10,14}$">
                                </div>
                                <div>
                                    <label for="signup-national-id" class="block text-gray-700 text-sm font-bold mb-2">National ID</label>
                                    <input type="text" id="signup-national-id" class="input-field" placeholder="12345678" required>
                                </div>
                                <div>
                                    <label for="signup-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                                    <input type="password" id="signup-password" class="input-field" placeholder="Minimum 6 characters" required minlength="6">
                                </div>
                                <div>
                                    <label for="signup-confirm-password" class="block text-gray-700 text-sm font-bold mb-2">Confirm Password</label>
                                    <input type="password" id="signup-confirm-password" class="input-field" placeholder="Re-enter password" required>
                                </div>
                                <button type="submit" class="btn-primary w-full">Sign Up</button>
                            </form>
                            <p class="text-center text-gray-600 text-sm mt-4">
                                Already have an account? <a href="#login" class="link-maroon" onclick="openServiceModal('service-name')">Log In</a>
                            </p>
                        </div>
                    </section>
                `,
                'pending-approval': `
                    <section class="py-8 md:py-12 flex justify-center items-center">
                        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border-t-4 border-maroon text-center">
                            <h1 class="text-3xl font-bold text-maroon mb-4">Account Pending Approval</h1>
                            <p class="text-gray-700 mb-6">
                                Thank you for signing up! Your information has been successfully submitted and is currently
                                under review by the Chama administrators.
                            </p>
                            <p class="text-gray-700 font-semibold mb-4">
                                You will receive an email notification once your account has been approved.
                            </p>
                            <h2 class="text-2xl font-bold text-maroon mb-4">Requirements for Service Access:</h2>
                            <p class="text-gray-700 mb-4">
                                Once your account is approved, you will need to ensure the following to fully utilize all Chama services:
                            </p>
                            <ul class="list-disc list-inside text-gray-700 text-left mx-auto max-w-xs space-y-2">
                                <li>Complete your initial **Chama contribution**.</li>
                                <li>Attend the **next scheduled Chama meeting** (physical or virtual).</li>
                                <li>Familiarize yourself with the **Chama Constitution and Bylaws**.</li>
                                <li>Verify your **contact details** for seamless communication.</li>
                            </ul>
                            <p class="text-gray-600 text-sm mt-6">
                                If you have any questions, please contact us at princealexdigital@gmail.com.
                            </p>
                        </div>
                    </section>
                `,
                login: `
                    <section class="py-8 md:py-12 flex justify-center items-center">
                        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border-t-4 border-maroon">
                            <h1 class="text-3xl font-bold text-maroon text-center mb-6">Login to Your Account</h1>
                            <form id="login-form" class="space-y-4">
                                <div>
                                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                    <input type="email" id="login-email" class="input-field" placeholder="you@example.com" required>
                                </div>
                                <div>
                                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                                    <input type="password" id="login-password" class="input-field" placeholder="Your password" required>
                                </div>
                                <button type="submit" class="btn-primary w-full">Login</button>
                            </form>
                            <p class="text-center text-gray-600 text-sm mt-4">
                                <a href="#forgot-password" class="link-maroon" onclick="window.renderPage('forgot-password')">Forgot Password?</a>
                            </p>
                            <p class="text-center text-gray-600 text-sm mt-2">
                                Don't have an account? <a href="#signup" class="link-maroon" onclick="window.renderPage('signup')">Sign Up</a>
                            </p>
                        </div>
                    </section>
                `,
                'forgot-password': `
                    <section class="py-8 md:py-12 flex justify-center items-center">
                        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border-t-4 border-maroon">
                            <h1 class="text-3xl font-bold text-maroon text-center mb-6">Reset Password</h1>
                            <p class="text-gray-700 text-center mb-6">Enter your email address to receive a password reset link.</p>
                            <form id="forgot-password-form" class="space-y-4">
                                <div>
                                    <label for="reset-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                    <input type="email" id="reset-email" class="input-field" placeholder="you@example.com" required>
                                </div>
                                <button type="submit" class="btn-primary w-full">Send Reset Link</button>
                            </form>
                            <p class="text-center text-gray-600 text-sm mt-4">
                                Remembered your password? <a href="#login" class="link-maroon" onclick="openServiceModal('service-name')">Log In</a>
                            </p>
                        </div>
                    </section>
                `,
                dashboard: `
                    <section class="py-8 md:py-12">
                        <!-- Welcome Header -->
                        <div class="text-center mb-12">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-maroon to-maroon-light rounded-full mb-6">
                                <i class="fas fa-user-circle text-white text-3xl"></i>
                            </div>
                            <h1 class="text-4xl md:text-5xl font-bold text-maroon mb-4">
                                Welcome, <span id="dashboard-user-name" class="text-maroon-light">Member!</span>
                            </h1>
                            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                                Manage your Chama activities and track your financial progress
                            </p>
                        </div>

                        <!-- User Info Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-blue-500">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                                        <i class="fas fa-id-card text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">User ID</p>
                                        <p class="text-lg font-bold text-gray-800" id="display-user-id">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                                        <i class="fas fa-envelope text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">Email</p>
                                        <p class="text-lg font-bold text-gray-800" id="dashboard-user-email">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-purple-500">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                                        <i class="fas fa-phone text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">Phone</p>
                                        <p class="text-lg font-bold text-gray-800" id="dashboard-user-phone">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-orange-500">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-orange-100 text-orange-600 mr-4">
                                        <i class="fas fa-id-badge text-xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-600">National ID</p>
                                        <p class="text-lg font-bold text-gray-800" id="dashboard-user-national-id">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm font-medium">Contribution Balance</p>
                                        <p class="text-3xl font-bold" id="contribution-balance">KSh 0.00</p>
                                    </div>
                                    <div class="p-3 rounded-full bg-white/20">
                                        <i class="fas fa-money-bill-wave text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-2xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-yellow-100 text-sm font-medium">Loan Balance</p>
                                        <p class="text-3xl font-bold" id="loan-balance">KSh 0.00</p>
                                    </div>
                                    <div class="p-3 rounded-full bg-white/20">
                                        <i class="fas fa-hand-holding-usd text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100 text-sm font-medium">Next Meeting</p>
                                        <p class="text-lg font-bold" id="next-meeting-date">Not Scheduled</p>
                                    </div>
                                    <div class="p-3 rounded-full bg-white/20">
                                        <i class="fas fa-calendar-alt text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions Section -->
                        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                                <p class="text-gray-600">Access your most frequently used features</p>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                <button class="group bg-gradient-to-br from-maroon to-maroon-light p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 text-white" onclick="openDashboardModal('make-contribution')">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-money-bill-wave text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-bold mb-2">Make Contribution</h3>
                                        <p class="text-sm opacity-90">Record your savings</p>
                                    </div>
                                </button>
                                
                                <button class="group bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 text-white" onclick="openDashboardModal('request-loan')">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-hand-holding-usd text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-bold mb-2">Request Loan</h3>
                                        <p class="text-sm opacity-90">Apply for funding</p>
                                    </div>
                                </button>
                                
                                <button class="group bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 text-white" onclick="openDashboardModal('view-statements')">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-file-invoice text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-bold mb-2">View Statements</h3>
                                        <p class="text-sm opacity-90">Check your records</p>
                                    </div>
                                </button>
                                
                                <button class="group bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 text-white" onclick="openDashboardModal('update-profile')">
                                    <div class="text-center">
                                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                                            <i class="fas fa-user-edit text-2xl"></i>
                                        </div>
                                        <h3 class="text-lg font-bold mb-2">Update Profile</h3>
                                        <p class="text-sm opacity-90">Manage your info</p>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- All Features Section -->
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">All Features</h2>
                                <p class="text-gray-600">Complete access to all Chama management tools</p>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('contribution-history')">
                                    <i class="fas fa-history text-maroon text-xl mb-2"></i>
                                    <span>Contribution History</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('loan-history')">
                                    <i class="fas fa-money-check-alt text-maroon text-xl mb-2"></i>
                                    <span>Loan History</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('group-overview')">
                                    <i class="fas fa-chart-pie text-maroon text-xl mb-2"></i>
                                    <span>Group Overview</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('meetings')">
                                    <i class="fas fa-calendar-alt text-maroon text-xl mb-2"></i>
                                    <span>Meetings</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('fines')">
                                    <i class="fas fa-gavel text-maroon text-xl mb-2"></i>
                                    <span>Fines & Penalties</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('investments')">
                                    <i class="fas fa-chart-line text-maroon text-xl mb-2"></i>
                                    <span>Investments</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('notifications')">
                                    <i class="fas fa-bell text-maroon text-xl mb-2"></i>
                                    <span>Notifications</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('voting-polls')">
                                    <i class="fas fa-vote-yea text-maroon text-xl mb-2"></i>
                                    <span>Voting & Polls</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('attendance')">
                                    <i class="fas fa-clipboard-check text-maroon text-xl mb-2"></i>
                                    <span>Attendance</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('documents')">
                                    <i class="fas fa-folder-open text-maroon text-xl mb-2"></i>
                                    <span>Documents</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('reports')">
                                    <i class="fas fa-chart-bar text-maroon text-xl mb-2"></i>
                                    <span>Reports</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('analytics')">
                                    <i class="fas fa-analytics text-maroon text-xl mb-2"></i>
                                    <span>Analytics</span>
                                </button>
                                <button class="dashboard-feature-btn" onclick="openDashboardModal('settings')">
                                    <i class="fas fa-cog text-maroon text-xl mb-2"></i>
                                    <span>Settings</span>
                                </button>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="mt-8 bg-gradient-to-r from-gray-100 to-gray-200 p-6 rounded-2xl border-l-4 border-gray-500">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-gray-500 text-white mr-4">
                                    <i class="fas fa-shield-alt text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Data Security & Backups</h3>
                                    <p class="text-gray-700">
                                        Your financial data is protected with automatic backups and secure SSL encryption for all communications.
                                        We prioritize the safety and integrity of your information.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </section>
                `,
            };

            const dashboardSubpages = {
                'make-contribution': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Make A Contribution</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <form id="contribution-form" class="space-y-4">
                            <div>
                                <label for="contribution-amount" class="block text-gray-700 text-sm font-bold mb-2">Amount (KSh)</label>
                                <input type="number" id="contribution-amount" class="input-field" placeholder="e.g., 1000" required min="1">
                            </div>
                            <div>
                                <label for="payment-method" class="block text-gray-700 text-sm font-bold mb-2">Payment Method</label>
                                <select id="payment-method" class="input-field" required>
                                    <option value="">Select Method</option>
                                    <option value="mpesa">M-Pesa</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                </select>
                            </div>
                            <div>
                                <label for="contribution-description" class="block text-gray-700 text-sm font-bold mb-2">Description (Optional)</label>
                                <input type="text" id="contribution-description" class="input-field" placeholder="e.g., Monthly savings" >
                            </div>
                            <p class="text-sm text-gray-600">Note: M-Pesa integration requires backend setup for automated processing. Currently, this is a manual entry system.</p>
                            <button type="submit" class="btn-primary w-full">Record Contribution</button>
                        </form>
                    </div>
                `,
                'request-loan': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Request A Loan</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <form id="loan-request-form" class="space-y-4">
                            <div>
                                <label for="loan-amount" class="block text-gray-700 text-sm font-bold mb-2">Loan Amount (KSh)</label>
                                <input type="number" id="loan-amount" class="input-field" placeholder="e.g., 10000" required min="100">
                            </div>
                            <div>
                                <label for="loan-interest-rate" class="block text-gray-700 text-sm font-bold mb-2">Interest Rate (%)</label>
                                <input type="number" id="loan-interest-rate" class="input-field" placeholder="e.g., 5" required min="0" max="100" step="0.1">
                            </div>
                            <div>
                                <label for="loan-due-date" class="block text-gray-700 text-sm font-bold mb-2">Due Date</label>
                                <input type="date" id="loan-due-date" class="input-field" required>
                            </div>
                            <div>
                                <label for="repayment-plan" class="block text-gray-700 text-sm font-bold mb-2">Preferred Repayment Plan</label>
                                <select id="repayment-plan" class="input-field" required>
                                    <option value="">Select Plan</option>
                                    <option value="3_months">3 Months</option>
                                    <option value="6_months">6 Months</option>
                                    <option value="12_months">12 Months</option>
                                </select>
                            </div>
                            <div>
                                <label for="loan-purpose" class="block text-gray-700 text-sm font-bold mb-2">Purpose of Loan</label>
                                <textarea id="loan-purpose" class="input-field h-24" placeholder="Briefly describe why you need the loan..." required></textarea>
                            </div>
                            <p class="text-sm text-gray-600">Loan requests are subject to admin approval and Chama rules.</p>
                            <button type="submit" class="btn-primary w-full">Submit Loan Request</button>
                        </form>
                    </div>
                `,
                'view-statements': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">My Statements</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y">
                        <p class="text-gray-700 mb-4">Here you can view your detailed financial statements, including contributions, loans, fines, and interest earned.</p>
                        <table class="table-auto" id="statements-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Amount (KSh)</th>
                                    <th>Balance (KSh)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                        <p class="text-sm text-gray-600 mt-4">For official reports or to export your full statement, please contact an administrator.</p>
                    </div>
                `,
                'update-profile': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Update Your Profile</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <form id="update-profile-form" class="space-y-4">
                            <div>
                                <label for="profile-name" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                                <input type="text" id="profile-name" class="input-field" value="${currentUserData.name || ''}" required>
                            </div>
                            <div>
                                <label for="profile-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                                <input type="email" id="profile-email" class="input-field" value="${currentUserData.email || ''}" disabled>
                                <p class="text-xs text-gray-500 mt-1">Email cannot be changed directly here.</p>
                            </div>
                            <div>
                                <label for="profile-phone" class="block text-gray-700 text-sm font-bold mb-2">Phone Number</label>
                                <input type="tel" id="profile-phone" class="input-field" value="${currentUserData.phone || ''}" required pattern="^\\+?\\d{10,14}$">
                            </div>
                            <div>
                                <label for="profile-national-id" class="block text-gray-700 text-sm font-bold mb-2">National ID</label>
                                <input type="text" id="profile-national-id" class="input-field" value="${currentUserData.nationalId || ''}" required>
                            </div>
                            <div>
                                <label for="profile-pic-url" class="block text-gray-700 text-sm font-bold mb-2">Profile Picture URL (Optional)</label>
                                <input type="url" id="profile-pic-url" class="input-field" placeholder="https://example.com/your-image.jpg" value="${currentUserData.profilePicUrl || ''}">
                            </div>
                            <button type="submit" class="btn-primary w-full">Save Profile Updates</button>
                        </form>
                    </div>
                `,
                'contribution-history': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Contribution History</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y">
                        <p class="text-gray-700 mb-4">A record of all your contributions to the Chama.</p>
                        <table class="table-auto" id="contribution-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount (KSh)</th>
                                    <th>Method</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                `,
                'loan-history': `
                    <h2 class="2xl font-bold text-maroon mb-6 text-center">Loan History</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y">
                        <p class="text-gray-700 mb-4">Details of your past and active loans.</p>
                        <table class="table-auto" id="loan-history-table">
                            <thead>
                                <tr>
                                    <th>Loan Date</th>
                                    <th>Amount (KSh)</th>
                                    <th>Interest Rate (%)</th>
                                    <th>Due Date</th>
                                    <th>Repaid (KSh)</th>
                                    <th>Balance (KSh)</th>
                                    <th>Status</th>
                                    <th>Purpose</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                `,
                'group-overview': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Group Financial Overview</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                            <div class="p-4 bg-white rounded-lg shadow">
                                <h3 class="text-lg font-semibold text-maroon">Total Group Savings</h3>
                                <p class="text-3xl font-bold text-gray-800" id="group-total-savings">KSh 0.00</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <h3 class="text-lg font-semibold text-maroon">Total Loans Issued</h3>
                                <p class="text-3xl font-bold text-gray-800" id="group-total-loans">KSh 0.00</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <h3 class="text-lg font-semibold text-maroon">Funds Available</h3>
                                <p class="text-3xl font-bold text-gray-800" id="group-funds-available">KSh 0.00</p>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-4">Visual representation of group funds would go here (e.g., bar charts for contributions, pie chart for fund distribution).</p>
                        <div class="bg-gray-200 h-48 flex items-center justify-center rounded-md text-gray-500">
                            [Placeholder for Charts: e.g., Chart.js or D3.js integration]
                        </div>
                        <p class="text-sm text-gray-600 mt-4">Actual data fetching and chart rendering would require further implementation.</p>
                    </div>
                `,
                'meetings': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Upcoming Meetings & Notices</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y" id="meetings-list">
                        <p class="text-gray-700 mb-4">Stay updated with our Chama's meeting schedules and important announcements.</p>
                        <!-- Dynamic meeting entries will be inserted here -->
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-xl font-semibold text-maroon mb-3">Add New Meeting (Admin Only)</h3>
                        <form id="add-meeting-form" class="space-y-4">
                            <div>
                                <label for="meeting-title" class="block text-gray-700 text-sm font-bold mb-2">Title</label>
                                <input type="text" id="meeting-title" class="input-field" placeholder="e.g., Monthly Review Meeting" required>
                            </div>
                            <div>
                                <label for="meeting-date" class="block text-gray-700 text-sm font-bold mb-2">Date</label>
                                <input type="date" id="meeting-date" class="input-field" required>
                            </div>
                            <div>
                                <label for="meeting-time" class="block text-gray-700 text-sm font-bold mb-2">Time</label>
                                <input type="time" id="meeting-time" class="input-field" required>
                            </div>
                            <div>
                                <label for="meeting-location" class="block text-gray-700 text-sm font-bold mb-2">Location</label>
                                <input type="text" id="meeting-location" class="input-field" placeholder="e.g., Virtual (Google Meet)" required>
                            </div>
                            <div>
                                <label for="meeting-description" class="block text-gray-700 text-sm font-bold mb-2">Description (Optional)</label>
                                <textarea id="meeting-description" class="input-field h-24" placeholder="Briefly describe agenda or purpose..."></textarea>
                            </div>
                            <div>
                                <label for="meeting-type" class="block text-gray-700 text-sm font-bold mb-2">Type</label>
                                <select id="meeting-type" class="input-field" required>
                                    <option value="meeting">Meeting</option>
                                    <option value="notice">Notice</option>
                                </select>
                            </div>
                            <button type="submit" class="btn-primary w-full">Add Meeting</button>
                        </form>
                    </div>
                `,
                'fines': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Fines & Penalties</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y">
                        <p class="text-gray-700 mb-4">Track any accrued fines and penalties according to Chama rules.</p>
                        <table class="table-auto" id="fines-table">
                            <thead>
                                <tr>
                                    <th>Date Issued</th>
                                    <th>Reason</th>
                                    <th>Amount (KSh)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                        <p class="text-sm text-gray-600 mt-4">Fines are calculated based on preset Chama rules (e.g., KES 100 for each missed meeting). Admin access is required for adjustments.</p>
                    </div>
                `,
                'investments': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Investment Opportunities</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y" id="investments-list">
                        <p class="text-gray-700 mb-4">Explore and pledge contributions towards various group investment projects.</p>
                        <!-- Dynamic investment entries will be inserted here -->
                    </div>
                     <div class="bg-gray-50 p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-xl font-semibold text-maroon mb-3">Add New Investment (Admin Only)</h3>
                        <form id="add-investment-form" class="space-y-4">
                            <div>
                                <label for="investment-title" class="block text-gray-700 text-sm font-bold mb-2">Investment Title</label>
                                <input type="text" id="investment-title" class="input-field" placeholder="e.g., Land Acquisition" required>
                            </div>
                            <div>
                                <label for="investment-amount" class="block text-gray-700 text-sm font-bold mb-2">Goal Amount (KSh)</label>
                                <input type="number" id="investment-amount" class="input-field" placeholder="e.g., 5000000" required min="1000">
                            </div>
                            <div>
                                <label for="investment-description" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                                <textarea id="investment-description" class="input-field h-24" placeholder="Briefly describe the investment..." required></textarea>
                            </div>
                            <button type="submit" class="btn-primary w-full">Add Investment</button>
                        </form>
                    </div>
                `,
                'forum': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Discussion Forum</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <p class="text-gray-700 mb-4">This is your space to discuss Chama matters, share ideas, and connect with other members.</p>
                        <div class="border border-gray-300 rounded-lg p-4 mb-4 bg-white" id="forum-posts">
                            <!-- Forum posts will be loaded here -->
                        </div>
                        <div class="mt-6">
                            <textarea id="forum-post-content" class="input-field h-24" placeholder="Type your message here..."></textarea>
                            <button class="btn-primary mt-2" id="post-forum-message">Post Message</button>
                        </div>
                        <p class="text-sm text-gray-600 mt-4">Full real-time chat functionality and message storage requires dedicated backend implementation.</p>
                    </div>
                `,
                'notifications': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Your Notifications</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y" id="notifications-list">
                        <p class="text-gray-700 mb-4">Stay informed with important updates and alerts regarding your Chama activities.</p>
                        <!-- Dynamic notifications will be inserted here -->
                    </div>
                `,
                'voting-polls': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Member Voting & Polls</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y" id="polls-list">
                        <p class="text-gray-700 mb-4">Participate in important Chama decisions through secure online voting.</p>
                        <!-- Dynamic polls will be inserted here -->
                    </div>
                     <div class="bg-gray-50 p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-xl font-semibold text-maroon mb-3">Create New Poll (Admin Only)</h3>
                        <form id="create-poll-form" class="space-y-4">
                            <div>
                                <label for="poll-title" class="block text-gray-700 text-sm font-bold mb-2">Poll Title/Question</label>
                                <input type="text" id="poll-title" class="input-field" placeholder="e.g., Should we invest in Project X?" required>
                            </div>
                            <div>
                                <label for="poll-options" class="block text-gray-700 text-sm font-bold mb-2">Options (comma-separated)</label>
                                <input type="text" id="poll-options" class="input-field" placeholder="e.g., Yes, No, Abstain" required>
                            </div>
                            <button type="submit" class="btn-primary w-full">Create Poll</button>
                        </form>
                    </div>
                `,
                'attendance': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Attendance Register</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y">
                        <p class="text-gray-700 mb-4">Mark your attendance for meetings and view your attendance history.</p>
                        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold text-maroon mb-3">Mark My Attendance (Manual Entry)</h3>
                            <form id="attendance-form" class="space-y-4">
                                <div>
                                    <label for="attendance-meeting-id" class="block text-gray-700 text-sm font-bold mb-2">Meeting ID (Optional)</label>
                                    <input type="text" id="attendance-meeting-id" class="input-field" placeholder="e.g., meeting_xyz123">
                                    <p class="text-xs text-gray-500 mt-1">If linking to a specific meeting, enter its ID.</p>
                                </div>
                                <div>
                                    <label for="attendance-date" class="block text-gray-700 text-sm font-bold mb-2">Meeting Date</label>
                                    <input type="date" id="attendance-date" class="input-field" required>
                                </div>
                                <div>
                                    <label for="attendance-time" class="block text-gray-700 text-sm font-bold mb-2">Time</label>
                                    <input type="time" id="attendance-time" class="input-field" required>
                                </div>
                                <button type="submit" class="btn-primary w-full">Record Attendance</button>
                            </form>
                            <p class="text-sm text-gray-600 mt-4">For automated attendance, QR code scanning integration would be required.</p>
                        </div>

                        <h3 class="text-xl font-semibold text-maroon mb-3">My Attendance History</h3>
                        <table class="table-auto" id="attendance-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Meeting Type</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                `,
                'documents': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Group Documents</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md scroll-y" id="documents-list">
                        <p class="text-gray-700 mb-4">Access important Chama documents securely.</p>
                        <!-- Dynamic document entries will be inserted here -->
                    </div>
                     <div class="bg-gray-50 p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-xl font-semibold text-maroon mb-3">Upload New Document (Admin Only)</h3>
                        <form id="upload-document-form" class="space-y-4">
                            <div>
                                <label for="document-title" class="block text-gray-700 text-sm font-bold mb-2">Document Title</label>
                                <input type="text" id="document-title" class="input-field" placeholder="e.g., Chama Constitution V2.0" required>
                            </div>
                            <div>
                                <label for="document-file-url" class="block text-gray-700 text-sm font-bold mb-2">Document File URL</label>
                                <input type="url" id="document-file-url" class="input-field" placeholder="https://example.com/document.pdf" required>
                            </div>
                            <button type="submit" class="btn-primary w-full">Upload Document</button>
                        </form>
                    </div>
                `,
                'reports': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Reports</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <p class="text-gray-700 mb-4">Generate and view financial reports for your Chama activities.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <button onclick="generateUserReport('financial')" class="btn-primary text-lg flex items-center justify-center space-x-2">
                                <i class="fas fa-chart-line"></i> <span>Financial Report</span>
                            </button>
                            <button onclick="generateUserReport('contribution')" class="btn-primary text-lg flex items-center justify-center space-x-2">
                                <i class="fas fa-money-bill-wave"></i> <span>Contribution Report</span>
                            </button>
                        </div>
                        <div id="reports-list" class="space-y-4">
                            <!-- Dynamic reports will be inserted here -->
                        </div>
                    </div>
                `,
                'analytics': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Analytics Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-100 p-4 rounded-lg shadow-md border-l-4 border-maroon">
                            <h3 class="text-xl font-semibold text-maroon mb-2">My Contributions</h3>
                            <p class="text-3xl font-bold text-gray-800" id="user-total-contributions">KSh 0.00</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg shadow-md border-l-4 border-maroon">
                            <h3 class="text-xl font-semibold text-maroon mb-2">Active Loans</h3>
                            <p class="text-3xl font-bold text-gray-800" id="user-active-loans">0</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg shadow-md border-l-4 border-maroon">
                            <h3 class="text-xl font-semibold text-maroon mb-2">Attendance Rate</h3>
                            <p class="text-3xl font-bold text-gray-800" id="user-attendance-rate">0%</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-maroon mb-4">My Activity Timeline</h3>
                        <div id="user-activity-timeline" class="space-y-4">
                            <!-- Dynamic activity will be inserted here -->
                        </div>
                    </div>
                `,
                'settings': `
                    <h2 class="text-2xl font-bold text-maroon mb-6 text-center">Settings</h2>
                    <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-semibold text-maroon mb-4">Account Settings</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Email Notifications</h4>
                                            <p class="text-sm text-gray-600">Receive notifications about Chama activities</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="email-notifications" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-maroon rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-maroon"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">SMS Notifications</h4>
                                            <p class="text-sm text-gray-600">Receive SMS alerts for important updates</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="sms-notifications" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-maroon rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-maroon"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-maroon mb-4">Privacy Settings</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Profile Visibility</h4>
                                            <p class="text-sm text-gray-600">Allow other members to view your profile</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="profile-visibility" class="sr-only peer" checked>
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-maroon rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-maroon"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-4 border-t border-gray-200">
                                <button onclick="saveUserSettings()" class="btn-primary w-full">
                                    <i class="fas fa-save mr-2"></i>Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                `,
            };


            const appContent = document.getElementById('app-content');
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const mobileMenu = document.getElementById('mobile-menu');
            const chatButton = document.getElementById('chat-button');
            const chatModalOverlay = document.getElementById('chat-modal-overlay');
            const chatCloseButton = document.getElementById('chat-close-button');
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');
            const chatMessagesDiv = document.getElementById('chat-messages');
            const messageBoxCloseButton = document.getElementById('message-box-close'); // Get the new close button

            let dashboardSubpageContent = null; // Will be initialized when dashboard is rendered

            // Toggle mobile menu visibility
            window.toggleMobileMenu = function() { // Make global
                mobileMenu.classList.toggle('hidden');
            }

            hamburgerMenu.addEventListener('click', window.toggleMobileMenu);

            // Add event listener for the new message box close button
            messageBoxCloseButton.addEventListener('click', hideMessageBox);


            // Chat Modal functions
            function openChatModal() {
                chatModalOverlay.classList.add('show');
                if (currentUserId) {
                    loadChatHistory();
                } else {
                    chatMessagesDiv.innerHTML = `<div class="chat-message admin">Please log in to start a chat with support.</div>`;
                }
            }

            function closeChatModal() {
                chatModalOverlay.classList.remove('show');
                // Unsubscribe from chat listener when modal is closed
                if (unsubscribeChat) {
                    unsubscribeChat();
                }
            }

            // Add message to chat display
            function addMessageToChat(messageText, role, timestamp) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message', role);
                let timeStr = timestamp ? new Date(timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                messageElement.innerHTML = `${messageText} <span class="text-xs text-gray-500">${timeStr}</span>`;
                chatMessagesDiv.appendChild(messageElement);
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
            }

            // Load chat history from Firestore
            let unsubscribeChat = null; // To store the unsubscribe function for real-time listener

            function loadChatHistory() {
                if (!currentUserId || !db) {
                    console.warn("Cannot load chat history: User not logged in or Firestore not initialized.");
                    return;
                }

                // Unsubscribe from previous listener if exists
                if (unsubscribeChat) {
                    unsubscribeChat();
                }

                const chatCollectionRef = collection(db, 'support_messages');
                const q = query(chatCollectionRef, orderBy('timestamp'));

                unsubscribeChat = onSnapshot(q, (snapshot) => {
                    chatMessagesDiv.innerHTML = ''; // Clear existing messages
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        addMessageToChat(message.text, message.role, message.timestamp);
                    });
                }, (error) => {
                    console.error("Error loading chat messages:", error);
                    showMessage("Failed to load chat history.", "error");
                });
            }

            // Send message to Firestore
            async function sendMessage() {
                const messageText = chatInput.value.trim();
                if (messageText === "") {
                    return;
                }

                if (!currentUserId) {
                    showMessage("Please log in to send messages.", "error");
                    window.renderPage('login');
                    closeChatModal();
                    return;
                }

                try {
                    await addDoc(collection(db, 'support_messages'), {
                        text: messageText,
                        timestamp: serverTimestamp(),
                        senderId: currentUserId,
                        senderName: currentUserName || "User",
                        role: 'user'
                    });
                    chatInput.value = ''; // Clear input

                    // Simulate admin reply for demonstration
                    setTimeout(async () => {
                        await addDoc(collection(db, 'support_messages'), {
                            text: "Thank you for your message. Our support team will review it and get back to you shortly.",
                            timestamp: serverTimestamp(),
                            senderId: "admin",
                            senderName: "Admin Support",
                            role: 'admin'
                        });
                    }, 1500); // Simulate a delay for admin response

                } catch (error) {
                    console.error("Error sending message:", error);
                    showMessage("Failed to send message.", "error");
                }
            }

            // Attach chat event listeners
            chatButton.addEventListener('click', openChatModal);
            chatCloseButton.addEventListener('click', closeChatModal);
            chatSendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });


            // Function to render page content
            window.renderPage = async function(pageName) { // Make global
                // Close mobile menu if open
                if (!mobileMenu.classList.contains('hidden')) {
                    window.toggleMobileMenu();
                }

                // Redirect to login if trying to access dashboard and not logged in AND NOT VERIFIED
                // The onAuthStateChanged will handle the verification check.
                if (pageName === 'dashboard') {
                    if (!auth || !auth.currentUser) {
                        showMessage("Please log in to access the Dashboard.", "error");
                        window.location.hash = '#login'; // Update URL hash
                        appContent.innerHTML = pages['login'];
                        attachLoginEventListeners();
                        return;
                    }
                }

                // For dashboard, load default subpage or maintain current one
                if (pageName === 'dashboard') {
                     appContent.innerHTML = pages[pageName];
                     // Initialize dashboardSubpageContent after dashboard HTML is in DOM
                     dashboardSubpageContent = document.getElementById('dashboard-subpage-content');
                     await updateDashboardData(); // Update main dashboard info
                     const currentSubpageHash = window.location.hash.split('/')[1];
                     if (currentSubpageHash && dashboardSubpages[currentSubpageHash]) {
                         window.renderDashboardSubpage(currentSubpageHash);
                     } else {
                         // Default dashboard view
                         if(dashboardSubpageContent) {
                              dashboardSubpageContent.innerHTML = `<p class="text-center text-gray-600">Select an option above to manage your Chama activities.</p>`;
                         }
                     }
                } else {
                    appContent.innerHTML = pages[pageName];
                }


                window.location.hash = '#' + pageName; // Update URL hash

                // Attach event listeners after rendering
                if (pageName === 'signup') {
                    attachSignupEventListeners();
                } else if (pageName === 'login') {
                    attachLoginEventListeners();
                } else if (pageName === 'forgot-password') {
                    attachForgotPasswordEventListeners();
                }
            }

            // Function to render dashboard sub-pages
            window.renderDashboardSubpage = async function(subpageName) {
                // Ensure dashboardSubpageContent is initialized
                if (!dashboardSubpageContent) {
                     dashboardSubpageContent = document.getElementById('dashboard-subpage-content');
                }

                // Define the locked message content
                const lockedServiceContent = `
                    <div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg">
                        <i class="fas fa-lock text-red-500 text-4xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-red-700 mb-3">Service Locked</h2>
                        <p class="text-gray-700 mb-4">
                            This service is currently locked. Your account is pending approval by an administrator.
                        </p>
                        <p class="text-gray-700 font-semibold">
                            Please check back after your membership has been approved to access all features.
                        </p>
                        <p class="text-sm text-gray-600 mt-4">
                            If you believe this is an error, please contact support.
                        </p>
                    </div>
                `;

                // Check if user's email is verified OR if the service is allowed for unverified users
                // AND check if user is approved before rendering dashboard subpages (excluding notifications, view-statements, update-profile, and now signup/login related)
                const isEmailVerified = auth.currentUser ? auth.currentUser.emailVerified : false;
                const isProfileApproved = currentUserData.status === 'approved';
                const isAllowedForUnverified = ['notifications', 'view-statements', 'update-profile'].includes(subpageName);

                if (!isEmailVerified || (!isProfileApproved && !isAllowedForUnverified)) {
                     // More specific message based on what's missing
                    if (!isEmailVerified) {
                        showMessage("Please verify your email address to access this feature.", "error");
                    } else if (!isProfileApproved) {
                        showMessage("This service is locked until your membership is approved by an admin.", "error");
                    }
                     if(dashboardSubpageContent) {
                        dashboardSubpageContent.innerHTML = lockedServiceContent;
                     }
                     return;
                }

                if (dashboardSubpageContent && dashboardSubpages[subpageName]) {
                    dashboardSubpageContent.innerHTML = dashboardSubpages[subpageName];
                    // Update URL hash to include subpage
                    window.location.hash = '#dashboard/' + subpageName;
                    attachDashboardSubpageFormListeners(); // Re-attach listeners for newly loaded forms

                    // Load data for specific subpages
                    switch (subpageName) {
                        case 'contribution-history':
                            loadContributionHistory();
                            break;
                        case 'loan-history':
                            loadLoanHistory();
                            break;
                        case 'view-statements':
                             loadStatements(); // This will aggregate all transactions
                             break;
                        case 'meetings':
                            loadMeetings();
                            break;
                        case 'fines':
                            loadFines();
                            break;
                        case 'investments':
                            loadInvestments();
                            break;
                        case 'voting-polls':
                            loadPolls();
                            break;
                        case 'attendance':
                            loadAttendanceHistory();
                            break;
                        case 'documents':
                            loadDocuments();
                            break;
                        case 'group-overview':
                            loadGroupOverview();
                            break;
                        case 'notifications':
                            loadNotifications();
                            break;
                        case 'forum':
                            loadForumPosts(); // Remains mock as no Firestore schema for it was explicitly provided.
                            break;
                        case 'reports':
                            loadUserReports();
                            break;
                        case 'analytics':
                            loadUserAnalytics();
                            break;
                        case 'settings':
                            loadUserSettings();
                            break;
                    }

                } else if (dashboardSubpageContent) {
                    dashboardSubpageContent.innerHTML = `<p class="text-center text-red-500">Sub-page not found or not yet implemented.</p>`;
                }
            };

            // Attach Signup Form Event Listener
            function attachSignupEventListeners() {
                const signupForm = document.getElementById('signup-form');
                if (signupForm) {
                    signupForm.addEventListener('submit', handleSignup);
                }
            }

            // Attach Login Form Event Listener
            function attachLoginEventListeners() {
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', handleLogin);
                }
            }

            // Attach Forgot Password Form Event Listener
            function attachForgotPasswordEventListeners() {
                const forgotPasswordForm = document.getElementById('forgot-password-form');
                if (forgotPasswordForm) {
                    forgotPasswordForm.addEventListener('submit', handleForgotPassword);
                }
            }

            // Attach event listeners for forms inside dashboard sub-pages
            function attachDashboardSubpageFormListeners() {
                const contributionForm = document.getElementById('contribution-form');
                if (contributionForm) {
                    contributionForm.addEventListener('submit', handleMakeContribution);
                }

                const loanRequestForm = document.getElementById('loan-request-form');
                if (loanRequestForm) {
                    loanRequestForm.addEventListener('submit', handleLoanRequest);
                }

                const updateProfileForm = document.getElementById('update-profile-form');
                if (updateProfileForm) {
                    updateProfileForm.addEventListener('submit', handleUpdateProfile);
                }
                const attendanceForm = document.getElementById('attendance-form');
                if (attendanceForm) {
                    attendanceForm.addEventListener('submit', handleRecordAttendance);
                }

                const addMeetingForm = document.getElementById('add-meeting-form');
                if (addMeetingForm) {
                    addMeetingForm.addEventListener('submit', handleAddMeeting);
                }

                const addInvestmentForm = document.getElementById('add-investment-form');
                if (addInvestmentForm) {
                    addInvestmentForm.addEventListener('submit', handleAddInvestment);
                }

                const createPollForm = document.getElementById('create-poll-form');
                if (createPollForm) {
                    createPollForm.addEventListener('submit', handleCreatePoll);
                }

                const uploadDocumentForm = document.getElementById('upload-document-form');
                if (uploadDocumentForm) {
                    uploadDocumentForm.addEventListener('submit', handleUploadDocument);
                }

                const postForumMessageButton = document.getElementById('post-forum-message');
                if (postForumMessageButton) {
                    postForumMessageButton.addEventListener('click', handlePostForumMessage);
                }

                // Event delegation for poll voting buttons
                const pollsList = document.getElementById('polls-list');
                if (pollsList) {
                    pollsList.addEventListener('click', (event) => {
                        if (event.target.classList.contains('vote-button')) {
                            const pollId = event.target.dataset.pollId;
                            // Find the selected radio button within the same poll container
                            const pollContainer = event.target.closest('.p-4');
                            const selectedOptionInput = pollContainer.querySelector(`input[name="poll-${pollId}"]:checked`);
                            if (selectedOptionInput) {
                                const option = selectedOptionInput.value;
                                handleVote(pollId, option);
                            } else {
                                showMessage("Please select an option to vote.", "error");
                            }
                        }
                    });
                }

                // Event delegation for investment pledge buttons
                const investmentsList = document.getElementById('investments-list');
                if (investmentsList) {
                    investmentsList.addEventListener('click', (event) => {
                        if (event.target.classList.contains('pledge-button')) {
                            const investmentId = event.target.dataset.investmentId;
                            // Prompt for amount or navigate to a dedicated pledge form
                            const pledgeAmount = parseFloat(prompt("Enter amount to pledge:"));
                            if (!isNaN(pledgeAmount) && pledgeAmount > 0) {
                                handlePledgeContribution(investmentId, pledgeAmount);
                            } else if (pledgeAmount !== null) { // User clicked cancel or entered non-number
                                showMessage("Please enter a valid pledge amount.", "error");
                            }
                        }
                    });
                }
            }

            // --- Firestore Data Loading Functions ---

            // Load Contribution History
            function loadContributionHistory() {
                if (!currentUserId || !db) return;
                const tableBody = document.querySelector('#contribution-history-table tbody');
                if (!tableBody) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeContributionHistory) window.unsubscribeContributionHistory();

                const q = query(collection(db, 'contributions'), orderBy('date', 'desc')); // Changed to 'date'
                window.unsubscribeContributionHistory = onSnapshot(q, (snapshot) => {
                    tableBody.innerHTML = ''; // Clear existing rows
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        // Only show contributions for the current user
                        if (data.userId === currentUserId) {
                            const date = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : 'N/A'; // Use 'date'
                            const description = data.description || 'N/A'; // Added description
                            const row = `
                                <tr>
                                    <td>${date}</td>
                                    <td>${data.amount.toFixed(2)}</td>
                                    <td>${data.method}</td>
                                    <td>${description}</td>
                                    <td>${data.status || 'Completed'}</td>
                                </tr>
                            `;
                            tableBody.innerHTML += row;
                        }
                    });
                     if (snapshot.empty) {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">No contributions found.</td></tr>`;
                     }
                }, (error) => {
                    console.error("Error loading contribution history:", error);
                    showMessage("Failed to load contribution history.", "error");
                });
            }

            // Load Loan History
            function loadLoanHistory() {
                if (!currentUserId || !db) return;
                const tableBody = document.querySelector('#loan-history-table tbody');
                if (!tableBody) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeLoanHistory) window.unsubscribeLoanHistory();

                const q = query(collection(db, 'loans'), orderBy('dueDate', 'desc')); // Changed to 'dueDate'
                window.unsubscribeLoanHistory = onSnapshot(q, (snapshot) => {
                    tableBody.innerHTML = ''; // Clear existing rows
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        // Only show loans for the current user
                        if (data.userId === currentUserId) {
                            const loanDate = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'; // Keep original creation timestamp for "Loan Date"
                            const dueDate = data.dueDate ? new Date(data.dueDate.seconds * 1000).toLocaleDateString() : 'N/A';
                            const interestRate = (data.interestRate || 0).toFixed(2);
                            const repaidAmount = (data.repaidAmount || 0).toFixed(2); // Changed to 'repaidAmount'
                            const balance = (data.amount - (data.repaidAmount || 0)).toFixed(2); // Changed to 'repaidAmount'

                            const row = `
                                <tr>
                                    <td>${loanDate}</td>
                                    <td>${data.amount.toFixed(2)}</td>
                                    <td>${interestRate}</td>
                                    <td>${dueDate}</td>
                                    <td>${repaidAmount}</td>
                                    <td>${balance}</td>
                                    <td>${data.status}</td>
                                    <td>${data.purpose}</td>
                                </tr>
                            `;
                            tableBody.innerHTML += row;
                        }
                    });
                    if (snapshot.empty) {
                        tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">No loan records found.</td></tr>`;
                    }
                }, (error) => {
                    console.error("Error loading loan history:", error);
                    showMessage("Failed to load loan history.", "error");
                });
            }

            // Load All Statements (Contributions, Loans, Fines) - Aggregated View
            async function loadStatements() {
                if (!currentUserId || !db) return;
                const tableBody = document.querySelector('#statements-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = ''; // Clear existing rows

                let transactions = [];
                let currentBalance = 0; // Simulate running balance

                // Fetch Contributions
                const contributionsSnapshot = await getDocs(query(collection(db, 'contributions'), orderBy('date'))); // Changed to 'date'
                contributionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === currentUserId) {
                        transactions.push({
                            date: data.date ? new Date(data.date.seconds * 1000) : new Date(0), // Use 'date'
                            type: 'Contribution',
                            description: `Contribution via ${data.method}` + (data.description ? `: ${data.description}` : ''), // Added description
                            amount: data.amount,
                            isCredit: true
                        });
                    }
                });

                // Fetch Loans Issued
                const loansSnapshot = await getDocs(query(collection(db, 'loans'), orderBy('dueDate'))); // Changed to 'dueDate'
                loansSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === currentUserId) {
                        transactions.push({
                            date: data.timestamp ? new Date(data.timestamp.seconds * 1000) : new Date(0), // Use creation timestamp for transaction date
                            type: 'Loan Issued',
                            description: `Loan for ${data.purpose}`,
                            amount: data.amount,
                            isCredit: false
                        });
                        // Simulate loan repayments (if any)
                        if (data.repaidAmount && data.repaidAmount > 0) { // Changed to 'repaidAmount'
                             transactions.push({
                                date: data.lastRepaymentTimestamp ? new Date(data.lastRepaymentTimestamp.seconds * 1000) : new Date(0), // Use a repayment timestamp if available
                                type: 'Loan Repayment',
                                description: `Repayment for loan for ${data.purpose}`,
                                amount: data.repaidAmount, // Changed to 'repaidAmount'
                                isCredit: true
                            });
                        }
                    }
                });

                // Fetch Fines
                const finesSnapshot = await getDocs(query(collection(db, 'fines'), orderBy('dateIssued'))); // Changed to 'dateIssued'
                finesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId === currentUserId) {
                        transactions.push({
                            date: data.dateIssued ? new Date(data.dateIssued.seconds * 1000) : new Date(0), // Use 'dateIssued'
                            type: 'Fine',
                            description: data.reason,
                            amount: data.amount,
                            isCredit: false
                        });
                    }
                });

                // Sort all transactions by date
                transactions.sort((a, b) => a.date - b.date);

                transactions.forEach(t => {
                    currentBalance += t.isCredit ? t.amount : -t.amount;
                    const row = `
                        <tr>
                            <td>${t.date.toLocaleDateString()}</td>
                            <td>${t.type}</td>
                            <td>${t.description}</td>
                            <td class="${t.isCredit ? 'text-green-600' : 'text-red-600'}">${t.isCredit ? '+' : '-'}${t.amount.toFixed(2)}</td>
                            <td>${currentBalance.toFixed(2)}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                if (transactions.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">No statements found.</td></tr>`;
                }
            }

            // Load Meetings
            function loadMeetings() {
                if (!db) return; // No currentUserId check as this is public data
                const meetingsListDiv = document.getElementById('meetings-list');
                if (!meetingsListDiv) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeMeetings) window.unsubscribeMeetings();

                const q = query(collection(db, getPublicCollectionPath('meetings')), orderBy('date'));
                window.unsubscribeMeetings = onSnapshot(q, (snapshot) => {
                    let htmlContent = `<p class="text-gray-700 mb-4">Stay updated with our Chama's meeting schedules and important announcements.</p><div class="space-y-4">`;
                    let hasMeetings = false;
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        hasMeetings = true;
                        const meetingDate = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                        htmlContent += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border-l-4 border-maroon">
                                <h3 class="text-xl font-semibold text-maroon">${data.title || 'Meeting'}</h3>
                                <p class="text-gray-800"><strong>Date:</strong> ${meetingDate}</p>
                                <p class="text-gray-800"><strong>Time:</strong> ${data.time || 'N/A'}</p>
                                <p class="text-gray-800"><strong>Location:</strong> ${data.location || 'N/A'}</p>
                                <p class="text-gray-700 mt-2">Description: ${data.description || 'N/A'}</p> <!-- Changed to 'description' -->
                                <p class="text-gray-700 text-sm">Type: ${data.type || 'N/A'}</p> <!-- Added 'type' -->
                                <button class="btn-primary mt-3 text-sm px-4 py-2" disabled>Confirm Attendance (Future Feature)</button>
                            </div>
                        `;
                    });
                    htmlContent += `</div>`;
                    if (!hasMeetings) {
                        htmlContent = `<p class="text-center text-gray-500">No upcoming meetings scheduled.</p>`;
                    }
                    meetingsListDiv.innerHTML = htmlContent;
                }, (error) => {
                    console.error("Error loading meetings:", error);
                    showMessage("Failed to load meetings.", "error");
                });
            }

            // Load Fines
            function loadFines() {
                if (!currentUserId || !db) return;
                const tableBody = document.querySelector('#fines-table tbody');
                if (!tableBody) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeFines) window.unsubscribeFines();

                const q = query(collection(db, 'fines'), orderBy('dateIssued', 'desc')); // Changed to 'dateIssued'
                window.unsubscribeFines = onSnapshot(q, (snapshot) => {
                    tableBody.innerHTML = ''; // Clear existing rows
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const dateIssued = data.dateIssued ? new Date(data.dateIssued.seconds * 1000).toLocaleDateString() : 'N/A'; // Use 'dateIssued'
                        const row = `
                            <tr>
                                <td>${dateIssued}</td>
                                <td>${data.reason}</td>
                                <td>${data.amount.toFixed(2)}</td>
                                <td>${data.status}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                    if (snapshot.empty) {
                         tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500">No fines recorded.</td></tr>`;
                    }
                }, (error) => {
                    console.error("Error loading fines:", error);
                    showMessage("Failed to load fines.", "error");
                });
            }

            // Load Investments
            function loadInvestments() {
                if (!db) return; // No currentUserId check as this is public data
                const investmentsListDiv = document.getElementById('investments-list');
                if (!investmentsListDiv) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeInvestments) window.unsubscribeInvestments();

                const q = query(collection(db, getPublicCollectionPath('investments')), orderBy('createdAt', 'desc'));
                window.unsubscribeInvestments = onSnapshot(q, (snapshot) => {
                    let htmlContent = `<p class="text-gray-700 mb-4">Explore and pledge contributions towards various group investment projects.</p><div class="space-y-6">`;
                    let hasInvestments = false;
                    snapshot.forEach((doc) => {
                        hasInvestments = true;
                        const data = doc.data();
                        // Check if the user has already pledged to this investment to disable the button
                        const userPledged = currentUserData.investment_pledges ? currentUserData.investment_pledges[doc.id] : undefined;
                        const pledgeButtonText = userPledged ? `Pledged KSh ${userPledged.toFixed(2)}` : 'Pledge Contribution';
                        const pledgeButtonDisabled = userPledged ? 'disabled' : '';

                        htmlContent += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border-l-4 border-maroon">
                                <h3 class="text-xl font-semibold text-maroon">Project: ${data.title}</h3> <!-- Changed to 'title' -->
                                <p class="text-gray-700 mt-2"><strong>Goal:</strong> KSh ${data.amount.toFixed(2)}</p> <!-- Changed to 'amount' -->
                                <p class="text-700"><strong>Pledged:</strong> KSh ${(data.pledged || 0).toFixed(2)}</p>
                                <p class="text-gray-700"><strong>Description:</strong> ${data.description}</p>
                                <button class="btn-primary mt-3 text-sm px-4 py-2 pledge-button" data-investment-id="${doc.id}" ${pledgeButtonDisabled}>
                                    ${pledgeButtonText}
                                </button>
                                <p class="text-sm text-gray-600 mt-2">Estimated Return: ${data.estimatedReturn || 'N/A'}</p>
                            </div>
                        `;
                    });
                    htmlContent += `</div>`;
                    if (!hasInvestments) {
                        htmlContent = `<p class="text-center text-gray-500">No investment opportunities available at the moment.</p>`;
                    }
                    investmentsListDiv.innerHTML = htmlContent;
                    // Re-attach listeners for pledge buttons after content is loaded
                    attachDashboardSubpageFormListeners();
                }, (error) => {
                    console.error("Error loading investments:", error);
                    showMessage("Failed to load investments.", "error");
                });
            }

            // Load Polls (voting-polls in request, polls in code)
            function loadPolls() {
                if (!db) return; // No currentUserId check as this is public data
                const pollsListDiv = document.getElementById('polls-list');
                if (!pollsListDiv) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribePolls) window.unsubscribePolls();

                const q = query(collection(db, getPublicCollectionPath('polls')), orderBy('createdAt', 'desc'));
                window.unsubscribePolls = onSnapshot(q, async (snapshot) => {
                    let htmlContent = `<p class="text-gray-700 mb-4">Participate in important Chama decisions through secure online voting.</p><div class="space-y-6">`;
                    let hasPolls = false;
                    const userVotes = currentUserData?.votes || {}; // Use optional chaining to prevent errors if currentUserData is null/undefined

                    snapshot.forEach((doc) => {
                        hasPolls = true;
                        const poll = { id: doc.id, ...doc.data() };
                        const totalVotes = Object.values(poll.votes || {}).reduce((sum, count) => sum + count, 0); // Changed to 'votes'
                        const userVotedOption = userVotes[poll.id];

                        let optionsHtml = '';
                        // Ensure poll.options is an array for iteration
                        const optionsToRender = Array.isArray(poll.options) ? poll.options : Object.keys(poll.options || {});

                        optionsToRender.forEach(option => {
                            const count = poll.votes ? poll.votes[option] || 0 : 0; // Changed to 'votes'
                            const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;
                            const isDisabled = !!userVotedOption; // Disable if user has already voted
                            const isChecked = userVotedOption === option; // Check the radio button if it's the user's vote

                            optionsHtml += `
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="poll-${poll.id}" value="${option}" class="form-radio text-maroon" ${isDisabled ? 'disabled' : ''} ${isChecked ? 'checked' : ''}>
                                    <span>${option}</span>
                                    ${userVotedOption ? `<span class="text-sm text-gray-500 ml-2">(${percentage}%)</span>` : ''}
                                </label>
                            `;
                        });

                        htmlContent += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border-l-4 border-maroon">
                                <h3 class="text-xl font-semibold text-maroon">Poll: ${poll.title}</h3> <!-- Changed to 'title' -->
                                <p class="text-gray-800 mt-2 mb-3">${poll.description || ''}</p>
                                <div class="space-y-2">
                                    ${optionsHtml}
                                </div>
                                <button class="btn-primary mt-3 text-sm px-4 py-2 vote-button" data-poll-id="${poll.id}" ${userVotedOption ? 'disabled' : ''}>
                                    ${userVotedOption ? 'Voted' : 'Submit Vote'}
                                </button>
                                ${userVotedOption ? `<p class="text-xs text-gray-500 mt-2">You voted for: <strong>${userVotedOption}</strong></p>` : ''}
                                <p class="text-xs text-gray-500 mt-2">Total Votes: ${totalVotes}</p>
                            </div>
                        `;
                    });
                    htmlContent += `</div>`;
                    if (!hasPolls) {
                        htmlContent = `<p class="text-center text-gray-500">No active polls at the moment.</p>`;
                    }
                    pollsListDiv.innerHTML = htmlContent;
                    attachDashboardSubpageFormListeners(); // Re-attach listeners for vote buttons
                }, (error) => {
                    console.error("Error loading polls:", error);
                    showMessage("Failed to load polls.", "error");
                });
            }


            // Load Attendance History
            function loadAttendanceHistory() {
                if (!currentUserId || !db) return;
                const tableBody = document.querySelector('#attendance-history-table tbody');
                if (!tableBody) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeAttendanceHistory) window.unsubscribeAttendanceHistory();

                const q = query(collection(db, 'attendance'), orderBy('date', 'desc')); // Changed to 'date'
                window.unsubscribeAttendanceHistory = onSnapshot(q, (snapshot) => {
                    tableBody.innerHTML = ''; // Clear existing rows
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        // Only show attendance for the current user
                        if (data.userId === currentUserId) {
                            const date = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : 'N/A'; // Use 'date'
                            const row = `
                                <tr>
                                    <td>${date}</td>
                                    <td>${data.meetingType || 'General Meeting'}</td>
                                    <td>${data.status}</td>
                                </tr>
                            `;
                            tableBody.innerHTML += row;
                        }
                    });
                    if (snapshot.empty) {
                         tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">No attendance records found.</td></tr>`;
                    }
                }, (error) => {
                    console.error("Error loading attendance history:", error);
                    showMessage("Failed to load attendance history.", "error");
                });
            }

            // Load Documents
            function loadDocuments() {
                if (!db) return; // No currentUserId check as this is public data
                const documentsListDiv = document.getElementById('documents-list');
                if (!documentsListDiv) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeDocuments) window.unsubscribeDocuments();

                const q = query(collection(db, getPublicCollectionPath('documents')), orderBy('uploadedAt', 'desc'));
                window.unsubscribeDocuments = onSnapshot(q, (snapshot) => {
                    let htmlContent = `<p class="text-gray-700 mb-4">Access important Chama documents securely.</p><div class="space-y-4">`;
                    let hasDocuments = false;
                    snapshot.forEach((doc) => {
                        hasDocuments = true;
                        const data = doc.data();
                        htmlContent += `
                            <div class="p-4 bg-white rounded-lg shadow-sm border-l-4 border-maroon flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-semibold text-maroon">${data.title}</h3> <!-- Changed to 'title' -->
                                    <p class="text-gray-700 text-sm">Uploaded: ${data.uploadedAt ? new Date(data.uploadedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                                </div>
                                <a href="${data.fileUrl}" target="_blank" class="btn-primary text-sm px-4 py-2"><i class="fas fa-download mr-2"></i>Download</a> <!-- Changed to 'fileUrl' -->
                            </div>
                        `;
                    });
                    htmlContent += `</div>`;
                    if (!hasDocuments) {
                        htmlContent = `<p class="text-center text-gray-500">No documents available at the moment.</p>`;
                    }
                    documentsListDiv.innerHTML = htmlContent;
                }, (error) => {
                    console.error("Error loading documents:", error);
                    showMessage("Failed to load documents.", "error");
                });
            }

            // Load Group Overview Data
            async function loadGroupOverview() {
                if (!db) return;

                const totalSavingsEl = document.getElementById('group-total-savings');
                const totalLoansEl = document.getElementById('group-total-loans');
                const fundsAvailableEl = document.getElementById('group-funds-available');

                if (!totalSavingsEl || !totalLoansEl || !fundsAvailableEl) return;

                let totalContributions = 0;
                let totalLoansIssued = 0;

                try {
                    // Aggregate contributions from all users
                    const usersRef = collection(db, `artifacts/${appId}/users`);
                    const usersSnapshot = await getDocs(usersRef);

                    for (const userDocRef of usersSnapshot.docs) {
                        const userId = userDocRef.id;
                        const userProfileRef = doc(db, getPrivateCollectionPath(userId, 'user_profile'), userId);
                        const userProfileDoc = await getDoc(userProfileRef);
                        if (userProfileDoc.exists()) {
                            totalContributions += userProfileDoc.data().contribution_balance || 0;
                        }
                    }

                    // Aggregate loans issued (assuming a "loans_issued" collection for all loans, or sum from user loans)
                    // For simplicity, let's sum up all 'amount' from all users' loans subcollections
                    for (const userDocRef of usersSnapshot.docs) {
                        const userId = userDocRef.id;
                        const loansSnapshot = await getDocs(collection(db, getPrivateCollectionPath(userId, 'loans')));
                        loansSnapshot.forEach(loanDoc => {
                            totalLoansIssued += loanDoc.data().amount || 0;
                        });
                    }

                    const fundsAvailable = totalContributions - totalLoansIssued;

                    totalSavingsEl.textContent = `KSh ${totalContributions.toFixed(2)}`;
                    totalLoansEl.textContent = `KSh ${totalLoansIssued.toFixed(2)}`;
                    fundsAvailableEl.textContent = `KSh ${fundsAvailable.toFixed(2)}`;

                } catch (error) {
                    console.error("Error loading group overview:", error);
                    showMessage("Failed to load group overview data.", "error");
                    totalSavingsEl.textContent = "KSh 0.00";
                    totalLoansEl.textContent = "KSh 0.00";
                    fundsAvailableEl.textContent = "KSh 0.00";
                }
            }

            // Load Notifications
            function loadNotifications() {
                if (!currentUserId || !db) return;
                const notificationsListDiv = document.getElementById('notifications-list');
                if (!notificationsListDiv) return;

                // Unsubscribe from previous listener if exists
                if (window.unsubscribeNotifications) window.unsubscribeNotifications();

                const q = query(collection(db, 'notifications'), orderBy('date', 'desc')); // Order by 'date'
                window.unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                    let htmlContent = `<p class="text-gray-700 mb-4">Stay informed with important updates and alerts regarding your Chama activities.</p><div class="space-y-4">`;
                    let hasNotifications = false;
                    snapshot.forEach((doc) => {
                        const notif = doc.data();
                        // Only show notifications for the current user
                        if (notif.userId === currentUserId) {
                            hasNotifications = true;
                            const borderColor = notif.status === 'unread' ? 'border-maroon' : 'border-gray-400';
                            const textColor = notif.status === 'unread' ? 'text-maroon' : 'text-gray-700';
                            const dateString = notif.date ? new Date(notif.date.seconds * 1000).toLocaleString() : 'N/A';
                            htmlContent += `
                                <div class="p-4 bg-white rounded-lg shadow-sm border-l-4 ${borderColor}">
                                    <h3 class="text-xl font-semibold ${textColor}">${notif.title}</h3>
                                    <p class="text-gray-800 mt-1">${notif.message}</p>
                                    <p class="text-xs text-gray-500 mt-2">Received: ${dateString}</p>
                                </div>
                            `;
                        }
                    });
                    htmlContent += `</div>`;
                    if (!hasNotifications) {
                        htmlContent = `<p class="text-center text-gray-500">No notifications found.</p>`;
                    }
                    notificationsListDiv.innerHTML = htmlContent;
                }, (error) => {
                    console.error("Error loading notifications:", error);
                    showMessage("Failed to load notifications.", "error");
                });
            }

            // Load Forum Posts (Mock for now, will fetch from Firestore if a 'forum_posts' collection is added)
            // This function remains a mock as it was not part of the explicit Firestore schema from the prompt's context.
            function loadForumPosts() {
                const forumPostsDiv = document.getElementById('forum-posts');
                if (!forumPostsDiv) return;

                // This is currently mock data. In a real app, you would fetch from a 'forum_posts' collection
                // and perhaps manage replies in a subcollection.
                const mockForumPosts = [
                    { id: 1, author: 'Admin', title: 'Next meeting agenda discussion', content: 'Please provide your input on potential agenda items for the August 15th meeting by August 10th.', timestamp: '2024-08-01' },
                    { id: 2, author: 'Jane Doe', title: 'Member Query: Loan repayment grace period?', content: 'Has anyone experienced issues with loan repayment deadlines? Is there a grace period we can discuss?', timestamp: '2024-08-05' },
                ];

                let htmlContent = '';
                if (mockForumPosts.length === 0) {
                     htmlContent = `<p class="text-center text-gray-500">No forum posts yet.</p>`;
                } else {
                    mockForumPosts.forEach(post => {
                        htmlContent += `
                            <div class="border border-gray-300 rounded-lg p-4 mb-4 bg-white">
                                <div class="font-bold text-maroon">${post.author}: ${post.title}</div>
                                <p class="text-gray-800 text-sm mt-1">${post.content}</p>
                                <p class="text-xs text-gray-500 mt-2">Posted by ${post.author} on ${post.timestamp}</p>
                            </div>
                        `;
                    });
                }
                forumPostsDiv.innerHTML = htmlContent;
            }


            // --- Firestore Data Handling Functions (Add/Update/Delete) ---

            // Handle Record Attendance
            async function handleRecordAttendance(event) {
                event.preventDefault();
                const meetingId = document.getElementById('attendance-meeting-id').value.trim();
                const date = document.getElementById('attendance-date').value;
                const time = document.getElementById('attendance-time').value;

                if (!date || !time) {
                    showMessage("Please select both date and time.", "error");
                    return;
                }

                if (!currentUserId) {
                    showMessage("Please log in to record attendance.", "error");
                    window.renderPage('login');
                    return;
                }
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                     showMessage("Your account is not yet fully activated. Please verify your email and await admin approval to record attendance.", "error");
                     return;
                 }

                try {
                    await addDoc(collection(db, 'attendance'), {
                        userId: currentUserId,
                        meetingId: meetingId || null, // Optional meetingId
                        date: new Date(`${date}T${time}`), // Storing date as Timestamp
                        time: time, // Storing time separately for display
                        status: 'present' // Default status
                    });
                    showMessage(`Attendance for ${date} at ${time} recorded successfully!`, "success");
                    document.getElementById('attendance-form').reset();
                } catch (error) {
                    console.error("Error recording attendance:", error);
                    showMessage("Failed to record attendance. Please try again.", "error");
                }
            }


            // Handle Make Contribution
            async function handleMakeContribution(event) {
                event.preventDefault();
                const amount = parseFloat(document.getElementById('contribution-amount').value);
                const method = document.getElementById('payment-method').value;
                const description = document.getElementById('contribution-description').value.trim();

                if (isNaN(amount) || amount <= 0) {
                    showMessage("Please enter a valid amount.", "error");
                    return;
                }
                if (!method) {
                    showMessage("Please select a payment method.", "error");
                    return;
                }

                if (!currentUserId) {
                    showMessage("Please log in to make a contribution.", "error");
                    window.renderPage('login');
                    return;
                }
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Your account is not yet fully activated. Please verify your email and await admin approval to make contributions.", "error");
                    return;
                }

                const customerRef = doc(db, 'customers', currentUserId);
                try {
                    // Add contribution to contributions collection
                    await addDoc(collection(db, 'contributions'), {
                        userId: currentUserId,
                        amount: amount,
                        method: method,
                        date: serverTimestamp(), // Changed to 'date'
                        description: description, // Added description
                        status: 'completed' // Default status
                    });

                    // Update user's contribution balance in customers collection
                    const newBalance = (currentUserData.contribution_balance || 0) + amount;
                    
                    await updateDoc(customerRef, {
                        contribution_balance: newBalance
                    });

                    showMessage(`Successfully recorded KSh ${amount.toFixed(2)} contribution via ${method}.`, "success");
                    currentUserData.contribution_balance = newBalance; // Update local data
                    updateDashboardData(); // Refresh dashboard view
                    document.getElementById('contribution-form').reset(); // Clear form
                } catch (error) {
                    console.error("Error recording contribution:", error);
                    showMessage("Failed to record contribution. Please try again.", "error");
                }
            }

            // Handle Loan Request
            async function handleLoanRequest(event) {
                event.preventDefault();
                const amount = parseFloat(document.getElementById('loan-amount').value);
                const interestRate = parseFloat(document.getElementById('loan-interest-rate').value);
                const dueDate = document.getElementById('loan-due-date').value;
                const plan = document.getElementById('repayment-plan').value;
                const purpose = document.getElementById('loan-purpose').value.trim();

                if (isNaN(amount) || amount <= 0) {
                    showMessage("Please enter a valid loan amount.", "error");
                    return;
                }
                if (isNaN(interestRate) || interestRate < 0) {
                     showMessage("Please enter a valid interest rate.", "error");
                     return;
                 }
                 if (!dueDate) {
                     showMessage("Please select a due date.", "error");
                     return;
                 }
                if (!plan) {
                    showMessage("Please select a repayment plan.", "error");
                    return;
                }
                if (!purpose) {
                    showMessage("Please state the purpose of the loan.", "error");
                    return;
                }

                if (!currentUserId) {
                    showMessage("Please log in to request a loan.", "error");
                    window.renderPage('login');
                    return;
                }
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Your account is not yet fully activated. Please verify your email and await admin approval to request loans.", "error");
                    return;
                }

                try {
                    await addDoc(collection(db, 'loans'), {
                        memberId: currentUserId,
                        amount: amount,
                        interestRate: interestRate,
                        dueDate: new Date(dueDate), // Storing dueDate as Timestamp
                        repaymentPlan: plan,
                        purpose: purpose,
                        status: 'pending', // Pending admin approval
                        timestamp: serverTimestamp(), // Keep creation timestamp
                        repaidAmount: 0
                    });
                    showMessage(`Loan request for KSh ${amount.toFixed(2)} (${plan}, Purpose: ${purpose}) submitted successfully. Awaiting admin approval.`, "success");
                    document.getElementById('loan-request-form').reset(); // Clear form
                } catch (error) {
                    console.error("Error submitting loan request:", error);
                    showMessage("Failed to submit loan request. Please try again.", "error");
                }
            }

            // Handle Update Profile
            async function handleUpdateProfile(event) {
                event.preventDefault();
                const name = document.getElementById('profile-name').value.trim();
                const phone = document.getElementById('profile-phone').value.trim();
                const nationalId = document.getElementById('profile-national-id').value.trim();
                const profilePicUrl = document.getElementById('profile-pic-url').value.trim();

                if (!name || !phone || !nationalId) {
                    showMessage("Name, phone, and national ID are required.", "error");
                    return;
                }
                if (!/^\+?\d{10,14}$/.test(phone)) {
                    showMessage("Please enter a valid phone number (e.g., +254XXXXXXXXX).", "error");
                    return;
                }

                if (!currentUserId) {
                    showMessage("Please log in to update your profile.", "error");
                    window.renderPage('login');
                    return;
                }
                // Update profile can be done even if not approved, but email must be verified.
                if (!auth.currentUser.emailVerified) {
                    showMessage("Please verify your email address to update your profile.", "error");
                    return;
                }


                const customerRef = doc(db, 'customers', currentUserId);
                try {
                    // Update customers collection
                    await updateDoc(customerRef, {
                        name: name,
                        phone: phone,
                        nationalId: nationalId,
                        profilePicUrl: profilePicUrl
                    });
                    
                    showMessage("Profile updated successfully!", "success");
                    currentUserData.name = name; // Update local data
                    currentUserData.phone = phone;
                    currentUserData.nationalId = nationalId;
                    currentUserData.profilePicUrl = profilePicUrl; // Update local data
                    updateDashboardData(); // Refresh dashboard main view
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showMessage("Failed to update profile. Please try again.", "error");
                }
            }


            // Handle Signup
            async function handleSignup(event) {
                event.preventDefault();
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const phone = document.getElementById('signup-phone').value.trim();
                const nationalId = document.getElementById('signup-national-id').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;

                if (!name || !email || !phone || !nationalId || !password || !confirmPassword) {
                    showMessage("All fields are required.", "error");
                    return;
                }
                if (password !== confirmPassword) {
                    showMessage("Passwords do not match.", "error");
                    return;
                }
                if (password.length < 6) {
                    showMessage("Password must be at least 6 characters long.", "error");
                    return;
                }
                if (!/^\+?\d{10,14}$/.test(phone)) {
                    showMessage("Please enter a valid phone number (e.g., +254XXXXXXXXX).", "error");
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Store user data in customers collection for admin management
                    // Structure: customers/uuid/ with user details inside
                    const customerRef = doc(db, 'customers', user.uid);
                    await setDoc(customerRef, {
                        uid: user.uid,
                        name: name,
                        email: email,
                        phone: phone,
                        nationalId: nationalId,
                        createdAt: serverTimestamp(),
                        contribution_balance: 0,
                        loan_balance: 0,
                        next_meeting_date: "To be announced",
                        status: "pending", // Set initial status as pending approval
                        profilePicUrl: "",
                        lastLogin: null,
                        emailVerified: false
                    });
                    console.log("User data saved to customers collection successfully.");

                    // Send email verification AFTER profile is saved
                    await sendEmailVerification(user);
                    console.log("Verification email sent to:", user.email);
                    showMessage("Account created successfully! A verification email has been sent to your inbox. Please verify your email to log in.", "success");


                    // Add a welcome notification to notifications collection
                    await addDoc(collection(db, 'notifications'), {
                        userId: user.uid,
                        title: "Welcome to Prince Alex Digital Chama!",
                        message: "Your account has been created successfully. Please verify your email address to access full features.",
                        date: serverTimestamp(),
                        status: "unread"
                    });
                    console.log("Welcome notification added.");


                    window.renderPage('login'); // Redirect to login page, user is authenticated but not fully authorized for all features yet
                } catch (error) {
                    console.error("Error signing up:", error);
                    let errorMessage = "Failed to create account. Please try again.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "This email is already registered.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email address.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "Password is too weak. Please choose a stronger one.";
                    }
                    showMessage(errorMessage, "error");
                }
            }

            // Handle Login
            window.handleLogin = async function(event) { // Make global as it might be needed for direct testing or other global calls
                event.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                if (!email || !password) {
                    showMessage("Email and password are required.", "error");
                    return;
                }

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("Firebase Auth login successful for user:", user.uid);

                    // User is now authenticated. The onAuthStateChanged listener will check email verification status
                    // and retrieve/initialize their Firestore profile, then render the dashboard.
                    showMessage("Login successful! Redirecting to dashboard...", "success");
                    // No explicit redirect here, onAuthStateChanged handles it.

                } catch (error) {
                    console.error("Error logging in:", error);
                    let errorMessage = "Failed to log in. Please check your credentials.";
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "Invalid email or password.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format.";
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = "Your account has been disabled. Please contact support.";
                    }
                    showMessage(errorMessage, "error");
                }
            }

            // Handle Forgot Password
            function handleForgotPassword(event) {
                event.preventDefault();
                const email = document.getElementById('reset-email').value.trim();

                if (!email) {
                    showMessage("Please enter your email address.", "error");
                    return;
                }

                try {
                    sendPasswordResetEmail(auth, email);
                    showMessage("Password reset link sent to your email!", "success");
                    window.renderPage('login'); // Redirect to login
                }
                catch (error) {
                    console.error("Error sending password reset email:", error);
                    let errorMessage = "Failed to send reset link. Please try again.";
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email address.";
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = "No user found with that email address.";
                    }
                    showMessage(errorMessage, "error");
                }
            }

            // Handle Logout
            window.handleLogout = async function() { // Make global
                try {
                    await signOut(auth);
                    showMessage("You have been logged out.", "success");
                    window.renderPage('home'); // Redirect to home page after logout
                } catch (error) {
                    console.error("Error logging out:", error);
                    showMessage("Failed to log out. Please try again.", "error");
                }
            }

            // Update Dashboard Data
            async function updateDashboardData() {
                const dashboardUserName = document.getElementById('dashboard-user-name');
                const contributionBalance = document.getElementById('contribution-balance');
                const loanBalance = document.getElementById('loan-balance');
                const nextMeetingDate = document.getElementById('next-meeting-date');
                const displayUserId = document.getElementById('display-user-id');
                // New elements for user profile display on dashboard
                const dashboardUserEmail = document.getElementById('dashboard-user-email');
                const dashboardUserPhone = document.getElementById('dashboard-user-phone');
                const dashboardUserNationalId = document.getElementById('dashboard-user-national-id');


                if (!auth || !auth.currentUser || !currentUserId) {
                    // This case should ideally be handled by the renderPage redirect,
                    // but as a fallback, ensure UI reflects unauthenticated state.
                    dashboardUserName.textContent = "Guest!";
                    contributionBalance.textContent = "KSh 0.00";
                    loanBalance.textContent = "KSh 0.00";
                    nextMeetingDate.textContent = "N/A";
                    displayUserId.textContent = "N/A (Not Logged In)";
                    dashboardUserEmail.textContent = "N/A";
                    dashboardUserPhone.textContent = "N/A";
                    dashboardUserNationalId.textContent = "N/A";
                    return;
                }

                displayUserId.textContent = currentUserId;
                dashboardUserEmail.textContent = auth.currentUser.email || "N/A"; // Always show auth email if available

                // Display currentUserName immediately if available (from global currentUserData or auth.currentUser)
                dashboardUserName.textContent = currentUserName || auth.currentUser.email || "Member!";


                // Fetch real-time data from Firestore customers collection
                const customerRef = doc(db, 'customers', currentUserId);
                // Using onSnapshot for real-time updates on dashboard balances and profile data
                if (window.unsubscribeUserProfile) {
                    window.unsubscribeUserProfile();
                }

                window.unsubscribeUserProfile = onSnapshot(customerRef, (userDoc) => {
                    if (userDoc.exists()) {
                        currentUserData = userDoc.data(); // Update global currentUserData
                        dashboardUserName.textContent = currentUserData.name || auth.currentUser.email || "Member!"; // Used 'name'
                        contributionBalance.textContent = `KSh ${currentUserData.contribution_balance?.toFixed(2) || '0.00'}`;
                        loanBalance.textContent = `KSh ${currentUserData.loan_balance?.toFixed(2) || '0.00'}`;
                        nextMeetingDate.textContent = currentUserData.next_meeting_date || "To be announced";

                        // Populate new dashboard elements with data from Firestore profile
                        dashboardUserPhone.textContent = currentUserData.phone || "N/A";
                        dashboardUserNationalId.textContent = currentUserData.nationalId || "N/A";

                        // Display messages based on verification and approval status
                        if (!auth.currentUser.emailVerified) {
                            showMessage("Please verify your email address to unlock full features. Check your inbox for the link.", "error");
                        } else if (currentUserData.status === 'pending') {
                            showMessage("Your account is pending admin approval. Some features may be locked until approved.", "error");
                        } else if (currentUserData.status === 'approved' && auth.currentUser.emailVerified) {
                             // If everything is good, just show a success message if coming from pending/unverified
                             showMessage("Your account is fully active. Welcome to your dashboard!", "success");
                        }


                    } else {
                        // Profile document missing, but don't log out.
                        // Display default values and show an error/warning message.
                        console.warn("No user profile found for current user, or it was deleted. Displaying default values.");
                        dashboardUserName.textContent = auth.currentUser.email || "Member!";
                        contributionBalance.textContent = "KSh 0.00";
                        loanBalance.textContent = "KSh 0.00";
                        nextMeetingDate.textContent = "To be announced";
                        dashboardUserEmail.textContent = auth.currentUser.email || "N/A";
                        dashboardUserPhone.textContent = "N/A";
                        dashboardUserNationalId.textContent = "N/A";
                        showMessage("Your profile data is missing or incomplete. Please use the 'Update Profile' section.", "error");
                        // The user is still logged in to Firebase Auth, just their profile data in Firestore is an issue.
                        // Update currentUserData to reflect the "missing" state locally as well
                        currentUserData = {
                            name: auth.currentUser.email,
                            email: auth.currentUser.email,
                            phone: "N/A",
                            nationalId: "N/A",
                            contribution_balance: 0,
                            loan_balance: 0,
                            next_meeting_date: "To be announced",
                            status: "pending", // Default to pending if profile document disappears
                            profilePicUrl: ""
                        };
                    }
                }, (error) => {
                    console.error("Error fetching dashboard data (onSnapshot):", error);
                    showMessage("Failed to load dashboard data. Please refresh.", "error");
                    // Set default placeholders on error
                    dashboardUserName.textContent = auth.currentUser.email || "Member!";
                    contributionBalance.textContent = "KSh 0.00";
                    loanBalance.textContent = "KSh 0.00";
                    nextMeetingDate.textContent = "To be announced";
                    dashboardUserEmail.textContent = auth.currentUser.email || "N/A";
                    dashboardUserPhone.textContent = "N/A";
                    dashboardUserNationalId.textContent = "N/A";
                });
            }

            // Handle Add Meeting (Admin functionality - mock access control for now)
            async function handleAddMeeting(event) {
                event.preventDefault();
                // Basic admin check - in real app, use Firebase Security Rules + backend roles
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Only fully approved administrators can add meetings.", "error");
                    return;
                }
                if (currentUserData.status !== 'admin') { // Allowing "approved" for testing as "admin" might not be set up
                    showMessage("Only administrators can add meetings.", "error");
                    return;
                }

                const title = document.getElementById('meeting-title').value.trim();
                const date = document.getElementById('meeting-date').value;
                const time = document.getElementById('meeting-time').value;
                const location = document.getElementById('meeting-location').value.trim();
                const description = document.getElementById('meeting-description').value.trim();
                const type = document.getElementById('meeting-type').value;

                if (!title || !date || !time || !location || !description || !type) {
                    showMessage("All meeting fields are required.", "error");
                    return;
                }

                try {
                    await addDoc(collection(db, getPublicCollectionPath('meetings')), {
                        title: title,
                        date: new Date(`${date}T${time}`), // Storing date as Timestamp
                        time: time,
                        location: location,
                        description: description,
                        type: type,
                        createdAt: serverTimestamp()
                    });
                    showMessage("Meeting added successfully!", "success");
                    document.getElementById('add-meeting-form').reset();
                } catch (error) {
                    console.error("Error adding meeting:", error);
                    showMessage("Failed to add meeting. Please try again.", "error");
                }
            }

            // Handle Add Investment (Admin functionality)
            async function handleAddInvestment(event) {
                event.preventDefault();
                 // Basic admin check - in real app, use Firebase Security Rules + backend roles
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Only fully approved administrators can add investment opportunities.", "error");
                    return;
                }
                if (currentUserData.status !== 'admin') {
                    showMessage("Only administrators can add investment opportunities.", "error");
                    return;
                }


                const title = document.getElementById('investment-title').value.trim();
                const amount = parseFloat(document.getElementById('investment-amount').value);
                const description = document.getElementById('investment-description').value.trim();

                if (!title || isNaN(amount) || amount <= 0 || !description) {
                    showMessage("All investment fields are required and goal must be a positive number.", "error");
                    return;
                }

                try {
                    await addDoc(collection(db, getPublicCollectionPath('investments')), {
                        title: title,
                        amount: amount,
                        description: description,
                        pledged: 0, // Initial pledged amount
                        estimatedReturn: "N/A", // Placeholder
                        createdAt: serverTimestamp()
                    });
                    showMessage("Investment opportunity added successfully!", "success");
                    document.getElementById('add-investment-form').reset();
                } catch (error) {
                    console.error("Error adding investment:", error);
                    showMessage("Failed to add investment. Please try again.", "error");
                }
            }

            // Handle Pledge Contribution to Investment
            async function handlePledgeContribution(investmentId, amount) {
                if (!currentUserId) {
                    showMessage("Please log in to pledge to an investment.", "error");
                    window.renderPage('login');
                    return;
                }
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                     showMessage("Your account is not yet fully activated. Please verify your email and await admin approval to pledge to investments.", "error");
                     return;
                 }

                const investmentRef = doc(db, getPublicCollectionPath('investments'), investmentId);
                const userProfileRef = doc(db, 'user_profile', currentUserId);
                // Note: The prompt mentioned 'investment_pledges' as a private collection directly under user,
                // but the current implementation adds a specific document for each pledge.
                // The current structure of updating `currentUserData.investment_pledges` is for local tracking.
                // If a separate `investment_pledges` subcollection for each user is desired for detailed logs:
                // const userPledgeCollectionRef = collection(db, 'investment_pledges');

                try {
                    // Check if user has already pledged to this investment using the local currentUserData
                    if (currentUserData.investment_pledges && currentUserData.investment_pledges[investmentId]) {
                        showMessage("You have already pledged to this investment. You cannot pledge again.", "error");
                        return;
                    }

                    // Atomically update the total pledged amount on the main investment document
                    // Use a transaction to ensure atomicity for concurrent updates
                    const transactionResult = await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(investmentRef);
                        if (!sfDoc.exists()) {
                            throw "Investment document does not exist!";
                        }
                        const newPledged = (sfDoc.data().pledged || 0) + amount;
                        transaction.update(investmentRef, { pledged: newPledged });
                    });

                    // Update user profile to record that they have pledged to this investment
                    const updatedUserPledges = { ...currentUserData.investment_pledges, [investmentId]: amount };
                    await updateDoc(userProfileRef, {
                        investment_pledges: updatedUserPledges
                    });
                    currentUserData.investment_pledges = updatedUserPledges; // Update local state

                    showMessage(`Successfully pledged KSh ${amount.toFixed(2)} to this investment!`, "success");
                } catch (error) {
                    console.error("Error pledging to investment:", error);
                    showMessage("Failed to pledge. Please try again.", "error");
                }
            }


            // Handle Create Poll (Admin functionality)
            async function handleCreatePoll(event) {
                event.preventDefault();
                // Basic admin check
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Only fully approved administrators can create polls.", "error");
                    return;
                }
                if (currentUserData.status !== 'admin') {
                    showMessage("Only administrators can create polls.", "error");
                    return;
                }

                const title = document.getElementById('poll-title').value.trim();
                const optionsInput = document.getElementById('poll-options').value.trim();

                if (!title || !optionsInput) {
                    showMessage("Poll title/question and options are required.", "error");
                    return;
                }

                const optionsArray = optionsInput.split(',').map(opt => opt.trim()).filter(opt => opt.length > 0);
                if (optionsArray.length < 2) {
                    showMessage("Please provide at least two options for the poll.", "error");
                    return;
                }

                // Initialize results object
                const votes = {};
                optionsArray.forEach(option => {
                    votes[option] = 0;
                });

                try {
                    await addDoc(collection(db, getPublicCollectionPath('polls')), {
                        title: title,
                        options: optionsArray,
                        votes: votes,
                        createdAt: serverTimestamp(),
                        status: 'active'
                    });
                    showMessage("Poll created successfully!", "success");
                    document.getElementById('create-poll-form').reset();
                } catch (error) {
                    console.error("Error creating poll:", error);
                    showMessage("Failed to create poll. Please try again.", "error");
                }
            }

            // Handle Vote
            async function handleVote(pollId, option) {
                if (!currentUserId) {
                    showMessage("Please log in to vote.", "error");
                    window.renderPage('login');
                    return;
                }
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Your account is not yet fully activated. Please verify your email and await admin approval to vote.", "error");
                    return;
                }

                const pollRef = doc(db, getPublicCollectionPath('polls'), pollId);
                const userProfileRef = doc(db, 'user_profile', currentUserId);

                try {
                    // Check if user has already voted for this poll from local currentUserData
                    const existingUserVotes = currentUserData.votes || {};
                    if (existingUserVotes[pollId]) {
                        showMessage("You have already voted in this poll.", "error");
                        return;
                    }

                    // Atomically update poll results using a transaction to prevent race conditions
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(pollRef);
                        if (!sfDoc.exists()) {
                            throw "Poll document does not exist!";
                        }
                        const newVotes = { ...sfDoc.data().votes };
                        newVotes[option] = (newVotes[option] || 0) + 1;
                        transaction.update(pollRef, { votes: newVotes });
                    });

                    // Record user's vote in their profile
                    existingUserVotes[pollId] = option;
                    await updateDoc(userProfileRef, {
                        votes: existingUserVotes
                    });
                    currentUserData.votes = existingUserVotes; // Update local state

                    showMessage("Your vote has been cast successfully!", "success");
                } catch (error) {
                    console.error("Error casting vote:", error);
                    showMessage("Failed to cast vote. Please try again.", "error");
                }
            }

            // Handle Upload Document (Admin functionality)
            async function handleUploadDocument(event) {
                event.preventDefault();
                // Basic admin check
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                    showMessage("Only fully approved administrators can upload documents.", "error");
                    return;
                }
                if (currentUserData.status !== 'admin') {
                    showMessage("Only administrators can upload documents.", "error");
                    return;
                }

                const title = document.getElementById('document-title').value.trim();
                const fileUrl = document.getElementById('document-file-url').value.trim();

                if (!title || !fileUrl) {
                    showMessage("Document title and file URL are required.", "error");
                    return;
                }

                try {
                    await addDoc(collection(db, getPublicCollectionPath('documents')), {
                        title: title,
                        fileUrl: fileUrl,
                        uploadedBy: currentUserName || currentUserId,
                        uploadedAt: serverTimestamp()
                    });
                    showMessage("Document uploaded successfully!", "success");
                    document.getElementById('upload-document-form').reset();
                } catch (error) {
                    console.error("Error uploading document:", error);
                    showMessage("Failed to upload document. Please try again.", "error");
                }
            }

            // Handle Post Forum Message (Placeholder for now, requires more complex forum logic)
            async function handlePostForumMessage() {
                const content = document.getElementById('forum-post-content').value.trim();
                if (!content) {
                    showMessage("Message cannot be empty.", "error");
                    return;
                }
                if (!currentUserId) {
                    showMessage("Please log in to post messages.", "error");
                    return;
                }
                // Check for both email verification and profile approval for sensitive actions
                if (!auth.currentUser.emailVerified || currentUserData.status !== 'approved') {
                     showMessage("Your account is not yet fully activated. Please verify your email and await admin approval to post in the forum.", "error");
                     return;
                 }

                try {
                    // In a real forum, you might add to a 'forum_posts' collection in public data
                    // For now, it's just a mock and clears the input
                    showMessage("Your forum message has been posted (feature in development)!", "success");
                    document.getElementById('forum-post-content').value = '';
                    // You would typically reload forum posts here.
                    loadForumPosts(); // Reloads mock data for now
                } catch (error) {
                    console.error("Error posting forum message:", error);
                    showMessage("Failed to post message.", "error");
                }
            }


            // Initial page load based on URL hash or default to home
            // This now runs AFTER DOMContentLoaded, ensuring all elements are available.
            const initialHash = window.location.hash.substring(1);
            const hashParts = initialHash.split('/');
            const mainPage = hashParts[0];
            const subPage = hashParts[1];

            if (mainPage && pages[mainPage]) {
                window.renderPage(mainPage);
                if (mainPage === 'dashboard' && subPage && dashboardSubpages[subPage]) {
                    window.renderDashboardSubpage(subPage);
                }
            } else {
                window.renderPage('home');
            }

            // ===== New Functions for Additional Sections =====

            // Load user reports
            async function loadUserReports() {
                const reportsListDiv = document.getElementById('reports-list');
                if (!reportsListDiv) return;

                try {
                    const reportsSnapshot = await getDocs(collection(db, 'reports'));
                    let userReports = [];

                    reportsSnapshot.forEach(doc => {
                        const data = doc.data();
                        // Filter reports for current user or public reports
                        if (!data.userId || data.userId === currentUserId) {
                            userReports.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });

                    if (userReports.length === 0) {
                        reportsListDiv.innerHTML = `
                            <div class="text-center p-8 bg-gray-50 rounded-lg">
                                <i class="fas fa-chart-bar text-gray-400 text-4xl mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Reports Available</h3>
                                <p class="text-gray-500">No reports have been generated yet.</p>
                            </div>
                        `;
                        return;
                    }

                    reportsListDiv.innerHTML = userReports.map(report => `
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-maroon">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-800">${report.type || 'Report'}</h4>
                                    <p class="text-sm text-gray-600">Generated: ${report.generatedDate ? new Date(report.generatedDate.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                                    <p class="text-sm text-gray-600">Period: ${report.period || 'N/A'}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="downloadUserReport('${report.id}')" class="btn-primary text-sm px-3 py-1">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading user reports:', error);
                    reportsListDiv.innerHTML = `
                        <div class="text-center text-red-500 p-4">
                            Error loading reports. Please try again.
                        </div>
                    `;
                }
            }

            // Generate user report
            async function generateUserReport(type) {
                try {
                    const reportData = {
                        type: type,
                        userId: currentUserId,
                        generatedDate: serverTimestamp(),
                        period: new Date().toLocaleDateString(),
                        status: 'completed'
                    };
                    
                    await addDoc(collection(db, 'reports'), reportData);
                    showMessage(`${type} report generated successfully!`, "success");
                    loadUserReports();
                } catch (error) {
                    console.error('Error generating user report:', error);
                    showMessage('Error generating report', "error");
                }
            }

            // Download user report
            async function downloadUserReport(reportId) {
                showMessage('Report download functionality coming soon!', "info");
            }

            // Load user analytics
            async function loadUserAnalytics() {
                try {
                    // Calculate user's total contributions
                    const contributionsSnapshot = await getDocs(collection(db, 'contributions'));
                    let userTotalContributions = 0;
                    contributionsSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === currentUserId) {
                            userTotalContributions += data.amount || 0;
                        }
                    });
                    document.getElementById('user-total-contributions').textContent = `KSh ${userTotalContributions.toLocaleString()}`;

                    // Calculate user's active loans
                    const loansSnapshot = await getDocs(collection(db, 'loans'));
                    let userActiveLoans = 0;
                    loansSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === currentUserId && (data.status === 'active' || data.status === 'approved')) {
                            userActiveLoans++;
                        }
                    });
                    document.getElementById('user-active-loans').textContent = userActiveLoans;

                    // Calculate user's attendance rate
                    const attendanceSnapshot = await getDocs(collection(db, 'attendance'));
                    const meetingsSnapshot = await getDocs(collection(db, 'meetings'));
                    const totalMeetings = meetingsSnapshot.size;
                    let userAttendanceCount = 0;
                    attendanceSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === currentUserId && data.status === 'present') {
                            userAttendanceCount++;
                        }
                    });
                    const attendanceRate = totalMeetings > 0 ? Math.round((userAttendanceCount / totalMeetings) * 100) : 0;
                    document.getElementById('user-attendance-rate').textContent = `${attendanceRate}%`;

                    // Load user activity timeline
                    const activityDiv = document.getElementById('user-activity-timeline');
                    let userActivity = [];

                    // Get user's recent contributions
                    contributionsSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === currentUserId) {
                            userActivity.push({
                                type: 'contribution',
                                message: `Made contribution of KSh ${data.amount?.toLocaleString()}`,
                                date: data.date,
                                icon: 'fas fa-money-bill-wave'
                            });
                        }
                    });

                    // Get user's recent loans
                    loansSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === currentUserId) {
                            userActivity.push({
                                type: 'loan',
                                message: `Applied for loan of KSh ${data.amount?.toLocaleString()}`,
                                date: data.timestamp,
                                icon: 'fas fa-hand-holding-usd'
                            });
                        }
                    });

                    // Sort by date and take latest 10
                    userActivity.sort((a, b) => {
                        const dateA = a.date?.seconds || 0;
                        const dateB = b.date?.seconds || 0;
                        return dateB - dateA;
                    });

                    userActivity = userActivity.slice(0, 10);

                    if (userActivity.length === 0) {
                        activityDiv.innerHTML = `
                            <div class="text-center p-8 bg-gray-50 rounded-lg">
                                <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">No Recent Activity</h3>
                                <p class="text-gray-500">No recent activity to display.</p>
                            </div>
                        `;
                        return;
                    }

                    activityDiv.innerHTML = userActivity.map(activity => `
                        <div class="flex items-center p-4 bg-white rounded-lg shadow-sm border-l-4 border-maroon">
                            <i class="${activity.icon} text-maroon text-xl mr-4"></i>
                            <div class="flex-1">
                                <p class="text-gray-800">${activity.message}</p>
                                <p class="text-xs text-gray-500">${activity.date ? new Date(activity.date.seconds * 1000).toLocaleString() : 'N/A'}</p>
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    console.error('Error loading user analytics:', error);
                    const activityDiv = document.getElementById('user-activity-timeline');
                    if (activityDiv) {
                        activityDiv.innerHTML = `
                            <div class="text-center text-red-500 p-4">
                                Error loading analytics data. Please try again.
                            </div>
                        `;
                    }
                }
            }

            // Load user settings
            async function loadUserSettings() {
                try {
                    // Load current user settings from customers collection
                    const customerRef = doc(db, 'customers', currentUserId);
                    const customerSnap = await getDoc(customerRef);
                    
                    if (customerSnap.exists()) {
                        const userData = customerSnap.data();
                        
                        // Set notification preferences
                        document.getElementById('email-notifications').checked = userData.emailNotifications !== false;
                        document.getElementById('sms-notifications').checked = userData.smsNotifications === true;
                        document.getElementById('profile-visibility').checked = userData.profileVisibility !== false;
                    }
                } catch (error) {
                    console.error('Error loading user settings:', error);
                    showMessage('Error loading settings', "error");
                }
            }

            // Save user settings
            async function saveUserSettings() {
                try {
                    const emailNotifications = document.getElementById('email-notifications').checked;
                    const smsNotifications = document.getElementById('sms-notifications').checked;
                    const profileVisibility = document.getElementById('profile-visibility').checked;

                    const customerRef = doc(db, 'customers', currentUserId);
                    await updateDoc(customerRef, {
                        emailNotifications: emailNotifications,
                        smsNotifications: smsNotifications,
                        profileVisibility: profileVisibility
                    });

                    showMessage('Settings saved successfully!', "success");
                } catch (error) {
                    console.error('Error saving user settings:', error);
                    showMessage('Error saving settings', "error");
                }
            }

            // Service Modal Functions
            function openServiceModal(serviceType) {
                console.log('Opening modal for service:', serviceType);
                const modal = document.getElementById('service-modal-overlay');
                const title = document.getElementById('service-modal-title');
                const body = document.getElementById('service-modal-body');
                const submitBtn = document.getElementById('service-modal-submit');
                
                if (!modal) {
                    console.error('Modal element not found!');
                    return;
                }
                
                // Set title and form content based on service type
                const serviceConfig = getServiceConfig(serviceType);
                title.textContent = serviceConfig.title;
                body.innerHTML = serviceConfig.formHTML;
                submitBtn.textContent = serviceConfig.submitText;
                
                // Show modal
                modal.classList.add('show');
                console.log('Modal should be visible now');
                
                // Add event listeners
                document.getElementById('service-modal-close').onclick = closeServiceModal;
                document.getElementById('service-modal-cancel').onclick = closeServiceModal;
                submitBtn.onclick = () => handleServiceSubmit(serviceType);
            }
            
            function closeServiceModal() {
                const modal = document.getElementById('service-modal-overlay');
                if (modal) {
                    modal.classList.remove('show');
                }
            }
            
            // Dashboard Modal Functions
            function openDashboardModal(serviceType) {
                console.log('Opening dashboard modal for service:', serviceType);
                const modal = document.getElementById('service-modal-overlay');
                const title = document.getElementById('service-modal-title');
                const body = document.getElementById('service-modal-body');
                const submitBtn = document.getElementById('service-modal-submit');
                
                if (!modal) {
                    console.error('Modal element not found!');
                    return;
                }
                
                // Set title and form content based on service type
                const serviceConfig = getServiceConfig(serviceType);
                title.textContent = serviceConfig.title;
                body.innerHTML = serviceConfig.formHTML;
                submitBtn.textContent = serviceConfig.submitText;
                
                // Show modal
                modal.classList.add('show');
                console.log('Dashboard modal should be visible now');
                
                // Add event listeners
                document.getElementById('service-modal-close').onclick = closeServiceModal;
                document.getElementById('service-modal-cancel').onclick = closeServiceModal;
                submitBtn.onclick = () => handleServiceSubmit(serviceType);
            }
            
            function getServiceConfig(serviceType) {
                const configs = {
                    'make-contribution': {
                        title: 'Make Contribution',
                        submitText: 'Submit Contribution',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="contribution-amount">Amount (KSh)</label>
                                <input type="number" id="contribution-amount" placeholder="e.g., 1000" required min="1">
                            </div>
                            <div class="service-form-group">
                                <label for="payment-method">Payment Method</label>
                                <select id="payment-method" required>
                                    <option value="">Select Method</option>
                                    <option value="mpesa">M-Pesa</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="contribution-description">Description (Optional)</label>
                                <input type="text" id="contribution-description" placeholder="e.g., Monthly savings">
                            </div>
                        `
                    },
                    'request-loan': {
                        title: 'Request Loan',
                        submitText: 'Submit Loan Request',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="loan-amount">Loan Amount (KSh)</label>
                                <input type="number" id="loan-amount" placeholder="e.g., 10000" required min="100">
                            </div>
                            <div class="service-form-group">
                                <label for="loan-interest-rate">Interest Rate (%)</label>
                                <input type="number" id="loan-interest-rate" placeholder="e.g., 5" required min="0" max="100" step="0.1">
                            </div>
                            <div class="service-form-group">
                                <label for="loan-due-date">Due Date</label>
                                <input type="date" id="loan-due-date" required>
                            </div>
                            <div class="service-form-group">
                                <label for="repayment-plan">Preferred Repayment Plan</label>
                                <select id="repayment-plan" required>
                                    <option value="">Select Plan</option>
                                    <option value="3_months">3 Months</option>
                                    <option value="6_months">6 Months</option>
                                    <option value="12_months">12 Months</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="loan-purpose">Purpose of Loan</label>
                                <textarea id="loan-purpose" placeholder="Briefly describe why you need the loan..." required></textarea>
                            </div>
                        `
                    },
                    'view-statements': {
                        title: 'View Financial Statements',
                        submitText: 'Generate Statement',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="statement-period">Statement Period</label>
                                <select id="statement-period" required>
                                    <option value="">Select Period</option>
                                    <option value="current_month">Current Month</option>
                                    <option value="last_3_months">Last 3 Months</option>
                                    <option value="last_6_months">Last 6 Months</option>
                                    <option value="last_year">Last Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="service-form-group" id="custom-date-range" style="display: none;">
                                <label for="start-date">Start Date</label>
                                <input type="date" id="start-date">
                            </div>
                            <div class="service-form-group" id="custom-end-date" style="display: none;">
                                <label for="end-date">End Date</label>
                                <input type="date" id="end-date">
                            </div>
                            <div class="service-form-group">
                                <label for="statement-type">Statement Type</label>
                                <select id="statement-type" required>
                                    <option value="">Select Type</option>
                                    <option value="summary">Summary Statement</option>
                                    <option value="detailed">Detailed Statement</option>
                                    <option value="contributions_only">Contributions Only</option>
                                    <option value="loans_only">Loans Only</option>
                                </select>
                            </div>
                        `
                    },
                    'contribution-history': {
                        title: 'Contribution History',
                        submitText: 'View History',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="history-period">Time Period</label>
                                <select id="history-period" required>
                                    <option value="">Select Period</option>
                                    <option value="all_time">All Time</option>
                                    <option value="this_year">This Year</option>
                                    <option value="last_6_months">Last 6 Months</option>
                                    <option value="last_3_months">Last 3 Months</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="history-format">Display Format</label>
                                <select id="history-format" required>
                                    <option value="">Select Format</option>
                                    <option value="table">Table View</option>
                                    <option value="chart">Chart View</option>
                                    <option value="export">Export to PDF</option>
                                </select>
                            </div>
                        `
                    },
                    'loan-history': {
                        title: 'Loan History',
                        submitText: 'View Loan History',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="loan-status-filter">Loan Status</label>
                                <select id="loan-status-filter">
                                    <option value="">All Loans</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="repaid">Repaid</option>
                                    <option value="active">Active</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="loan-period">Time Period</label>
                                <select id="loan-period" required>
                                    <option value="">Select Period</option>
                                    <option value="all_time">All Time</option>
                                    <option value="this_year">This Year</option>
                                    <option value="last_12_months">Last 12 Months</option>
                                </select>
                            </div>
                        `
                    },
                    'group-overview': {
                        title: 'Group Overview',
                        submitText: 'View Overview',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="overview-type">Overview Type</label>
                                <select id="overview-type" required>
                                    <option value="">Select Type</option>
                                    <option value="financial_summary">Financial Summary</option>
                                    <option value="member_statistics">Member Statistics</option>
                                    <option value="contribution_trends">Contribution Trends</option>
                                    <option value="loan_performance">Loan Performance</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="overview-period">Time Period</label>
                                <select id="overview-period" required>
                                    <option value="">Select Period</option>
                                    <option value="current_month">Current Month</option>
                                    <option value="last_3_months">Last 3 Months</option>
                                    <option value="last_6_months">Last 6 Months</option>
                                    <option value="this_year">This Year</option>
                                </select>
                            </div>
                        `
                    },
                    'meetings': {
                        title: 'Meeting Management',
                        submitText: 'View Meetings',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="meeting-type">Meeting Type</label>
                                <select id="meeting-type">
                                    <option value="">All Meetings</option>
                                    <option value="regular">Regular Meetings</option>
                                    <option value="special">Special Meetings</option>
                                    <option value="emergency">Emergency Meetings</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="meeting-status">Meeting Status</label>
                                <select id="meeting-status">
                                    <option value="">All Status</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="past">Past Meetings</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        `
                    },
                    'fines': {
                        title: 'Fines & Penalties',
                        submitText: 'View Fines',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="fine-status">Fine Status</label>
                                <select id="fine-status">
                                    <option value="">All Fines</option>
                                    <option value="pending">Pending Payment</option>
                                    <option value="paid">Paid</option>
                                    <option value="waived">Waived</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="fine-period">Time Period</label>
                                <select id="fine-period" required>
                                    <option value="">Select Period</option>
                                    <option value="all_time">All Time</option>
                                    <option value="this_year">This Year</option>
                                    <option value="last_6_months">Last 6 Months</option>
                                </select>
                            </div>
                        `
                    },
                    'investments': {
                        title: 'Investment Opportunities',
                        submitText: 'View Investments',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="investment-status">Investment Status</label>
                                <select id="investment-status">
                                    <option value="">All Investments</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="investment-type">Investment Type</label>
                                <select id="investment-type">
                                    <option value="">All Types</option>
                                    <option value="real_estate">Real Estate</option>
                                    <option value="stocks">Stocks</option>
                                    <option value="bonds">Bonds</option>
                                    <option value="business">Business</option>
                                </select>
                            </div>
                        `
                    },
                    'attendance': {
                        title: 'Attendance Tracking',
                        submitText: 'View Attendance',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="attendance-period">Time Period</label>
                                <select id="attendance-period" required>
                                    <option value="">Select Period</option>
                                    <option value="this_year">This Year</option>
                                    <option value="last_6_months">Last 6 Months</option>
                                    <option value="last_3_months">Last 3 Months</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="attendance-format">Display Format</label>
                                <select id="attendance-format" required>
                                    <option value="">Select Format</option>
                                    <option value="summary">Summary</option>
                                    <option value="detailed">Detailed List</option>
                                    <option value="chart">Chart View</option>
                                </select>
                            </div>
                        `
                    },
                    'documents': {
                        title: 'Document Management',
                        submitText: 'View Documents',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="document-type">Document Type</label>
                                <select id="document-type">
                                    <option value="">All Documents</option>
                                    <option value="constitution">Constitution</option>
                                    <option value="bylaws">Bylaws</option>
                                    <option value="minutes">Meeting Minutes</option>
                                    <option value="financial_reports">Financial Reports</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="document-period">Time Period</label>
                                <select id="document-period">
                                    <option value="">All Time</option>
                                    <option value="this_year">This Year</option>
                                    <option value="last_year">Last Year</option>
                                </select>
                            </div>
                        `
                    },
                    'update-profile': {
                        title: 'Update Profile',
                        submitText: 'Update Profile',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="profile-name">Full Name</label>
                                <input type="text" id="profile-name" placeholder="Enter your full name" required>
                            </div>
                            <div class="service-form-group">
                                <label for="profile-phone">Phone Number</label>
                                <input type="tel" id="profile-phone" placeholder="+254 7XX XXX XXX" required pattern="^\\+?\\d{10,14}$">
                            </div>
                            <div class="service-form-group">
                                <label for="profile-national-id">National ID</label>
                                <input type="text" id="profile-national-id" placeholder="12345678" required>
                            </div>
                            <div class="service-form-group">
                                <label for="profile-pic-url">Profile Picture URL (Optional)</label>
                                <input type="url" id="profile-pic-url" placeholder="https://example.com/your-image.jpg">
                            </div>
                        `
                    },
                    'notifications': {
                        title: 'Notifications',
                        submitText: 'View Notifications',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="notification-status">Notification Status</label>
                                <select id="notification-status">
                                    <option value="">All Notifications</option>
                                    <option value="unread">Unread</option>
                                    <option value="read">Read</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="notification-type">Notification Type</label>
                                <select id="notification-type">
                                    <option value="">All Types</option>
                                    <option value="meeting_reminder">Meeting Reminders</option>
                                    <option value="payment_due">Payment Due</option>
                                    <option value="loan_approval">Loan Approvals</option>
                                    <option value="general">General Announcements</option>
                                </select>
                            </div>
                        `
                    },
                    'voting-polls': {
                        title: 'Voting & Polls',
                        submitText: 'View Polls',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="poll-status">Poll Status</label>
                                <select id="poll-status">
                                    <option value="">All Polls</option>
                                    <option value="active">Active Polls</option>
                                    <option value="completed">Completed Polls</option>
                                    <option value="upcoming">Upcoming Polls</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="poll-type">Poll Type</label>
                                <select id="poll-type">
                                    <option value="">All Types</option>
                                    <option value="financial">Financial Decisions</option>
                                    <option value="meeting">Meeting Related</option>
                                    <option value="investment">Investment Decisions</option>
                                    <option value="general">General Matters</option>
                                </select>
                            </div>
                        `
                    },
                    'reports': {
                        title: 'Reports & Analytics',
                        submitText: 'Generate Report',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="report-type">Report Type</label>
                                <select id="report-type" required>
                                    <option value="">Select Report Type</option>
                                    <option value="financial_summary">Financial Summary</option>
                                    <option value="member_activity">Member Activity</option>
                                    <option value="contribution_analysis">Contribution Analysis</option>
                                    <option value="loan_performance">Loan Performance</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="report-period">Report Period</label>
                                <select id="report-period" required>
                                    <option value="">Select Period</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="report-format">Report Format</label>
                                <select id="report-format" required>
                                    <option value="">Select Format</option>
                                    <option value="pdf">PDF Document</option>
                                    <option value="excel">Excel Spreadsheet</option>
                                    <option value="web">Web View</option>
                                </select>
                            </div>
                        `
                    },
                    'analytics': {
                        title: 'Personal Analytics',
                        submitText: 'View Analytics',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="analytics-type">Analytics Type</label>
                                <select id="analytics-type" required>
                                    <option value="">Select Analytics Type</option>
                                    <option value="savings_trends">Savings Trends</option>
                                    <option value="contribution_patterns">Contribution Patterns</option>
                                    <option value="financial_goals">Financial Goals Progress</option>
                                    <option value="loan_history">Loan History Analysis</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="analytics-period">Time Period</label>
                                <select id="analytics-period" required>
                                    <option value="">Select Period</option>
                                    <option value="6_months">Last 6 Months</option>
                                    <option value="1_year">Last Year</option>
                                    <option value="2_years">Last 2 Years</option>
                                    <option value="all_time">All Time</option>
                                </select>
                            </div>
                        `
                    },
                    'settings': {
                        title: 'Account Settings',
                        submitText: 'Save Settings',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="email-notifications">Email Notifications</label>
                                <select id="email-notifications">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="sms-notifications">SMS Notifications</label>
                                <select id="sms-notifications">
                                    <option value="disabled">Disabled</option>
                                    <option value="enabled">Enabled</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="profile-visibility">Profile Visibility</label>
                                <select id="profile-visibility">
                                    <option value="public">Public</option>
                                    <option value="private">Private</option>
                                </select>
                            </div>
                            <div class="service-form-group">
                                <label for="language">Language Preference</label>
                                <select id="language">
                                    <option value="en">English</option>
                                    <option value="sw">Swahili</option>
                                </select>
                            </div>
                        `
                    },
                    'security-support': {
                        title: 'Security & Support',
                        submitText: 'Access Security',
                        formHTML: `
                            <div class="service-form-group">
                                <label for="security-action">Security Action</label>
                                <select id="security-action" required>
                                    <option value="">Select Action</option>
                                    <option value="change_password">Change Password</option>
                                    <option value="two_factor_auth">Enable Two-Factor Auth</option>
                                    <option value="security_logs">View Security Logs</option>
                                    <option value="contact_support">Contact Support</option>
                                </select>
                            </div>
                            <div class="service-form-group" id="password-fields" style="display: none;">
                                <label for="current-password">Current Password</label>
                                <input type="password" id="current-password" placeholder="Enter current password">
                            </div>
                            <div class="service-form-group" id="new-password-fields" style="display: none;">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" placeholder="Enter new password">
                            </div>
                            <div class="service-form-group" id="confirm-password-fields" style="display: none;">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" placeholder="Confirm new password">
                            </div>
                        `
                    }
                };
                
                return configs[serviceType] || {
                    title: 'Service',
                    submitText: 'Submit',
                    formHTML: '<p>Service form not available.</p>'
                };
            }
            
            function handleServiceSubmit(serviceType) {
                // Check if user is logged in
                if (!currentUserId) {
                    showMessage('Please log in to use this service.', 'error');
                    closeServiceModal();
                    window.renderPage('login');
                    return;
                }
                
                // Handle different service submissions
                switch(serviceType) {
                    case 'make-contribution':
                        handleContributionSubmission();
                        break;
                    case 'request-loan':
                        handleLoanSubmission();
                        break;
                    case 'update-profile':
                        handleProfileUpdate();
                        break;
                    default:
                        showMessage('Service submitted successfully!', 'success');
                        closeServiceModal();
                }
            }
            
            function handleContributionSubmission() {
                const amount = document.getElementById('contribution-amount').value;
                const method = document.getElementById('payment-method').value;
                const description = document.getElementById('contribution-description').value;
                
                if (!amount || !method) {
                    showMessage('Please fill in all required fields.', 'error');
                    return;
                }
                
                showMessage(`Contribution of KSh ${amount} via ${method} submitted successfully!`, 'success');
                closeServiceModal();
            }
            
            function handleLoanSubmission() {
                const amount = document.getElementById('loan-amount').value;
                const interestRate = document.getElementById('loan-interest-rate').value;
                const dueDate = document.getElementById('loan-due-date').value;
                const plan = document.getElementById('repayment-plan').value;
                const purpose = document.getElementById('loan-purpose').value;
                
                if (!amount || !interestRate || !dueDate || !plan || !purpose) {
                    showMessage('Please fill in all required fields.', 'error');
                    return;
                }
                
                showMessage(`Loan request for KSh ${amount} submitted successfully!`, 'success');
                closeServiceModal();
            }
            
            function handleProfileUpdate() {
                const name = document.getElementById('profile-name').value;
                const phone = document.getElementById('profile-phone').value;
                const nationalId = document.getElementById('profile-national-id').value;
                const profilePicUrl = document.getElementById('profile-pic-url').value;
                
                if (!name || !phone || !nationalId) {
                    showMessage('Please fill in all required fields.', 'error');
                    return;
                }
                
                showMessage('Profile updated successfully!', 'success');
                closeServiceModal();
            }

            // Initialize modal event listeners
            const modal = document.getElementById('service-modal-overlay');
            if (modal) {
                // Close modal when clicking outside the content
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeServiceModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.classList.contains('show')) {
                        closeServiceModal();
                    }
                });
            }

            // Test function to verify modal works
            function testModal() {
                console.log('Testing modal...');
                openServiceModal('make-contribution');
            }

            // Dashboard Functions
            function showDashboardContent(section) {
                // Update active menu item
                document.querySelectorAll('.dashboard-menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-menu="${section}"]`).classList.add('active');
                
                // Update content title
                const titles = {
                    'overview': 'Dashboard Overview',
                    'contributions': 'Contributions Management',
                    'loans': 'Loan Management',
                    'statements': 'Financial Statements',
                    'meetings': 'Meeting Management',
                    'investments': 'Investment Opportunities',
                    'notifications': 'Notifications Center',
                    'reports': 'Reports & Analytics',
                    'profile': 'Profile Management',
                    'settings': 'Account Settings'
                };
                document.getElementById('content-title').textContent = titles[section] || 'Dashboard';
                
                // Load content based on section
                const content = getDashboardContent(section);
                document.getElementById('dashboard-content').innerHTML = content;
                
                // Load data if user is logged in
                if (currentUserId) {
                    loadDashboardData(section);
                }
            }
            
            function getDashboardContent(section) {
                const contentTemplates = {
                    'overview': `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="dashboard-stat">
                                <h3 id="total-contributions">$0</h3>
                                <p>Total Contributions</p>
                            </div>
                            <div class="dashboard-stat">
                                <h3 id="total-loans">$0</h3>
                                <p>Active Loans</p>
                            </div>
                            <div class="dashboard-stat">
                                <h3 id="group-balance">$0</h3>
                                <p>Group Balance</p>
                            </div>
                            <div class="dashboard-stat">
                                <h3 id="next-meeting">-</h3>
                                <p>Next Meeting</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
                            <div id="recent-activity" class="space-y-3">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading recent activity...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button class="bg-maroon text-white p-4 rounded-lg hover:bg-maroon-dark transition-colors" onclick="openServiceModal('make-contribution')">
                                    <i class="fas fa-plus text-2xl mb-2"></i>
                                    <p class="font-semibold">Make Contribution</p>
                                </button>
                                <button class="bg-maroon text-white p-4 rounded-lg hover:bg-maroon-dark transition-colors" onclick="openServiceModal('request-loan')">
                                    <i class="fas fa-hand-holding-usd text-2xl mb-2"></i>
                                    <p class="font-semibold">Request Loan</p>
                                </button>
                                <button class="bg-maroon text-white p-4 rounded-lg hover:bg-maroon-dark transition-colors" onclick="openServiceModal('view-statements')">
                                    <i class="fas fa-file-invoice text-2xl mb-2"></i>
                                    <p class="font-semibold">View Statements</p>
                                </button>
                            </div>
                        </div>
                    `,
                    
                    'contributions': `
                        <div class="dashboard-card">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800">Contributions</h3>
                                <button class="bg-maroon text-white px-4 py-2 rounded-lg hover:bg-maroon-dark transition-colors" onclick="openServiceModal('make-contribution')">
                                    <i class="fas fa-plus mr-2"></i>Make Contribution
                                </button>
                            </div>
                            <div id="contributions-list">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading contributions...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'loans': `
                        <div class="dashboard-card">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800">Loans</h3>
                                <button class="bg-maroon text-white px-4 py-2 rounded-lg hover:bg-maroon-dark transition-colors" onclick="openServiceModal('request-loan')">
                                    <i class="fas fa-plus mr-2"></i>Request Loan
                                </button>
                            </div>
                            <div id="loans-list">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading loans...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'statements': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Financial Statements</h3>
                            <div id="statements-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading statements...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'meetings': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Meetings</h3>
                            <div id="meetings-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading meetings...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'investments': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Investment Opportunities</h3>
                            <div id="investments-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading investments...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'notifications': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Notifications</h3>
                            <div id="notifications-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading notifications...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'reports': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Reports & Analytics</h3>
                            <div id="reports-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading reports...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'profile': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Profile Management</h3>
                            <div id="profile-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading profile...</p>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    'settings': `
                        <div class="dashboard-card">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Account Settings</h3>
                            <div id="settings-content">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading settings...</p>
                                </div>
                            </div>
                        </div>
                    `
                };
                
                return contentTemplates[section] || '<div class="text-center text-gray-500 py-8"><p>Content not available</p></div>';
            }
            
            function loadDashboardData(section) {
                if (!currentUserId) return;
                
                switch(section) {
                    case 'overview':
                        loadOverviewData();
                        break;
                    case 'contributions':
                        loadContributionsData();
                        break;
                    case 'loans':
                        loadLoansData();
                        break;
                    case 'statements':
                        loadStatementsData();
                        break;
                    case 'meetings':
                        loadMeetingsData();
                        break;
                    case 'investments':
                        loadInvestmentsData();
                        break;
                    case 'notifications':
                        loadNotificationsData();
                        break;
                    case 'reports':
                        loadReportsData();
                        break;
                    case 'profile':
                        loadProfileData();
                        break;
                    case 'settings':
                        loadSettingsData();
                        break;
                }
            }
            
            function loadOverviewData() {
                if (!currentUserId || !db) return;
                
                // Load overview statistics
                Promise.all([
                    getDocs(query(collection(db, 'contributions'), where('userId', '==', currentUserId))),
                    getDocs(query(collection(db, 'loans'), where('userId', '==', currentUserId))),
                    getDocs(collection(db, 'customers')),
                    getDocs(collection(db, 'meetings'))
                ]).then(([contributionsSnap, loansSnap, customersSnap, meetingsSnap]) => {
                    // Get total contributions
                    let totalContributions = 0;
                    contributionsSnap.forEach(doc => {
                        totalContributions += doc.data().amount || 0;
                    });
                    const contributionsElement = document.getElementById('total-contributions');
                    if (contributionsElement) {
                        contributionsElement.textContent = `KSh ${totalContributions.toLocaleString()}`;
                    }
                    
                    // Get active loans
                    let totalLoans = 0;
                    loansSnap.forEach(doc => {
                        const data = doc.data();
                        if (data.status === 'active' || data.status === 'approved') {
                            totalLoans += data.amount || 0;
                        }
                    });
                    const loansElement = document.getElementById('total-loans');
                    if (loansElement) {
                        loansElement.textContent = `KSh ${totalLoans.toLocaleString()}`;
                    }
                    
                    // Get group balance
                    const groupBalanceElement = document.getElementById('group-balance');
                    if (groupBalanceElement) {
                        groupBalanceElement.textContent = `KSh ${totalContributions.toLocaleString()}`;
                    }
                    
                    // Get next meeting
                    const nextMeetingElement = document.getElementById('next-meeting');
                    if (nextMeetingElement && meetingsSnap.size > 0) {
                        const meetings = [];
                        meetingsSnap.forEach(doc => {
                            meetings.push({...doc.data(), id: doc.id});
                        });
                        const upcomingMeetings = meetings.filter(meeting => 
                            meeting.date && new Date(meeting.date.seconds * 1000) > new Date()
                        ).sort((a, b) => a.date.seconds - b.date.seconds);
                        
                        if (upcomingMeetings.length > 0) {
                            const nextMeeting = upcomingMeetings[0];
                            nextMeetingElement.textContent = new Date(nextMeeting.date.seconds * 1000).toLocaleDateString();
                        } else {
                            nextMeetingElement.textContent = 'No upcoming meetings';
                        }
                    }
                }).catch(error => {
                    console.error('Error loading overview data:', error);
                });
                
                // Load recent activity
                loadRecentActivity();
            }
            
            function loadRecentActivity() {
                if (!currentUserId || !db) return;
                
                const activityContainer = document.getElementById('recent-activity');
                if (!activityContainer) return;
                
                // Show loading state
                activityContainer.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading recent activity...</div>';
                
                // Get recent contributions and loans
                Promise.all([
                    getDocs(query(collection(db, 'contributions'), where('userId', '==', currentUserId), orderBy('timestamp', 'desc'), limit(5))),
                    getDocs(query(collection(db, 'loans'), where('userId', '==', currentUserId), orderBy('timestamp', 'desc'), limit(5)))
                ]).then(([contributionsSnap, loansSnap]) => {
                    let activities = [];
                    
                    // Process contributions
                    contributionsSnap.forEach(doc => {
                        const data = doc.data();
                        activities.push({
                            type: 'contribution',
                            amount: data.amount,
                            date: data.timestamp,
                            description: `Contribution of KSh ${data.amount?.toLocaleString() || 0}`
                        });
                    });
                    
                    // Process loans
                    loansSnap.forEach(doc => {
                        const data = doc.data();
                        activities.push({
                            type: 'loan',
                            amount: data.amount,
                            date: data.timestamp,
                            description: `Loan ${data.status} - KSh ${data.amount?.toLocaleString() || 0}`
                        });
                    });
                    
                    // Sort by date
                    activities.sort((a, b) => {
                        const dateA = a.date?.seconds || 0;
                        const dateB = b.date?.seconds || 0;
                        return dateB - dateA;
                    });
                    
                    // Display activities
                    if (activities.length === 0) {
                        activityContainer.innerHTML = '<div class="text-center text-gray-500 py-4"><p>No recent activity</p></div>';
                    } else {
                        let html = '';
                        activities.slice(0, 5).forEach(activity => {
                            const date = activity.date ? new Date(activity.date.seconds * 1000).toLocaleDateString() : 'Unknown';
                            const icon = activity.type === 'contribution' ? 'fa-money-bill-wave text-green-600' : 'fa-hand-holding-usd text-blue-600';
                            html += `
                                <div class="flex items-center p-3 bg-gray-50 rounded-lg mb-2">
                                    <i class="fas ${icon} mr-3"></i>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-800">${activity.description}</p>
                                        <p class="text-xs text-gray-500">${date}</p>
                                    </div>
                                </div>
                            `;
                        });
                        activityContainer.innerHTML = html;
                    }
                }).catch(error => {
                    console.error('Error loading recent activity:', error);
                    activityContainer.innerHTML = '<div class="text-center text-gray-500 py-4"><p>Error loading activity</p></div>';
                });
            }
            
            function loadContributionsData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('contributions-list');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading contributions...</div>';
                
                // Get user's contributions
                getDocs(query(collection(db, 'contributions'), where('userId', '==', currentUserId), orderBy('timestamp', 'desc')))
                    .then(snapshot => {
                        if (snapshot.empty) {
                            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-money-bill-wave text-4xl mb-4 text-gray-300"></i><p>No contributions found</p><p class="text-sm mt-2">Start making contributions to see them here</p></div>';
                            return;
                        }
                        
                        let html = '<div class="space-y-4">';
                        let totalAmount = 0;
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            totalAmount += data.amount || 0;
                            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown';
                            const statusColor = data.status === 'completed' ? 'text-green-600' : 'text-yellow-600';
                            
                            html += `
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">KSh ${(data.amount || 0).toLocaleString()}</h4>
                                            <p class="text-sm text-gray-600">${data.description || 'Contribution'}</p>
                                            <p class="text-xs text-gray-500">${date}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-2 py-1 text-xs rounded-full ${statusColor} bg-gray-100">${data.status || 'pending'}</span>
                                            <p class="text-xs text-gray-500 mt-1">${data.paymentMethod || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        
                        // Add summary
                        html = `
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold">Total Contributions</h3>
                                        <p class="text-2xl font-bold">KSh ${totalAmount.toLocaleString()}</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl opacity-80"></i>
                                </div>
                            </div>
                            ${html}
                        `;
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading contributions:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading contributions</p></div>';
                    });
            }
            
            function loadLoansData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('loans-list');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading loans...</div>';
                
                // Get user's loans
                getDocs(query(collection(db, 'loans'), where('userId', '==', currentUserId), orderBy('timestamp', 'desc')))
                    .then(snapshot => {
                        if (snapshot.empty) {
                            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-hand-holding-usd text-4xl mb-4 text-gray-300"></i><p>No loans found</p><p class="text-sm mt-2">Apply for a loan to see it here</p></div>';
                            return;
                        }
                        
                        let html = '<div class="space-y-4">';
                        let totalAmount = 0;
                        let activeLoans = 0;
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            totalAmount += data.amount || 0;
                            if (data.status === 'active' || data.status === 'approved') {
                                activeLoans += data.amount || 0;
                            }
                            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown';
                            const dueDate = data.dueDate ? new Date(data.dueDate.seconds * 1000).toLocaleDateString() : 'N/A';
                            
                            let statusColor = 'text-gray-600';
                            let statusBg = 'bg-gray-100';
                            switch(data.status) {
                                case 'approved':
                                case 'active':
                                    statusColor = 'text-green-600';
                                    statusBg = 'bg-green-100';
                                    break;
                                case 'rejected':
                                    statusColor = 'text-red-600';
                                    statusBg = 'bg-red-100';
                                    break;
                                case 'pending':
                                    statusColor = 'text-yellow-600';
                                    statusBg = 'bg-yellow-100';
                                    break;
                            }
                            
                            html += `
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">KSh ${(data.amount || 0).toLocaleString()}</h4>
                                            <p class="text-sm text-gray-600">${data.purpose || 'Loan Application'}</p>
                                            <p class="text-xs text-gray-500">Applied: ${date}</p>
                                            <p class="text-xs text-gray-500">Due: ${dueDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-2 py-1 text-xs rounded-full ${statusColor} ${statusBg}">${data.status || 'pending'}</span>
                                            <p class="text-xs text-gray-500 mt-1">Interest: ${data.interestRate || 0}%</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        
                        // Add summary
                        html = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-semibold">Total Loans</h3>
                                            <p class="text-2xl font-bold">KSh ${totalAmount.toLocaleString()}</p>
                                        </div>
                                        <i class="fas fa-hand-holding-usd text-3xl opacity-80"></i>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-semibold">Active Loans</h3>
                                            <p class="text-2xl font-bold">KSh ${activeLoans.toLocaleString()}</p>
                                        </div>
                                        <i class="fas fa-chart-line text-3xl opacity-80"></i>
                                    </div>
                                </div>
                            </div>
                            ${html}
                        `;
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading loans:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading loans</p></div>';
                    });
            }
            
            function loadStatementsData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('statements-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading statements...</div>';
                
                // Get user's financial data for statements
                Promise.all([
                    getDocs(query(collection(db, 'contributions'), where('userId', '==', currentUserId))),
                    getDocs(query(collection(db, 'loans'), where('userId', '==', currentUserId)))
                ]).then(([contributionsSnap, loansSnap]) => {
                    let totalContributions = 0;
                    let totalLoans = 0;
                    let contributionCount = 0;
                    let loanCount = 0;
                    
                    contributionsSnap.forEach(doc => {
                        totalContributions += doc.data().amount || 0;
                        contributionCount++;
                    });
                    
                    loansSnap.forEach(doc => {
                        totalLoans += doc.data().amount || 0;
                        loanCount++;
                    });
                    
                    const netBalance = totalContributions - totalLoans;
                    
                    const html = `
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-maroon to-maroon-light text-white p-6 rounded-lg">
                                <h3 class="text-xl font-bold mb-4">Financial Summary</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="text-center">
                                        <p class="text-2xl font-bold">KSh ${totalContributions.toLocaleString()}</p>
                                        <p class="text-sm opacity-90">Total Contributions</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-bold">KSh ${totalLoans.toLocaleString()}</p>
                                        <p class="text-sm opacity-90">Total Loans</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-bold ${netBalance >= 0 ? 'text-green-300' : 'text-red-300'}">KSh ${netBalance.toLocaleString()}</p>
                                        <p class="text-sm opacity-90">Net Balance</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Contribution Summary</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Total Contributions:</span>
                                            <span class="font-semibold">KSh ${totalContributions.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Number of Contributions:</span>
                                            <span class="font-semibold">${contributionCount}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Average Contribution:</span>
                                            <span class="font-semibold">KSh ${contributionCount > 0 ? (totalContributions / contributionCount).toLocaleString() : '0'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Loan Summary</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Total Loans:</span>
                                            <span class="font-semibold">KSh ${totalLoans.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Number of Loans:</span>
                                            <span class="font-semibold">${loanCount}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Average Loan:</span>
                                            <span class="font-semibold">KSh ${loanCount > 0 ? (totalLoans / loanCount).toLocaleString() : '0'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                }).catch(error => {
                    console.error('Error loading statements:', error);
                    container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading statements</p></div>';
                });
            }
            
            function loadMeetingsData() {
                if (!db) return;
                
                const container = document.getElementById('meetings-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading meetings...</div>';
                
                // Get all meetings
                getDocs(query(collection(db, 'meetings'), orderBy('date', 'desc')))
                    .then(snapshot => {
                        if (snapshot.empty) {
                            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-calendar-alt text-4xl mb-4 text-gray-300"></i><p>No meetings scheduled</p><p class="text-sm mt-2">Check back later for upcoming meetings</p></div>';
                            return;
                        }
                        
                        let html = '<div class="space-y-4">';
                        let upcomingCount = 0;
                        let pastCount = 0;
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const meetingDate = data.date ? new Date(data.date.seconds * 1000) : new Date();
                            const isUpcoming = meetingDate > new Date();
                            
                            if (isUpcoming) upcomingCount++;
                            else pastCount++;
                            
                            const dateStr = meetingDate.toLocaleDateString();
                            const timeStr = data.time || 'TBA';
                            const locationStr = data.location || 'TBA';
                            
                            html += `
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${isUpcoming ? 'border-green-500' : 'border-gray-400'}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">${data.title || 'Meeting'}</h4>
                                            <p class="text-sm text-gray-600">${data.description || 'No description available'}</p>
                                            <div class="mt-2 space-y-1">
                                                <p class="text-xs text-gray-500"><i class="fas fa-calendar mr-1"></i>${dateStr}</p>
                                                <p class="text-xs text-gray-500"><i class="fas fa-clock mr-1"></i>${timeStr}</p>
                                                <p class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${locationStr}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-2 py-1 text-xs rounded-full ${isUpcoming ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'}">${isUpcoming ? 'Upcoming' : 'Past'}</span>
                                            <p class="text-xs text-gray-500 mt-1">${data.type || 'Regular'}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        
                        // Add summary
                        html = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-semibold">Upcoming Meetings</h3>
                                            <p class="text-2xl font-bold">${upcomingCount}</p>
                                        </div>
                                        <i class="fas fa-calendar-check text-3xl opacity-80"></i>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-r from-gray-500 to-gray-600 text-white p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-lg font-semibold">Past Meetings</h3>
                                            <p class="text-2xl font-bold">${pastCount}</p>
                                        </div>
                                        <i class="fas fa-history text-3xl opacity-80"></i>
                                    </div>
                                </div>
                            </div>
                            ${html}
                        `;
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading meetings:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading meetings</p></div>';
                    });
            }
            
            function loadInvestmentsData() {
                if (!db) return;
                
                const container = document.getElementById('investments-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading investments...</div>';
                
                // Get all investments
                getDocs(query(collection(db, 'investments'), orderBy('createdAt', 'desc')))
                    .then(snapshot => {
                        if (snapshot.empty) {
                            container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-chart-line text-4xl mb-4 text-gray-300"></i><p>No investments available</p><p class="text-sm mt-2">Investment opportunities will appear here</p></div>';
                            return;
                        }
                        
                        let html = '<div class="space-y-4">';
                        let totalGoal = 0;
                        let totalPledged = 0;
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            totalGoal += data.amount || 0;
                            totalPledged += data.pledged || 0;
                            const progress = data.amount > 0 ? ((data.pledged || 0) / data.amount) * 100 : 0;
                            const createdDate = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
                            
                            html += `
                                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-500">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">${data.title || 'Investment Project'}</h4>
                                            <p class="text-sm text-gray-600">${data.description || 'No description available'}</p>
                                            <p class="text-xs text-gray-500 mt-1">Created: ${createdDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-2 py-1 text-xs rounded-full text-purple-600 bg-purple-100">${data.status || 'active'}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">Goal:</span>
                                            <span class="font-semibold">KSh ${(data.amount || 0).toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">Pledged:</span>
                                            <span class="font-semibold">KSh ${(data.pledged || 0).toLocaleString()}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-purple-500 h-2 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                                        </div>
                                        <div class="text-center text-xs text-gray-500">${progress.toFixed(1)}% funded</div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        
                        // Add summary
                        html = `
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg mb-6">
                                <h3 class="text-xl font-bold mb-4">Investment Overview</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="text-center">
                                        <p class="text-2xl font-bold">KSh ${totalGoal.toLocaleString()}</p>
                                        <p class="text-sm opacity-90">Total Goals</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-bold">KSh ${totalPledged.toLocaleString()}</p>
                                        <p class="text-sm opacity-90">Total Pledged</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-bold">${totalGoal > 0 ? ((totalPledged / totalGoal) * 100).toFixed(1) : 0}%</p>
                                        <p class="text-sm opacity-90">Overall Progress</p>
                                    </div>
                                </div>
                            </div>
                            ${html}
                        `;
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading investments:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading investments</p></div>';
                    });
            }
            
            function loadNotificationsData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('notifications-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading notifications...</div>';
                
                // For now, show a placeholder since we don't have a notifications collection
                // In a real app, you would query notifications for the current user
                setTimeout(() => {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-bell text-4xl mb-4 text-gray-300"></i>
                            <p>No notifications</p>
                            <p class="text-sm mt-2">You'll receive notifications about important updates here</p>
                        </div>
                    `;
                }, 1000);
            }
            
            function loadReportsData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('reports-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading reports...</div>';
                
                // Generate reports based on user data
                Promise.all([
                    getDocs(query(collection(db, 'contributions'), where('userId', '==', currentUserId))),
                    getDocs(query(collection(db, 'loans'), where('userId', '==', currentUserId)))
                ]).then(([contributionsSnap, loansSnap]) => {
                    const html = `
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-maroon to-maroon-light text-white p-6 rounded-lg">
                                <h3 class="text-xl font-bold mb-4">Available Reports</h3>
                                <p class="opacity-90">Generate detailed reports for your financial activities</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Contribution Report</h4>
                                    <p class="text-sm text-gray-600 mb-4">Detailed analysis of your contribution history</p>
                                    <div class="space-y-2 mb-4">
                                        <div class="flex justify-between text-sm">
                                            <span>Total Contributions:</span>
                                            <span class="font-semibold">${contributionsSnap.size}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span>Total Amount:</span>
                                            <span class="font-semibold">KSh ${contributionsSnap.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0).toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <button class="btn-primary w-full" onclick="generateReport('contributions')">
                                        <i class="fas fa-download mr-2"></i>Generate Report
                                    </button>
                                </div>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Loan Report</h4>
                                    <p class="text-sm text-gray-600 mb-4">Comprehensive loan history and analysis</p>
                                    <div class="space-y-2 mb-4">
                                        <div class="flex justify-between text-sm">
                                            <span>Total Loans:</span>
                                            <span class="font-semibold">${loansSnap.size}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span>Total Amount:</span>
                                            <span class="font-semibold">KSh ${loansSnap.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0).toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <button class="btn-primary w-full" onclick="generateReport('loans')">
                                        <i class="fas fa-download mr-2"></i>Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML = html;
                }).catch(error => {
                    console.error('Error loading reports:', error);
                    container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading reports</p></div>';
                });
            }
            
            function loadProfileData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('profile-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading profile...</div>';
                
                // Get user profile data
                getDoc(doc(db, 'user_profile', currentUserId))
                    .then(docSnap => {
                        if (!docSnap.exists()) {
                            container.innerHTML = '<div class="text-center text-gray-500 py-4"><p>Profile not found</p></div>';
                            return;
                        }
                        
                        const data = docSnap.data();
                        const html = `
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-maroon to-maroon-light text-white p-6 rounded-lg">
                                    <h3 class="text-xl font-bold mb-4">Profile Information</h3>
                                    <p class="opacity-90">Manage your personal information and preferences</p>
                                </div>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Personal Details</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                            <p class="text-gray-900">${data.name || 'Not provided'}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                            <p class="text-gray-900">${data.email || 'Not provided'}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <p class="text-gray-900">${data.phone || 'Not provided'}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">National ID</label>
                                            <p class="text-gray-900">${data.nationalId || 'Not provided'}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                            <span class="px-2 py-1 text-xs rounded-full ${data.status === 'approved' ? 'text-green-600 bg-green-100' : 'text-yellow-600 bg-yellow-100'}">${data.status || 'pending'}</span>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Member Since</label>
                                            <p class="text-gray-900">${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Profile Actions</h4>
                                    <div class="flex flex-wrap gap-4">
                                        <button class="btn-primary" onclick="openDashboardModal('update-profile')">
                                            <i class="fas fa-edit mr-2"></i>Update Profile
                                        </button>
                                        <button class="btn-primary" onclick="changePassword()">
                                            <i class="fas fa-key mr-2"></i>Change Password
                                        </button>
                                        <button class="btn-primary" onclick="downloadProfile()">
                                            <i class="fas fa-download mr-2"></i>Download Profile
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading profile:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading profile</p></div>';
                    });
            }
            
            function loadSettingsData() {
                if (!currentUserId || !db) return;
                
                const container = document.getElementById('settings-content');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading settings...</div>';
                
                // Get user settings
                getDoc(doc(db, 'user_profile', currentUserId))
                    .then(docSnap => {
                        const data = docSnap.exists() ? docSnap.data() : {};
                        
                        const html = `
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-maroon to-maroon-light text-white p-6 rounded-lg">
                                    <h3 class="text-xl font-bold mb-4">Account Settings</h3>
                                    <p class="opacity-90">Customize your account preferences and notifications</p>
                                </div>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Notification Preferences</h4>
                                    <div class="space-y-4">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <label class="text-sm font-medium text-gray-700">Email Notifications</label>
                                                <p class="text-xs text-gray-500">Receive updates via email</p>
                                            </div>
                                            <select class="px-3 py-1 border border-gray-300 rounded-md text-sm" id="email-notifications">
                                                <option value="enabled" ${data.emailNotifications !== false ? 'selected' : ''}>Enabled</option>
                                                <option value="disabled" ${data.emailNotifications === false ? 'selected' : ''}>Disabled</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <label class="text-sm font-medium text-gray-700">SMS Notifications</label>
                                                <p class="text-xs text-gray-500">Receive updates via SMS</p>
                                            </div>
                                            <select class="px-3 py-1 border border-gray-300 rounded-md text-sm" id="sms-notifications">
                                                <option value="disabled" ${data.smsNotifications !== true ? 'selected' : ''}>Disabled</option>
                                                <option value="enabled" ${data.smsNotifications === true ? 'selected' : ''}>Enabled</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <label class="text-sm font-medium text-gray-700">Profile Visibility</label>
                                                <p class="text-xs text-gray-500">Control who can see your profile</p>
                                            </div>
                                            <select class="px-3 py-1 border border-gray-300 rounded-md text-sm" id="profile-visibility">
                                                <option value="public" ${data.profileVisibility !== 'private' ? 'selected' : ''}>Public</option>
                                                <option value="private" ${data.profileVisibility === 'private' ? 'selected' : ''}>Private</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6">
                                        <button class="btn-primary" onclick="saveUserSettings()">
                                            <i class="fas fa-save mr-2"></i>Save Settings
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm">
                                    <h4 class="font-semibold text-gray-800 mb-4">Account Actions</h4>
                                    <div class="flex flex-wrap gap-4">
                                        <button class="btn-primary" onclick="exportData()">
                                            <i class="fas fa-download mr-2"></i>Export Data
                                        </button>
                                        <button class="btn-primary" onclick="deleteAccount()">
                                            <i class="fas fa-trash mr-2"></i>Delete Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        container.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading settings:', error);
                        container.innerHTML = '<div class="text-center text-red-500 py-4"><p>Error loading settings</p></div>';
                    });
            }

            // Mobile Menu Toggle Function
            function toggleMobileMenu() {
                const mobileMenu = document.getElementById('mobile-menu');
                const hamburgerButton = document.getElementById('hamburger-menu');
                
                if (mobileMenu && hamburgerButton) {
                    if (mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.remove('hidden');
                        hamburgerButton.innerHTML = '<i class="fas fa-times text-2xl"></i>';
                    } else {
                        mobileMenu.classList.add('hidden');
                        hamburgerButton.innerHTML = '<i class="fas fa-bars text-2xl"></i>';
                    }
                }
            }

            // Initialize mobile menu event listener
            document.addEventListener('DOMContentLoaded', function() {
                const hamburgerButton = document.getElementById('hamburger-menu');
                if (hamburgerButton) {
                    hamburgerButton.addEventListener('click', toggleMobileMenu);
                }
            });

            // Make modal functions global
            window.openServiceModal = openServiceModal;
            window.openDashboardModal = openDashboardModal;
            window.closeServiceModal = closeServiceModal;
            window.testModal = testModal;
            window.showDashboardContent = showDashboardContent;
            window.toggleMobileMenu = toggleMobileMenu;

            // Make new functions global
            window.generateUserReport = generateUserReport;
            window.downloadUserReport = downloadUserReport;
            window.saveUserSettings = saveUserSettings;

        }); // End of DOMContentLoaded listener
    </script>
</body>
</html>
